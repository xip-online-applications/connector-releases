{
  "version": 3,
  "sources": ["../../../../../../../../libs/connector-runner-sql-source/src/lib/datasource-extractor/datasource-extractor.service.ts"],
  "sourcesContent": ["import { DatasourceService, QueryResult } from '@xip-online-data/datasource';\nimport Handlebars from 'handlebars';\nimport { Observable, Subscription, timer } from 'rxjs';\nimport { handleError } from '@xip-online-data/handle-error';\nimport {\n  OffsetStore,\n  PersistentOffsetStoreInterface,\n} from '@transai/connector-runtime';\nimport { BaseConnectorConfig } from '@xip-online-data/types';\nimport { Logger } from '@transai/logger';\nimport { QueryResultHandler } from '../query-result.handler';\nimport { SourceConfig, SqlSourceRunnerConfig } from '../types';\n\nexport class DatasourceExtractorService {\n  #datasourceInstance: DatasourceService | undefined;\n\n  get #datasource(): DatasourceService {\n    if (!this.#datasourceInstance) {\n      throw new Error('Datasource service is not initialized');\n    }\n    return this.#datasourceInstance;\n  }\n\n  #initialized = false;\n\n  #processing = false;\n\n  #handlebarsTemplate: HandlebarsTemplateDelegate;\n\n  #config: SqlSourceRunnerConfig & BaseConnectorConfig;\n\n  #queryConfig: SourceConfig;\n\n  #offsetStore: PersistentOffsetStoreInterface;\n\n  #queryResultHandler: QueryResultHandler;\n\n  #ipcBus: Observable<Array<string>>;\n\n  #subscription?: Subscription;\n\n  constructor(\n    config: SqlSourceRunnerConfig & BaseConnectorConfig,\n    queryConfig: SourceConfig,\n    offsetStore: PersistentOffsetStoreInterface,\n    queryResultHandler: QueryResultHandler,\n    ipcBus: Observable<Array<string>>,\n  ) {\n    this.#config = config;\n    this.#queryConfig = queryConfig;\n    this.#offsetStore = offsetStore;\n    this.#queryResultHandler = queryResultHandler;\n    this.#ipcBus = ipcBus;\n\n    Logger.getInstance().debug(\n      `Creating data sink service: ${queryConfig.queryIdentifier}`,\n    );\n    this.#handlebarsTemplate = Handlebars.compile(queryConfig.query, {\n      strict: true,\n    });\n    this.#validateTemplate();\n    Logger.getInstance().debug(\n      `Sink Service build. Go init now: ${queryConfig.queryIdentifier}`,\n    );\n  }\n\n  public async init(): Promise<void> {\n    Logger.getInstance().debug(\n      `Initializing data sink service: ${this.#queryConfig.queryIdentifier}`,\n    );\n    this.#datasourceInstance = new DatasourceService(this.#config.database);\n    Logger.getInstance().debug(\n      `Connected!: ${this.#queryConfig.queryIdentifier}`,\n    );\n\n    await this.#datasourceInstance.initialize().catch((error) => {\n      Logger.getInstance().error(\n        `Error while initializing data sink service, ${JSON.stringify(error)}`,\n      );\n      throw new Error(\n        `Error while initializing data sink service, ${JSON.stringify(error)}`,\n      );\n    });\n\n    if (\n      this.#queryConfig.runAfterEvents !== undefined &&\n      this.#queryConfig.runAfterEvents.length !== 0\n    ) {\n      Logger.getInstance().debug(\n        'Run after DBusMessage: ',\n        this.#queryConfig.runAfterEvents,\n      );\n      this.#ipcBus.subscribe((values) => {\n        if (this.#config.debug)\n          Logger.getInstance().debug(\n            '[SQL source] received values: ',\n            values,\n            this.#queryConfig.queryName,\n            this.#queryConfig.runAfterEvents,\n          );\n        if (values.some((v) => this.#queryConfig.runAfterEvents!.includes(v))) {\n          Logger.getInstance().debug(\n            `${this.#queryConfig.queryIdentifier} Execute based on finished events: Finished Events ${values}, Run after ${this.#queryConfig.runAfterEvents}`,\n          );\n          this.extract(true);\n        }\n      });\n    }\n\n    Logger.getInstance().debug(\n      `Data sink service initialized: ${this.#queryConfig.queryIdentifier}`,\n    );\n    this.#initialized = true;\n    this.setInterval();\n  }\n\n  stop() {\n    this.#subscription?.unsubscribe();\n  }\n\n  private setInterval(): void {\n    this.#subscription = timer(0, this.#queryConfig.interval * 1000).subscribe(\n      async () => {\n        await this.extract();\n      },\n    );\n  }\n\n  private async extract(priority = false): Promise<void> {\n    if (!this.#initialized) {\n      return;\n    }\n\n    if (this.#processing) {\n      Logger.getInstance().debug(\n        `Data sink service is already processing: ${this.#queryConfig.queryIdentifier}`,\n      );\n      return;\n    }\n\n    Logger.getInstance().debug(\n      `Start query: ${this.#queryConfig.queryIdentifier}`,\n    );\n\n    this.#processing = true;\n    try {\n      await this.#executeQuery(priority, 0).catch((error) => {\n        Logger.getInstance().error(\n          `Error while extracting data from data sink service ${error.message}`,\n        );\n        throw new Error(\n          `Error while extracting data from data sink service ${error.message}`,\n        );\n      });\n    } catch (error) {\n      if (error instanceof Error) {\n        Logger.getInstance().error(\n          `Error while extracting data from data sink service ${error.message}`,\n        );\n      }\n      handleError('Error while querying datasource', error);\n    } finally {\n      this.#processing = false;\n    }\n  }\n\n  async #executeQuery(priority: boolean, runCount: number): Promise<void> {\n    const latestOffset = await this.#offsetStore.getOffset(\n      this.#queryConfig.queryIdentifier,\n    );\n    const query = this.#getQuery(latestOffset, this.#queryConfig.batchSize);\n\n    const result = await this.#datasource.query(query);\n\n    if (result === null) {\n      Logger.getInstance().debug(\n        `Error while querying datasource ${this.#queryConfig.queryIdentifier}`,\n      );\n      return;\n    }\n\n    if ('error' in result && result.error) {\n      Logger.getInstance().error(\n        `Error while querying datasource ${this.#queryConfig.queryIdentifier} ${query} ${JSON.stringify(result)}`,\n      );\n      return;\n    }\n\n    const queryResult = result as QueryResult;\n\n    const success = await this.#queryResultHandler.handleResult(\n      queryResult,\n      this.#queryConfig,\n      latestOffset,\n      priority,\n    );\n\n    const rateLimiter = this.#queryConfig.rateLimiter ?? 10;\n    if (\n      queryResult.affected === this.#queryConfig.batchSize &&\n      success &&\n      runCount < rateLimiter\n    ) {\n      const newRunCount = runCount + 1;\n      await this.#executeQuery(priority, newRunCount);\n    }\n\n    if (runCount >= 10) {\n      Logger.getInstance().warn(\n        `${this.#queryConfig.queryIdentifier} Limiting query since it exceeded ${rateLimiter.toString()} runs`,\n      );\n    }\n  }\n\n  #validateTemplate(): void {\n    this.#getQuery({ timestamp: 0, id: 0, rawTimestamp: 0 }, 0);\n  }\n\n  #getQuery(offset: OffsetStore, limit: number): string {\n    const payload = {\n      ...offset,\n      limit,\n    };\n    return this.#handlebarsTemplate(payload);\n  }\n}\n"],
  "mappings": "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",
  "names": ["Handlebars"]
}
