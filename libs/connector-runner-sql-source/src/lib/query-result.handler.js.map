{
  "version": 3,
  "sources": ["../../../../../../../libs/connector-runner-sql-source/src/lib/query-result.handler.ts"],
  "sourcesContent": ["import { QueryResult } from '@xip-online-data/datasource';\nimport { BaseConnectorConfig } from '@xip-online-data/types';\nimport {\n  OffsetStore,\n  PersistentOffsetStoreInterface,\n} from '@transai/connector-runtime';\nimport { Logger } from '@transai/logger';\nimport { KafkaService } from './kafka/kafka.service';\nimport { SourceConfig, SqlSourceRunnerConfig } from './types';\n\nexport class QueryResultHandler {\n  readonly #config: SqlSourceRunnerConfig & BaseConnectorConfig;\n\n  readonly #kafkaService: KafkaService;\n\n  readonly #offsetStore: PersistentOffsetStoreInterface;\n\n  constructor(\n    config: SqlSourceRunnerConfig & BaseConnectorConfig,\n    kafkaService: KafkaService,\n    offsetStore: PersistentOffsetStoreInterface,\n  ) {\n    this.#config = config;\n    this.#kafkaService = kafkaService;\n    this.#offsetStore = offsetStore;\n  }\n\n  public async handleResult(\n    result: QueryResult,\n    queryConfig: SourceConfig,\n    previousOffset?: OffsetStore,\n    priority = false,\n  ): Promise<boolean> {\n    Logger.getInstance().debug(\n      `${queryConfig.queryIdentifier} runned successfully. Gotten ${result.records.length} records`,\n    );\n    if (result.records.length === 0) {\n      return true;\n    }\n\n    const newestTimeStamp = this.getTimestamp(\n      result.records[result.records.length - 1],\n      queryConfig,\n    );\n\n    const preparedRecords = result.records.map((r) => {\n      const newField = {\n        ...r,\n      };\n\n      if (queryConfig.ignoreFields) {\n        for (const field of queryConfig.ignoreFields) {\n          delete newField[field];\n        }\n      }\n      return newField;\n    });\n\n    if (\n      queryConfig.incrementalField !== '' &&\n      newestTimeStamp.id === previousOffset?.id &&\n      newestTimeStamp.timestamp === previousOffset?.timestamp &&\n      result.affected !== 0\n    ) {\n      Logger.getInstance().error(\n        `${queryConfig.queryIdentifier} runned successfully. But offset is not changed ${JSON.stringify(newestTimeStamp)}`,\n      );\n      return false;\n    }\n\n    try {\n      Logger.getInstance().debug(\n        `${queryConfig.queryIdentifier} Sending ${result.affected} records to Kafka using batch`,\n      );\n      const success = await this.#kafkaService.sendBatch(\n        preparedRecords,\n        this.#config,\n        queryConfig,\n        priority,\n      );\n      if (success) {\n        this.storeTimestamp(newestTimeStamp, queryConfig);\n      }\n      return success;\n    } catch (e) {\n      Logger.getInstance().debug(\n        `${queryConfig.queryIdentifier} Sending ${result.affected} records going wrong.`,\n      );\n      return false;\n    }\n  }\n\n  storeTimestamp: (timestamp: OffsetStore, queryConfig: SourceConfig) => void =\n    (timestamp: OffsetStore, queryConfig: SourceConfig) => {\n      const date = new Date(timestamp.timestamp).toISOString();\n      this.#offsetStore.setOffset(\n        {\n          timestamp: timestamp.timestamp,\n          id: timestamp.id,\n          date,\n          rawTimestamp: timestamp.rawTimestamp,\n        },\n        queryConfig.queryIdentifier,\n      );\n    };\n\n  getTimestamp = (record: any, queryConfig: SourceConfig): OffsetStore => {\n    let timestamp = 0;\n    let isoDate = '';\n    let rawTimestamp: string | number | undefined;\n\n    const recordTimestamp = this.getOptionalRecordField(\n      record,\n      queryConfig.incrementalField,\n    );\n\n    if (recordTimestamp) {\n      const dateObject = new Date(recordTimestamp);\n      timestamp = dateObject.getTime();\n      isoDate = dateObject.toISOString();\n    }\n\n    if (\n      typeof recordTimestamp === 'string' ||\n      typeof recordTimestamp === 'number'\n    ) {\n      rawTimestamp = recordTimestamp;\n    } else {\n      Logger.getInstance().warn(\n        `${queryConfig.queryIdentifier} rawTimestamp is invalid. Not a string or number.`,\n      );\n    }\n\n    const id = this.getOptionalRecordField(record, queryConfig.keyField) ?? 0;\n\n    return { id, timestamp, rawTimestamp, isoDate };\n  };\n\n  getOptionalRecordField = (record: any, fieldName: string) => {\n    return Object.keys(record).indexOf(fieldName) > -1\n      ? record[fieldName]\n      : null;\n  };\n}\n"],
  "mappings": "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",
  "names": []
}
