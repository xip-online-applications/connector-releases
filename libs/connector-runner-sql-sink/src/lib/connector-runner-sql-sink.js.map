{
  "version": 3,
  "sources": ["../../../../../../../libs/connector-runner-sql-sink/src/lib/connector-runner-sql-sink.ts"],
  "sourcesContent": ["import { ConnectorRuntime } from '@transai/connector-runtime';\nimport {\n  ActionInterface,\n  BaseConnectorConfig,\n  ConnectorInterface,\n  KafkaCallbackResponse,\n  XodActionType,\n  XodBaseMessageType,\n  XodJobType,\n} from '@xip-online-data/types';\nimport {\n  BadRequest,\n  Created,\n  InternalServerError,\n} from '@xip-online-data/kafka-base-service';\nimport { DatasourceService } from '@xip-online-data/datasource';\nimport { handleError } from '@xip-online-data/handle-error';\nimport { Logger } from '@transai/logger';\nimport { SqlSinkConfig } from './types';\n\nfunction trimTrailingSemicolon(input: string): string {\n  return input.endsWith(';') ? input.slice(0, -1) : input;\n}\n\nexport class ConnectorRunnerSqlSink extends ConnectorRuntime<SqlSinkConfig> {\n  readonly CONNECTOR_INSTANCE: string = 'XOD_CONNECTOR_SQL_SINK_CONFIG';\n\n  private dataSinkInstance: DatasourceService | undefined;\n\n  private get dataSinkService(): DatasourceService {\n    if (this.dataSinkInstance === undefined) {\n      throw new Error('Samba client not initialized');\n    }\n    return this.dataSinkInstance;\n  }\n\n  constructor(\n    connector: ConnectorInterface,\n    connectorConfig: SqlSinkConfig & BaseConnectorConfig,\n    actionConfigs: Array<ActionInterface>,\n    readonly injectedDataSinkInstance?: DatasourceService,\n  ) {\n    super(connector, connectorConfig, actionConfigs);\n    this.dataSinkInstance = injectedDataSinkInstance;\n  }\n\n  override init = async (): Promise<void> => {\n    if (this.dataSinkInstance === undefined) {\n      this.dataSinkInstance = new DatasourceService(this.config.database);\n    }\n\n    await this.dataSinkService.initialize().catch((error) => {\n      handleError('Error while initializing data sink service', error);\n    });\n\n    const mainJobProcessFunction: (\n      callbackFunction: (\n        message: XodBaseMessageType,\n      ) => Promise<KafkaCallbackResponse>,\n    ) => (message: XodBaseMessageType) => Promise<KafkaCallbackResponse> = (\n      callbackFunction: (\n        message: XodBaseMessageType,\n      ) => Promise<KafkaCallbackResponse>,\n    ) => {\n      return async (m: XodBaseMessageType) => {\n        if (m.type !== 'JOB') {\n          return callbackFunction(m);\n        }\n        try {\n          const message = m as XodJobType;\n          const actionConfig = this.getActionConfig(message);\n          if (!actionConfig) {\n            return BadRequest('Action config not found')(message);\n          }\n          const config = actionConfig.config as { query: string };\n          const inputParams = actionConfig.inputParameters.map(\n            (input) => input.name,\n          ) as Array<string>;\n          const query = message.testRun\n            ? `START TRANSACTION; ${trimTrailingSemicolon(config.query)}; ROLLBACK;`\n            : `${trimTrailingSemicolon(config.query)};`;\n\n          // const query = `${trimTrailingSemicolon(config.query)};`\n\n          const params = inputParams.map((param) => message.payload[param]);\n\n          if (message.testRun) {\n            this.log.info(\n              `Handle message ${message.eventId} with query ${query} and params ${params}`,\n            );\n          } else {\n            this.log.debug(\n              `Handle message ${message.eventId} with query ${query} and params ${params}`,\n            );\n          }\n\n          try {\n            this.log.debug(`executing query, ${query}`);\n            const result = await this.dataSinkService.query(query, params);\n\n            if (result === null) {\n              this.log.error(`Query failed, no result`);\n              return InternalServerError('Query failed, no result')(message);\n            }\n\n            if (\n              typeof result === 'object' &&\n              'error' in result &&\n              result.error\n            ) {\n              this.log.error(`Query failed with error: ${result.error}`);\n              return InternalServerError(\n                typeof result === 'object' && 'error' in result && result.error\n                  ? result.error\n                  : 'Unknown error',\n              )(message);\n            }\n\n            this.log.debug('query done');\n\n            if (result) {\n              return callbackFunction(message);\n            }\n            return InternalServerError('Query failed, no result')(message);\n          } catch (error) {\n            if (error instanceof Error) {\n              return InternalServerError(JSON.stringify(error))(message);\n            }\n\n            return InternalServerError('Query failed, no result')(message);\n          }\n        } catch (error) {\n          if (error instanceof Error) {\n            return InternalServerError(JSON.stringify(error))(m);\n          }\n\n          return InternalServerError(\n            'Process to build query failed, Unknown error',\n          )(m);\n        }\n      };\n    };\n\n    const mainActionProcessFunction: (\n      callbackFunction: (\n        message: XodBaseMessageType,\n      ) => Promise<KafkaCallbackResponse>,\n    ) => (message: XodBaseMessageType) => Promise<KafkaCallbackResponse> = (\n      callbackFunction: (\n        message: XodBaseMessageType,\n      ) => Promise<KafkaCallbackResponse>,\n    ) => {\n      return async (m: XodBaseMessageType) => {\n        if (m.type !== 'ACTION') {\n          return callbackFunction(m);\n        }\n\n        const message = m as XodActionType;\n        if (!message.payload.content) {\n          return BadRequest('Query not found')(message);\n        }\n\n        const cleanedQuery = message.payload.content\n          .replace(/\\s+/g, ' ')\n          .trim();\n        Logger.getInstance().debug(\n          `Handle message ${message.eventId} with query ${cleanedQuery}`,\n        );\n        try {\n          const result = await this.dataSinkService.query(cleanedQuery);\n\n          if (result === null) {\n            this.log.error(`Query failed, no result`);\n            return InternalServerError('Query failed, no result')(message);\n          }\n\n          if (typeof result === 'object' && 'error' in result && result.error) {\n            this.log.error(`Query failed with error: ${result.error}`);\n            return InternalServerError(\n              typeof result === 'object' && 'error' in result && result.error\n                ? result.error\n                : 'Unknown error',\n            )(message);\n          }\n\n          this.log.debug('query done');\n\n          if (result) {\n            return callbackFunction(message);\n          }\n          return InternalServerError('Query failed, no result')(message);\n        } catch (error) {\n          if (error instanceof Error) {\n            return InternalServerError(JSON.stringify(error))(m);\n          }\n\n          return InternalServerError(\n            'Process to build query failed, Unknown error',\n          )(m);\n        }\n      };\n    };\n\n    this.callbackFunction = mainActionProcessFunction(\n      mainJobProcessFunction(this.emitEventType(Created())),\n    );\n  };\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,+BAAiC;AAUjC,gCAIO;AACP,wBAAkC;AAClC,0BAA4B;AAC5B,oBAAuB;AAGvB,SAAS,sBAAsB,OAAuB;AACpD,SAAO,MAAM,SAAS,GAAG,IAAI,MAAM,MAAM,GAAG,EAAE,IAAI;AACpD;AAEO,MAAM,+BAA+B,0CAAgC;AAAA,EAY1E,YACE,WACA,iBACA,eACS,0BACT;AACA,UAAM,WAAW,iBAAiB,aAAa;AAFtC;AAfX,SAAS,qBAA6B;AAqBtC,SAAS,OAAO,YAA2B;AACzC,UAAI,KAAK,qBAAqB,QAAW;AACvC,aAAK,mBAAmB,IAAI,oCAAkB,KAAK,OAAO,QAAQ;AAAA,MACpE;AAEA,YAAM,KAAK,gBAAgB,WAAW,EAAE,MAAM,CAAC,UAAU;AACvD,6CAAY,8CAA8C,KAAK;AAAA,MACjE,CAAC;AAED,YAAM,yBAIiE,CACrE,qBAGG;AACH,eAAO,OAAO,MAA0B;AACtC,cAAI,EAAE,SAAS,OAAO;AACpB,mBAAO,iBAAiB,CAAC;AAAA,UAC3B;AACA,cAAI;AACF,kBAAM,UAAU;AAChB,kBAAM,eAAe,KAAK,gBAAgB,OAAO;AACjD,gBAAI,CAAC,cAAc;AACjB,yBAAO,sCAAW,yBAAyB,EAAE,OAAO;AAAA,YACtD;AACA,kBAAM,SAAS,aAAa;AAC5B,kBAAM,cAAc,aAAa,gBAAgB;AAAA,cAC/C,CAAC,UAAU,MAAM;AAAA,YACnB;AACA,kBAAM,QAAQ,QAAQ,UAClB,sBAAsB,sBAAsB,OAAO,KAAK,CAAC,gBACzD,GAAG,sBAAsB,OAAO,KAAK,CAAC;AAI1C,kBAAM,SAAS,YAAY,IAAI,CAAC,UAAU,QAAQ,QAAQ,KAAK,CAAC;AAEhE,gBAAI,QAAQ,SAAS;AACnB,mBAAK,IAAI;AAAA,gBACP,kBAAkB,QAAQ,OAAO,eAAe,KAAK,eAAe,MAAM;AAAA,cAC5E;AAAA,YACF,OAAO;AACL,mBAAK,IAAI;AAAA,gBACP,kBAAkB,QAAQ,OAAO,eAAe,KAAK,eAAe,MAAM;AAAA,cAC5E;AAAA,YACF;AAEA,gBAAI;AACF,mBAAK,IAAI,MAAM,oBAAoB,KAAK,EAAE;AAC1C,oBAAM,SAAS,MAAM,KAAK,gBAAgB,MAAM,OAAO,MAAM;AAE7D,kBAAI,WAAW,MAAM;AACnB,qBAAK,IAAI,MAAM,yBAAyB;AACxC,2BAAO,+CAAoB,yBAAyB,EAAE,OAAO;AAAA,cAC/D;AAEA,kBACE,OAAO,WAAW,YAClB,WAAW,UACX,OAAO,OACP;AACA,qBAAK,IAAI,MAAM,4BAA4B,OAAO,KAAK,EAAE;AACzD,2BAAO;AAAA,kBACL,OAAO,WAAW,YAAY,WAAW,UAAU,OAAO,QACtD,OAAO,QACP;AAAA,gBACN,EAAE,OAAO;AAAA,cACX;AAEA,mBAAK,IAAI,MAAM,YAAY;AAE3B,kBAAI,QAAQ;AACV,uBAAO,iBAAiB,OAAO;AAAA,cACjC;AACA,yBAAO,+CAAoB,yBAAyB,EAAE,OAAO;AAAA,YAC/D,SAAS,OAAO;AACd,kBAAI,iBAAiB,OAAO;AAC1B,2BAAO,+CAAoB,KAAK,UAAU,KAAK,CAAC,EAAE,OAAO;AAAA,cAC3D;AAEA,yBAAO,+CAAoB,yBAAyB,EAAE,OAAO;AAAA,YAC/D;AAAA,UACF,SAAS,OAAO;AACd,gBAAI,iBAAiB,OAAO;AAC1B,yBAAO,+CAAoB,KAAK,UAAU,KAAK,CAAC,EAAE,CAAC;AAAA,YACrD;AAEA,uBAAO;AAAA,cACL;AAAA,YACF,EAAE,CAAC;AAAA,UACL;AAAA,QACF;AAAA,MACF;AAEA,YAAM,4BAIiE,CACrE,qBAGG;AACH,eAAO,OAAO,MAA0B;AACtC,cAAI,EAAE,SAAS,UAAU;AACvB,mBAAO,iBAAiB,CAAC;AAAA,UAC3B;AAEA,gBAAM,UAAU;AAChB,cAAI,CAAC,QAAQ,QAAQ,SAAS;AAC5B,uBAAO,sCAAW,iBAAiB,EAAE,OAAO;AAAA,UAC9C;AAEA,gBAAM,eAAe,QAAQ,QAAQ,QAClC,QAAQ,QAAQ,GAAG,EACnB,KAAK;AACR,+BAAO,YAAY,EAAE;AAAA,YACnB,kBAAkB,QAAQ,OAAO,eAAe,YAAY;AAAA,UAC9D;AACA,cAAI;AACF,kBAAM,SAAS,MAAM,KAAK,gBAAgB,MAAM,YAAY;AAE5D,gBAAI,WAAW,MAAM;AACnB,mBAAK,IAAI,MAAM,yBAAyB;AACxC,yBAAO,+CAAoB,yBAAyB,EAAE,OAAO;AAAA,YAC/D;AAEA,gBAAI,OAAO,WAAW,YAAY,WAAW,UAAU,OAAO,OAAO;AACnE,mBAAK,IAAI,MAAM,4BAA4B,OAAO,KAAK,EAAE;AACzD,yBAAO;AAAA,gBACL,OAAO,WAAW,YAAY,WAAW,UAAU,OAAO,QACtD,OAAO,QACP;AAAA,cACN,EAAE,OAAO;AAAA,YACX;AAEA,iBAAK,IAAI,MAAM,YAAY;AAE3B,gBAAI,QAAQ;AACV,qBAAO,iBAAiB,OAAO;AAAA,YACjC;AACA,uBAAO,+CAAoB,yBAAyB,EAAE,OAAO;AAAA,UAC/D,SAAS,OAAO;AACd,gBAAI,iBAAiB,OAAO;AAC1B,yBAAO,+CAAoB,KAAK,UAAU,KAAK,CAAC,EAAE,CAAC;AAAA,YACrD;AAEA,uBAAO;AAAA,cACL;AAAA,YACF,EAAE,CAAC;AAAA,UACL;AAAA,QACF;AAAA,MACF;AAEA,WAAK,mBAAmB;AAAA,QACtB,uBAAuB,KAAK,kBAAc,mCAAQ,CAAC,CAAC;AAAA,MACtD;AAAA,IACF;AAnKE,SAAK,mBAAmB;AAAA,EAC1B;AAAA,EAfA,IAAY,kBAAqC;AAC/C,QAAI,KAAK,qBAAqB,QAAW;AACvC,YAAM,IAAI,MAAM,8BAA8B;AAAA,IAChD;AACA,WAAO,KAAK;AAAA,EACd;AA6KF;",
  "names": []
}
