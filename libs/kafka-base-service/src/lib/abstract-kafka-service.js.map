{
  "version": 3,
  "sources": ["../../../../../../../libs/kafka-base-service/src/lib/abstract-kafka-service.ts"],
  "sourcesContent": ["import {\n  AwsKafkaSaslConfig,\n  BaseConnectorConfig,\n  isTopicRegex,\n  TopicRegex,\n} from '@xip-online-data/types';\nimport { v4 as uuidv4 } from 'uuid';\nimport { Consumer, Kafka, logLevel, Producer } from 'kafkajs';\nimport { interval } from 'rxjs';\nimport {\n  awsIamAuthenticator,\n  Type,\n} from '@jm18457/kafkajs-msk-iam-authentication-mechanism';\nimport { captureException } from '@sentry/node';\nimport { Tracer } from '@xip-online-data/tracer';\nimport { Logger } from '@transai/logger';\nimport { MessageMonitorInterface } from './message-monitor.interface';\nimport { InMemoryMessageMonitor } from './in-memory.message-monitor';\nimport { RedisMessageMonitor } from './redis.message-monitor';\nimport { TransAILogCreator } from './kafkajs-logger';\n\nexport abstract class AbstractKafkaService {\n  protected readonly errorTypes = ['unhandledRejection', 'uncaughtException'];\n\n  protected readonly signalTraps = ['SIGTERM', 'SIGINT', 'SIGUSR2'];\n\n  public static readonly DEFAULT_CALLBACK_EVENT_TYPE = '*';\n\n  protected readonly kafkaBase: Kafka;\n\n  protected readonly consumer: Consumer;\n\n  protected readonly producer: Producer;\n\n  protected readonly processedTopic: string = '_LOGS_xod';\n\n  protected readonly DEFAULT_INTERVAL_CHECK_FOR_NEW_TOPICS = 300;\n\n  protected readonly DEFAULT_HEARTBEAT_TIMEOUT = 300000; // 5 minutes\n\n  protected readonly DEFAULT_HEARTBEAT_CHECK = 10000;\n\n  protected numberOfSubscribedRegexTopics = 0;\n\n  protected lastHeartbeat = new Date();\n\n  protected readonly disableLogs: boolean;\n\n  protected messageMonitor: MessageMonitorInterface | undefined = undefined;\n\n  public abstract init(): Promise<void>;\n\n  public constructor(\n    protected readonly baseYamlConfig: BaseConnectorConfig,\n    protected readonly connectorTopic?: string | undefined,\n  ) {\n    Logger.getInstance().debug('Using KAFKAJS library');\n    const config = {\n      clientId: `${baseYamlConfig.kafka.clientId}-${uuidv4()}`,\n      brokers: baseYamlConfig.kafka.brokers,\n      ...this.getAuthProviderOptions(baseYamlConfig.kafka.sasl),\n      logLevel: logLevel.ERROR,\n      logCreator: TransAILogCreator,\n    };\n\n    this.messageMonitor = this.getCorrespondingMonitor();\n\n    this.disableLogs = baseYamlConfig.kafka.disableLogs ?? false;\n\n    this.kafkaBase = new Kafka(config);\n    this.consumer = this.kafkaBase.consumer({\n      groupId: baseYamlConfig.kafka.groupId,\n    });\n    this.producer = this.kafkaBase.producer();\n\n    if (\n      this.baseYamlConfig.kafka.consumerTopics === undefined ||\n      this.baseYamlConfig.kafka.consumerTopics.length === 0\n    ) {\n      Logger.getInstance().debug(\n        'No consumer topics set. skip setting of consumer events callback',\n      );\n      return;\n    }\n\n    this.consumer.on('consumer.heartbeat', () => {\n      this.lastHeartbeat = new Date();\n    });\n\n    this.consumer.on('consumer.crash', async ({ payload }) => {\n      Logger.getInstance().error(\n        `KafkaJS Consumer crashed. Error:`,\n        payload.error,\n      );\n      this.exitProcess('consumer.crash');\n    });\n\n    interval(this.DEFAULT_HEARTBEAT_CHECK).subscribe(() => {\n      this.checkHeartbeat();\n    });\n\n    this.getNumberOfRegexTopics().then((topics) => {\n      this.numberOfSubscribedRegexTopics = topics;\n    });\n\n    const intervalCheckForNewTopics =\n      this.baseYamlConfig.kafka.intervalCheckForNewTopics ??\n      this.DEFAULT_INTERVAL_CHECK_FOR_NEW_TOPICS;\n    if (intervalCheckForNewTopics > 0) {\n      interval(intervalCheckForNewTopics * 1000).subscribe(() => {\n        this.checkForNewTopics().then(this.restartIfNewTopics.bind(this));\n      });\n    }\n\n    if (process) {\n      Logger.getInstance().debug('Setting up gracefull shutdown for kafka...');\n\n      this.errorTypes.forEach((type) => {\n        process.on(type, async (e) => {\n          try {\n            Logger.getInstance().error(`process.on ${type}`);\n            Logger.getInstance().error(e);\n            await this.exitProcess(type);\n          } catch (_) {\n            process.exit(1);\n          }\n        });\n      });\n\n      this.signalTraps.forEach((type) => {\n        process.on(type, async () => {\n          Logger.getInstance().error(`process.once ${type}`);\n          try {\n            await this.exitProcess(type);\n          } finally {\n            process.exit(0);\n          }\n        });\n      });\n    } else {\n      Logger.getInstance().debug(\n        'No process found. Gracefull shutdown not possible',\n      );\n    }\n  }\n\n  private checkHeartbeat = (): void => {\n    if (\n      this.baseYamlConfig.kafka.consumerTopics === undefined ||\n      this.baseYamlConfig.kafka.consumerTopics.length === 0\n    ) {\n      // Should not happen since the consumer is not initialized if no topics are set\n      Logger.getInstance().debug(\n        'No consumer topics set. skip setting of consumer events callback',\n      );\n      return;\n    }\n    const now = new Date();\n    const diff = now.getTime() - this.lastHeartbeat.getTime();\n    if (diff > this.DEFAULT_HEARTBEAT_TIMEOUT) {\n      Logger.getInstance().error(\n        `No heartbeat received for ${diff}ms. Exit process`,\n      );\n      this.exitProcess('heartbeat-timeout');\n    }\n  };\n\n  public exitProcess = async (type: string): Promise<void> => {\n    const logger = Logger.getInstance();\n    logger.info(\n      `Got ${type}. Graceful shutdown Kafka start. Disconnecting consumer and producer`,\n      new Date().toISOString(),\n    );\n\n    try {\n      await this.consumer?.disconnect();\n      logger.info('Consumer disconnected');\n    } catch (error) {\n      logger.error('Error while disconnecting consumer', error);\n    }\n\n    try {\n      await this.producer?.disconnect();\n      logger.info('Producer disconnected');\n    } catch (error) {\n      logger.error('Error while disconnecting producer', error);\n    }\n\n    logger.info('Graceful shutdown Kafka complete', new Date().toISOString());\n    process.exit(0);\n  };\n\n  private getAuthProviderOptions(config: AwsKafkaSaslConfig | undefined) {\n    if (!config) {\n      return {};\n    }\n\n    const options = {\n      region: config.region ?? process.env['AWS_REGION'] ?? 'eu-west-1',\n      credentials: undefined as any,\n    };\n\n    if (config.accessKeyId && config.secretAccessKey) {\n      options.credentials = {\n        accessKeyId: config.accessKeyId,\n        secretAccessKey: config.secretAccessKey,\n      };\n    }\n\n    return {\n      ssl: true,\n      sasl: {\n        mechanism: Type,\n        authenticationProvider: awsIamAuthenticator(options),\n      },\n    };\n  }\n\n  private getCorrespondingMonitor(): MessageMonitorInterface | undefined {\n    if (this.baseYamlConfig.kafka.messageMonitor?.type === 'in-memory') {\n      if (this.baseYamlConfig.debug)\n        Logger.getInstance().debug('Using in-memory message monitor');\n      return new InMemoryMessageMonitor(\n        this.baseYamlConfig.kafka.messageMonitor,\n        this.baseYamlConfig,\n      );\n    }\n\n    if (this.baseYamlConfig.kafka.messageMonitor?.type === 'redis') {\n      if (this.baseYamlConfig.debug)\n        Logger.getInstance().debug('Using Redis message monitor');\n      return new RedisMessageMonitor(\n        this.baseYamlConfig.kafka.messageMonitor,\n        this.baseYamlConfig,\n      );\n    }\n\n    if (this.baseYamlConfig.kafka.messageMonitor?.type === 'disabled') {\n      if (this.baseYamlConfig.debug)\n        Logger.getInstance().debug('Message monitor disabled');\n      return undefined;\n    }\n\n    if (this.baseYamlConfig.debug)\n      Logger.getInstance().debug('No setting, Message monitor disabled');\n    return undefined;\n  }\n\n  private checkForNewTopics = async (): Promise<boolean> => {\n    const regexTopicsOnServer = await this.getNumberOfRegexTopics();\n    Tracer.init().get().gauge('kafka.topics', regexTopicsOnServer);\n    return regexTopicsOnServer !== this.numberOfSubscribedRegexTopics;\n  };\n\n  private getNumberOfRegexTopics = async (): Promise<number> => {\n    const regexTopics: Array<TopicRegex> = [];\n\n    for (const topic of this.baseYamlConfig.kafka.consumerTopics ?? []) {\n      if (isTopicRegex(topic)) {\n        regexTopics.push(topic);\n      }\n    }\n\n    if (regexTopics.length === 0) {\n      return 0;\n    }\n\n    const regexList = regexTopics.map(\n      (topic) => new RegExp(topic.pattern, topic.flags),\n    );\n\n    const admin = this.kafkaBase.admin();\n    await admin.connect();\n    const existingTopics = await admin.listTopics();\n    await admin.disconnect();\n\n    return existingTopics.filter((topic) =>\n      regexList.some((regex) => regex.test(topic)),\n    ).length;\n  };\n\n  private restartIfNewTopics = async (newTopics: boolean): Promise<void> => {\n    if (newTopics) {\n      try {\n        Logger.getInstance().debug('New topics found, restarting consumer');\n        await this.consumer.disconnect();\n        await this.init();\n      } catch (error) {\n        captureException(error);\n        process.exit(1);\n      }\n    }\n  };\n}\n"],
  "mappings": "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",
  "names": ["uuidv4"]
}
