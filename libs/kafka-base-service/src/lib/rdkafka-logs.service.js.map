{
  "version": 3,
  "sources": ["../../../../../../../libs/kafka-base-service/src/lib/rdkafka-logs.service.ts"],
  "sourcesContent": ["import { KafkaJS } from '@confluentinc/kafka-javascript';\nimport { Logger } from '@transai/logger';\nimport {\n  isXodResponseType,\n  XodBaseMessageType,\n  XodResponseType,\n} from '@xip-online-data/types';\nimport { ProducerRecord, RecordMetadata } from 'kafkajs';\n\nimport { AbstractRdKafkaService } from './abstract-rdkafka-service';\n\nexport class RdKafkaLogsService extends AbstractRdKafkaService {\n  readonly #responseCallbackWrappers: Array<\n    (message: XodResponseType) => Promise<void>\n  > = [];\n\n  protected initialized = false;\n\n  public setResponseCallbackFunction(\n    callbackFunction: (message: XodResponseType) => Promise<void>,\n  ): void {\n    this.#responseCallbackWrappers.push(callbackFunction);\n  }\n\n  public init = async (): Promise<void> => {\n    if (!this.initialized) {\n      await this.producer.connect();\n      await this.consumer.connect();\n    }\n\n    const topics = this.baseYamlConfig.kafka.consumerTopics ?? [];\n    if (topics.length > 0 || this.connectorTopic) {\n      if (this.connectorTopic) {\n        Logger.getInstance().info(\n          `Default connector topic: ${this.connectorTopic}`,\n        );\n      }\n\n      // Do not directly subscribe to the given regex topics to maintain backwards compatibility with KafjaJS.\n      // This library does not support flags and requires the topics to be written in a specific way.\n      // _source_ with flag i becomes /*^_SOURCE_^*/ and not case independent.\n      const regexTopics = await this.getRegexTopics();\n      const topicsToSubscribeTo: Array<string> = [\n        ...this.getRegularTopics(),\n        ...regexTopics,\n      ];\n      if (this.connectorTopic) {\n        topicsToSubscribeTo.push(this.connectorTopic);\n      }\n\n      await Promise.all(\n        topicsToSubscribeTo.map(async (topic: string) => {\n          Logger.getInstance().info('Subscribing to', topic);\n          await this.consumer.subscribe({ topic });\n        }),\n      );\n\n      if (this.baseYamlConfig.kafka.autoCommitThreshold) {\n        Logger.getInstance().error(\n          'autoCommitThreshold is not supported in bulk listener. Please use autoCommitInterval instead',\n        );\n      }\n\n      await this.consumer.run({\n        partitionsConsumedConcurrently:\n          this.baseYamlConfig.kafka.partitionsConsumedConcurrently ?? 1,\n        eachMessage: this.consume,\n      });\n    }\n\n    this.initialized = true;\n  };\n\n  private consume: (kafkaMessage: KafkaJS.EachMessagePayload) => Promise<void> =\n    async (kafkaMessage: KafkaJS.EachMessagePayload) => {\n      const message = JSON.parse(\n        kafkaMessage.message?.value?.toString() || '{}',\n      );\n\n      if (isXodResponseType(message)) {\n        await Promise.all(\n          this.#responseCallbackWrappers.map(async (callback) => {\n            await callback(message);\n          }),\n        );\n      } else {\n        Logger.getInstance().warn(\n          `Message nr ${kafkaMessage.message.offset} is not a valid XodActionType`,\n        );\n      }\n    };\n\n  public async send(\n    messages: Array<XodBaseMessageType>,\n    topic: string,\n  ): Promise<boolean> {\n    let success = true;\n    if (!this.initialized) {\n      return false;\n    }\n\n    const payload: ProducerRecord = {\n      topic,\n      messages: messages.map((r) => {\n        return {\n          value: JSON.stringify(r),\n        };\n      }),\n    };\n\n    const response = await this.producer\n      .send(payload)\n      .catch(async (error: Error) => {\n        Logger.getInstance().error(\n          `[KAFKA SOURCE PRODUCER] in catch: Topic: ${topic}, ${JSON.stringify(error.message)} ${messages.length} messages`,\n        );\n        if (messages.length !== 1) {\n          Logger.getInstance().debug(\n            `[KAFKA SOURCE PRODUCER]: Try sending messages individually`,\n          );\n          success = await this.sendIndividual(messages, topic);\n          if (success) {\n            Logger.getInstance().debug(\n              `[KAFKA SOURCE PRODUCER]: Sending messages individually was successful`,\n            );\n          } else {\n            Logger.getInstance().error(\n              `[KAFKA SOURCE PRODUCER]: Sending messages individually failed`,\n            );\n          }\n          // override errorCode because the success flag is set accordingly\n          return [{ errorCode: 0 }] as Array<RecordMetadata>;\n        }\n        Logger.getInstance().error(\n          `[KAFKA SOURCE PRODUCER]: Sending messages individually failed`,\n        );\n        success = false;\n        return null;\n      });\n\n    if (\n      response === null ||\n      (Array.isArray(response) &&\n        response.length > 0 &&\n        response[0]?.errorCode &&\n        response[0].errorCode !== 0)\n    ) {\n      Logger.getInstance().error(\n        `[KAFKA SOURCE PRODUCER]: Topic: ${topic}, ${JSON.stringify(response)} ${messages.length} messages`,\n      );\n      return false;\n    }\n\n    return success;\n  }\n\n  public async sendIndividual(\n    messages: Array<XodBaseMessageType>,\n    topic: string,\n  ): Promise<boolean> {\n    let success = true;\n    // eslint-disable-next-line no-restricted-syntax\n    for (const message of messages) {\n      try {\n        // eslint-disable-next-line no-await-in-loop\n        const singleSuccess = await this.send([message], topic);\n        if (!singleSuccess) {\n          success = false;\n        }\n      } catch (error) {\n        Logger.getInstance().error(\n          `IndividualWentWrong: Topic: ${topic}, ${JSON.stringify(error)}`,\n        );\n        success = false;\n      }\n    }\n    return success;\n  }\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AACA,oBAAuB;AACvB,mBAIO;AAGP,sCAAuC;AAEhC,MAAM,2BAA2B,uDAAuB;AAAA,EAAxD;AAAA;AACL,SAAS,4BAEL,CAAC;AAEL,SAAU,cAAc;AAQxB,SAAO,OAAO,YAA2B;AACvC,UAAI,CAAC,KAAK,aAAa;AACrB,cAAM,KAAK,SAAS,QAAQ;AAC5B,cAAM,KAAK,SAAS,QAAQ;AAAA,MAC9B;AAEA,YAAM,SAAS,KAAK,eAAe,MAAM,kBAAkB,CAAC;AAC5D,UAAI,OAAO,SAAS,KAAK,KAAK,gBAAgB;AAC5C,YAAI,KAAK,gBAAgB;AACvB,+BAAO,YAAY,EAAE;AAAA,YACnB,4BAA4B,KAAK,cAAc;AAAA,UACjD;AAAA,QACF;AAKA,cAAM,cAAc,MAAM,KAAK,eAAe;AAC9C,cAAM,sBAAqC;AAAA,UACzC,GAAG,KAAK,iBAAiB;AAAA,UACzB,GAAG;AAAA,QACL;AACA,YAAI,KAAK,gBAAgB;AACvB,8BAAoB,KAAK,KAAK,cAAc;AAAA,QAC9C;AAEA,cAAM,QAAQ;AAAA,UACZ,oBAAoB,IAAI,OAAO,UAAkB;AAC/C,iCAAO,YAAY,EAAE,KAAK,kBAAkB,KAAK;AACjD,kBAAM,KAAK,SAAS,UAAU,EAAE,MAAM,CAAC;AAAA,UACzC,CAAC;AAAA,QACH;AAEA,YAAI,KAAK,eAAe,MAAM,qBAAqB;AACjD,+BAAO,YAAY,EAAE;AAAA,YACnB;AAAA,UACF;AAAA,QACF;AAEA,cAAM,KAAK,SAAS,IAAI;AAAA,UACtB,gCACE,KAAK,eAAe,MAAM,kCAAkC;AAAA,UAC9D,aAAa,KAAK;AAAA,QACpB,CAAC;AAAA,MACH;AAEA,WAAK,cAAc;AAAA,IACrB;AAEA,SAAQ,UACN,OAAO,iBAA6C;AAClD,YAAM,UAAU,KAAK;AAAA,QACnB,aAAa,SAAS,OAAO,SAAS,KAAK;AAAA,MAC7C;AAEA,cAAI,gCAAkB,OAAO,GAAG;AAC9B,cAAM,QAAQ;AAAA,UACZ,KAAK,0BAA0B,IAAI,OAAO,aAAa;AACrD,kBAAM,SAAS,OAAO;AAAA,UACxB,CAAC;AAAA,QACH;AAAA,MACF,OAAO;AACL,6BAAO,YAAY,EAAE;AAAA,UACnB,cAAc,aAAa,QAAQ,MAAM;AAAA,QAC3C;AAAA,MACF;AAAA,IACF;AAAA;AAAA,EA9EO;AAAA,EAMF,4BACL,kBACM;AACN,SAAK,0BAA0B,KAAK,gBAAgB;AAAA,EACtD;AAAA,EAsEA,MAAa,KACX,UACA,OACkB;AAClB,QAAI,UAAU;AACd,QAAI,CAAC,KAAK,aAAa;AACrB,aAAO;AAAA,IACT;AAEA,UAAM,UAA0B;AAAA,MAC9B;AAAA,MACA,UAAU,SAAS,IAAI,CAAC,MAAM;AAC5B,eAAO;AAAA,UACL,OAAO,KAAK,UAAU,CAAC;AAAA,QACzB;AAAA,MACF,CAAC;AAAA,IACH;AAEA,UAAM,WAAW,MAAM,KAAK,SACzB,KAAK,OAAO,EACZ,MAAM,OAAO,UAAiB;AAC7B,2BAAO,YAAY,EAAE;AAAA,QACnB,4CAA4C,KAAK,KAAK,KAAK,UAAU,MAAM,OAAO,CAAC,IAAI,SAAS,MAAM;AAAA,MACxG;AACA,UAAI,SAAS,WAAW,GAAG;AACzB,6BAAO,YAAY,EAAE;AAAA,UACnB;AAAA,QACF;AACA,kBAAU,MAAM,KAAK,eAAe,UAAU,KAAK;AACnD,YAAI,SAAS;AACX,+BAAO,YAAY,EAAE;AAAA,YACnB;AAAA,UACF;AAAA,QACF,OAAO;AACL,+BAAO,YAAY,EAAE;AAAA,YACnB;AAAA,UACF;AAAA,QACF;AAEA,eAAO,CAAC,EAAE,WAAW,EAAE,CAAC;AAAA,MAC1B;AACA,2BAAO,YAAY,EAAE;AAAA,QACnB;AAAA,MACF;AACA,gBAAU;AACV,aAAO;AAAA,IACT,CAAC;AAEH,QACE,aAAa,QACZ,MAAM,QAAQ,QAAQ,KACrB,SAAS,SAAS,KAClB,SAAS,CAAC,GAAG,aACb,SAAS,CAAC,EAAE,cAAc,GAC5B;AACA,2BAAO,YAAY,EAAE;AAAA,QACnB,mCAAmC,KAAK,KAAK,KAAK,UAAU,QAAQ,CAAC,IAAI,SAAS,MAAM;AAAA,MAC1F;AACA,aAAO;AAAA,IACT;AAEA,WAAO;AAAA,EACT;AAAA,EAEA,MAAa,eACX,UACA,OACkB;AAClB,QAAI,UAAU;AAEd,eAAW,WAAW,UAAU;AAC9B,UAAI;AAEF,cAAM,gBAAgB,MAAM,KAAK,KAAK,CAAC,OAAO,GAAG,KAAK;AACtD,YAAI,CAAC,eAAe;AAClB,oBAAU;AAAA,QACZ;AAAA,MACF,SAAS,OAAO;AACd,6BAAO,YAAY,EAAE;AAAA,UACnB,+BAA+B,KAAK,KAAK,KAAK,UAAU,KAAK,CAAC;AAAA,QAChE;AACA,kBAAU;AAAA,MACZ;AAAA,IACF;AACA,WAAO;AAAA,EACT;AACF;",
  "names": []
}
