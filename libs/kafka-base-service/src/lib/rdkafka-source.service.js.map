{
  "version": 3,
  "sources": ["../../../../../../../libs/kafka-base-service/src/lib/rdkafka-source.service.ts"],
  "sourcesContent": ["import { ProducerRecord, RecordMetadata } from 'kafkajs';\nimport { XodEventType, XodSourceMessageType } from '@xip-online-data/types';\nimport { Logger } from '@transai/logger';\nimport { RdKafkaBaseService } from './rdkafka-base.service';\nimport { KafkaSourceInterface } from './kafka-source.interface';\n\nexport class RdKafkaSourceService\n  extends RdKafkaBaseService\n  implements KafkaSourceInterface\n{\n  public async send(\n    messages: Array<XodSourceMessageType | XodEventType>,\n    topic: string,\n  ): Promise<boolean> {\n    let success = true;\n    if (!this.initialized) {\n      return false;\n    }\n\n    const payload: ProducerRecord = {\n      topic,\n      messages: messages.map((r) => {\n        return {\n          value: JSON.stringify(r),\n        };\n      }),\n    };\n\n    const response = await this.producer\n      .send(payload)\n      .catch(async (error: Error) => {\n        Logger.getInstance().error(\n          `[KAFKA SOURCE PRODUCER] in catch: Topic: ${topic}, ${JSON.stringify(error.message)} ${messages.length} messages`,\n        );\n        if (messages.length !== 1) {\n          Logger.getInstance().debug(\n            `[KAFKA SOURCE PRODUCER]: Try sending messages individually`,\n          );\n          success = await this.sendIndividual(messages, topic);\n          if (success) {\n            Logger.getInstance().debug(\n              `[KAFKA SOURCE PRODUCER]: Sending messages individually was successful`,\n            );\n          } else {\n            Logger.getInstance().error(\n              `[KAFKA SOURCE PRODUCER]: Sending messages individually failed`,\n            );\n          }\n          // override errorCode because the success flag is set accordingly\n          return [{ errorCode: 0 }] as Array<RecordMetadata>;\n        }\n        Logger.getInstance().error(\n          `[KAFKA SOURCE PRODUCER]: Sending messages individually failed`,\n        );\n        success = false;\n        return null;\n      });\n\n    if (\n      response === null ||\n      (Array.isArray(response) &&\n        response.length > 0 &&\n        response[0]?.errorCode &&\n        response[0].errorCode !== 0)\n    ) {\n      Logger.getInstance().error(\n        `[KAFKA SOURCE PRODUCER]: Topic: ${topic}, ${JSON.stringify(response)} ${messages.length} messages`,\n      );\n      return false;\n    }\n\n    return success;\n  }\n\n  public async sendIndividual(\n    messages: Array<XodSourceMessageType | XodEventType>,\n    topic: string,\n  ): Promise<boolean> {\n    let success = true;\n    // eslint-disable-next-line no-restricted-syntax\n    for (const message of messages) {\n      try {\n        // eslint-disable-next-line no-await-in-loop\n        const singleSuccess = await this.send([message], topic);\n        if (!singleSuccess) {\n          success = false;\n        }\n      } catch (error) {\n        Logger.getInstance().error(\n          `IndividualWentWrong: Topic: ${topic}, ${JSON.stringify(error)}`,\n        );\n        success = false;\n      }\n    }\n    return success;\n  }\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA,oBAAuB;AACvB,0BAAmC;AAG5B,MAAM,6BACH,uCAEV;AAAA,EACE,MAAa,KACX,UACA,OACkB;AAClB,QAAI,UAAU;AACd,QAAI,CAAC,KAAK,aAAa;AACrB,aAAO;AAAA,IACT;AAEA,UAAM,UAA0B;AAAA,MAC9B;AAAA,MACA,UAAU,SAAS,IAAI,CAAC,MAAM;AAC5B,eAAO;AAAA,UACL,OAAO,KAAK,UAAU,CAAC;AAAA,QACzB;AAAA,MACF,CAAC;AAAA,IACH;AAEA,UAAM,WAAW,MAAM,KAAK,SACzB,KAAK,OAAO,EACZ,MAAM,OAAO,UAAiB;AAC7B,2BAAO,YAAY,EAAE;AAAA,QACnB,4CAA4C,KAAK,KAAK,KAAK,UAAU,MAAM,OAAO,CAAC,IAAI,SAAS,MAAM;AAAA,MACxG;AACA,UAAI,SAAS,WAAW,GAAG;AACzB,6BAAO,YAAY,EAAE;AAAA,UACnB;AAAA,QACF;AACA,kBAAU,MAAM,KAAK,eAAe,UAAU,KAAK;AACnD,YAAI,SAAS;AACX,+BAAO,YAAY,EAAE;AAAA,YACnB;AAAA,UACF;AAAA,QACF,OAAO;AACL,+BAAO,YAAY,EAAE;AAAA,YACnB;AAAA,UACF;AAAA,QACF;AAEA,eAAO,CAAC,EAAE,WAAW,EAAE,CAAC;AAAA,MAC1B;AACA,2BAAO,YAAY,EAAE;AAAA,QACnB;AAAA,MACF;AACA,gBAAU;AACV,aAAO;AAAA,IACT,CAAC;AAEH,QACE,aAAa,QACZ,MAAM,QAAQ,QAAQ,KACrB,SAAS,SAAS,KAClB,SAAS,CAAC,GAAG,aACb,SAAS,CAAC,EAAE,cAAc,GAC5B;AACA,2BAAO,YAAY,EAAE;AAAA,QACnB,mCAAmC,KAAK,KAAK,KAAK,UAAU,QAAQ,CAAC,IAAI,SAAS,MAAM;AAAA,MAC1F;AACA,aAAO;AAAA,IACT;AAEA,WAAO;AAAA,EACT;AAAA,EAEA,MAAa,eACX,UACA,OACkB;AAClB,QAAI,UAAU;AAEd,eAAW,WAAW,UAAU;AAC9B,UAAI;AAEF,cAAM,gBAAgB,MAAM,KAAK,KAAK,CAAC,OAAO,GAAG,KAAK;AACtD,YAAI,CAAC,eAAe;AAClB,oBAAU;AAAA,QACZ;AAAA,MACF,SAAS,OAAO;AACd,6BAAO,YAAY,EAAE;AAAA,UACnB,+BAA+B,KAAK,KAAK,KAAK,UAAU,KAAK,CAAC;AAAA,QAChE;AACA,kBAAU;AAAA,MACZ;AAAA,IACF;AACA,WAAO;AAAA,EACT;AACF;",
  "names": []
}
