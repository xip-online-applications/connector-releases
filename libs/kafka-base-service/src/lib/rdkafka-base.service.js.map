{
  "version": 3,
  "sources": ["../../../../../../../libs/kafka-base-service/src/lib/rdkafka-base.service.ts"],
  "sourcesContent": ["import { KafkaJS } from '@confluentinc/kafka-javascript';\nimport { Logger } from '@transai/logger';\nimport {\n  isXodBaseMessageType,\n  KafkaCallbackResponse,\n  XodBaseMessageType,\n} from '@xip-online-data/types';\n\nimport { AbstractRdKafkaService } from './abstract-rdkafka-service';\nimport { KafkaCallbackWrapper } from './types';\n\nexport class RdKafkaBaseService extends AbstractRdKafkaService {\n  private readonly callbackWrappers = new Map<\n    string,\n    Array<KafkaCallbackWrapper>\n  >();\n\n  protected initialized = false;\n\n  public setCallbackFunction(\n    callbackFunction: (\n      message: XodBaseMessageType,\n    ) => Promise<KafkaCallbackResponse>,\n    eventType: string = RdKafkaBaseService.DEFAULT_CALLBACK_EVENT_TYPE,\n    identifier = '',\n  ): void {\n    if (!this.callbackWrappers.has(eventType)) {\n      this.callbackWrappers.set(eventType, []);\n    }\n\n    let callback = callbackFunction;\n\n    if (this.messageMonitor !== undefined) {\n      callback = this.messageMonitor.processMessage(callback);\n    }\n\n    this.callbackWrappers.get(eventType)?.push({\n      callback,\n      identifier:\n        eventType === RdKafkaBaseService.DEFAULT_CALLBACK_EVENT_TYPE\n          ? this.baseYamlConfig.processIdentifier\n          : identifier,\n    });\n  }\n\n  public init = async (): Promise<void> => {\n    if (!this.initialized) {\n      await this.producer.connect().catch((error) => {\n        Logger.getInstance().error(\n          `[RDKAFKA BASE SERVICE] Error connecting producer: ${error.message}`,\n          error,\n        );\n\n        throw error;\n      });\n      await this.consumer.connect().catch((error) => {\n        Logger.getInstance().error(\n          `[RDKAFKA BASE SERVICE] Error connecting consumer: ${error.message}`,\n          error,\n        );\n\n        throw error;\n      });\n    }\n\n    const topics = this.baseYamlConfig.kafka.consumerTopics ?? [];\n    if (topics.length > 0 || this.connectorTopic) {\n      if (this.connectorTopic) {\n        Logger.getInstance().info(\n          `Default connector topic: ${this.connectorTopic}`,\n        );\n      }\n\n      // Do not directly subscribe to the given regex topics to maintain backwards compatibility with KafjaJS.\n      // This library does not support flags and requires the topics to be written in a specific way.\n      // _source_ with flag i becomes /*^_SOURCE_^*/ and not case independent.\n      const regexTopics = await this.getRegexTopics();\n      const topicsToSubscribeTo: Array<string> = [\n        ...this.getRegularTopics(),\n        ...regexTopics,\n      ];\n      if (this.connectorTopic) {\n        topicsToSubscribeTo.push(this.connectorTopic);\n      }\n\n      await Promise.all(\n        topicsToSubscribeTo.map(async (topic: string) => {\n          Logger.getInstance().info('Subscribing to', topic);\n          await this.consumer.subscribe({ topic }).catch((error) => {\n            Logger.getInstance().error(\n              `[RDKAFKA BASE SERVICE] Error subscribing to topic ${topic}: ${error.message}`,\n              error,\n            );\n\n            throw error;\n          });\n        }),\n      );\n\n      if (this.baseYamlConfig.kafka.autoCommitThreshold) {\n        Logger.getInstance().error(\n          'autoCommitThreshold is not supported in bulk listener. Please use autoCommitInterval instead',\n        );\n      }\n\n      await this.consumer\n        .run({\n          partitionsConsumedConcurrently:\n            this.baseYamlConfig.kafka.partitionsConsumedConcurrently ?? 1,\n          eachMessage: this.consume,\n        })\n        .catch((error) => {\n          Logger.getInstance().error(\n            `[RDKAFKA BASE SERVICE] Error running consumer: ${error.message}`,\n            error,\n          );\n\n          throw error;\n        });\n    }\n\n    this.initialized = true;\n  };\n\n  private consume: (kafkaMessage: KafkaJS.EachMessagePayload) => Promise<void> =\n    async (kafkaMessage: KafkaJS.EachMessagePayload) => {\n      const message = JSON.parse(\n        kafkaMessage.message?.value?.toString() || '{}',\n      );\n\n      if (isXodBaseMessageType(message)) {\n        const interval = setInterval(() => {\n          kafkaMessage.heartbeat();\n        }, 5000);\n\n        try {\n          let callbackIdentifier = `${message.tenantIdentifier}_${message.eventType}`;\n\n          Logger.getInstance().debug(\n            `Received message from topic ${callbackIdentifier}: ${JSON.stringify(message)}`,\n          );\n\n          if (!this.callbackWrappers.has(callbackIdentifier)) {\n            callbackIdentifier = RdKafkaBaseService.DEFAULT_CALLBACK_EVENT_TYPE;\n          }\n\n          const callbackWrapper = this.callbackWrappers.get(callbackIdentifier);\n\n          if (!callbackWrapper) {\n            Logger.getInstance().debug(\n              `Callback function for topic ${callbackIdentifier} not set`,\n            );\n            return;\n          }\n\n          // eslint-disable-next-line no-restricted-syntax\n          for (const callback of callbackWrapper) {\n            // eslint-disable-next-line no-await-in-loop\n            const result = await callback.callback(message);\n            // eslint-disable-next-line no-await-in-loop\n            await this.reportResult(message, result, callback.identifier);\n          }\n        } catch (error: any) {\n          Logger.getInstance().debug(\n            `Error processing message: ${error.message}`,\n          );\n        } finally {\n          clearInterval(interval);\n        }\n      } else {\n        Logger.getInstance().warn(\n          `Message nr ${kafkaMessage.message.offset} is not a valid XodActionType`,\n        );\n      }\n    };\n\n  private reportResult = async (\n    message: XodBaseMessageType,\n    result: KafkaCallbackResponse,\n    responseSource: string,\n  ): Promise<void> => {\n    if (this.disableLogs) {\n      Logger.getInstance().debug(\n        'Skipping report result due to disableLogs flag',\n      );\n      return;\n    }\n\n    const returnMessage = {\n      type: message.type,\n      message,\n      result,\n      responseSource,\n      timestamp: new Date().getTime(),\n    };\n\n    const topic = `${message.tenantIdentifier}${this.processedTopic}`;\n\n    Logger.getInstance().debug(\n      `Sending message to logs topic ${topic} ${JSON.stringify(returnMessage)}`,\n    );\n\n    await this.producer\n      .send({\n        topic,\n        messages: [\n          {\n            value: JSON.stringify(returnMessage),\n          },\n        ],\n      })\n      .catch((error) => {\n        Logger.getInstance().error(\n          `[RDKAFKA BASE SERVICE] Error sending message to topic ${topic}: ${error.message}`,\n          error,\n        );\n\n        throw error;\n      });\n  };\n}\n"],
  "mappings": "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",
  "names": []
}
