{
  "version": 3,
  "sources": ["../../../../../../../libs/kafka-base-service/src/lib/abstract-rdkafka-service.ts"],
  "sourcesContent": ["import {\n  AwsKafkaSaslConfig,\n  BaseConnectorConfig,\n  isTopicRegex,\n} from '@xip-online-data/types';\nimport { v4 as uuidv4 } from 'uuid';\nimport { KafkaJS } from '@confluentinc/kafka-javascript';\nimport { interval } from 'rxjs';\nimport { captureException } from '@sentry/node';\nimport {\n  ConsumerConstructorConfig,\n  KafkaConfig,\n  OauthbearerProviderResponse,\n} from '@confluentinc/kafka-javascript/types/kafkajs';\nimport { Logger } from '@transai/logger';\nimport {\n  generateAuthTokenFromCredentialsProvider,\n  generateAuthToken,\n} from 'aws-msk-iam-sasl-signer-js';\nimport { AwsCredentialIdentity } from '@smithy/types/dist-types/identity/awsCredentialIdentity';\nimport { MessageMonitorInterface } from './message-monitor.interface';\nimport { InMemoryMessageMonitor } from './in-memory.message-monitor';\nimport { RedisMessageMonitor } from './redis.message-monitor';\n\nconst getAwsCredentials =\n  (awsSasl: { accessKeyId: string; secretAccessKey: string }) =>\n  (): Promise<AwsCredentialIdentity> => {\n    return Promise.resolve({\n      accessKeyId: awsSasl.accessKeyId,\n      secretAccessKey: awsSasl.secretAccessKey,\n    });\n  };\n\nconst oauthBearerTokenProvider =\n  (awsSasl?: AwsKafkaSaslConfig) =>\n  async (): Promise<OauthbearerProviderResponse> => {\n    const principal = process.env['AWS_ROLE_SESSION_NAME'] ?? '';\n    if (awsSasl?.accessKeyId && awsSasl?.secretAccessKey) {\n      Logger.getInstance().info(\n        `Generating OAuth Bearer token using ENV variables and principal: ${principal}`,\n      );\n      const authTokenResponse = await generateAuthTokenFromCredentialsProvider({\n        region: awsSasl.region ?? 'eu-west-1',\n        awsCredentialsProvider: getAwsCredentials({\n          accessKeyId: awsSasl.accessKeyId,\n          secretAccessKey: awsSasl.secretAccessKey,\n        }),\n      });\n      Logger.getInstance().info(\n        `Token using Default Credentials Provider ${authTokenResponse.expiryTime} - ${authTokenResponse.expiryTime - Date.now()}ms`,\n      );\n      return {\n        principal,\n        value: authTokenResponse.token,\n        lifetime: authTokenResponse.expiryTime,\n      };\n    }\n    Logger.getInstance().info(\n      `Generating OAuth Bearer token using Default Credentials Provider and principal: ${principal}`,\n    );\n    const authTokenResponse = await generateAuthToken({\n      region: awsSasl?.region ?? 'eu-west-1',\n      awsRoleSessionName: principal,\n      logger: Logger.getInstance(),\n      awsDebugCreds: true,\n    });\n    Logger.getInstance().info(\n      `Token using Default Credentials Provider ${authTokenResponse.expiryTime} - ${authTokenResponse.expiryTime - Date.now()}ms`,\n    );\n    return {\n      principal,\n      value: authTokenResponse.token,\n      lifetime: authTokenResponse.expiryTime,\n    };\n  };\n\nexport abstract class AbstractRdKafkaService {\n  protected readonly errorTypes = ['unhandledRejection', 'uncaughtException'];\n\n  protected readonly signalTraps = ['SIGTERM', 'SIGINT', 'SIGUSR2'];\n\n  public static readonly DEFAULT_CALLBACK_EVENT_TYPE = '*';\n\n  protected readonly kafkaBase: KafkaJS.Kafka;\n\n  protected readonly consumer: KafkaJS.Consumer;\n\n  protected readonly producer: KafkaJS.Producer;\n\n  protected readonly processedTopic: string = '_LOGS_xod';\n\n  protected readonly DEFAULT_INTERVAL_CHECK_FOR_NEW_TOPICS = 300;\n\n  protected numberOfSubscribedRegexTopics = 0;\n\n  protected readonly disableLogs: boolean;\n\n  protected messageMonitor: MessageMonitorInterface | undefined = undefined;\n\n  public abstract init(): Promise<void>;\n\n  protected readonly logger: Logger;\n\n  public constructor(\n    protected readonly baseYamlConfig: BaseConnectorConfig,\n    protected readonly connectorTopic?: string | undefined,\n  ) {\n    this.logger = Logger.getInstance();\n    this.logger.info('RUNNING RDKAFKA SERVICE');\n    const { kafka: kafkaConfig } = baseYamlConfig;\n    const kafkaJS: KafkaConfig = {\n      brokers: kafkaConfig.brokers,\n      ssl: false,\n      clientId: `${kafkaConfig.clientId}-${uuidv4()}`,\n      logLevel: 2,\n    };\n\n    if (kafkaConfig.sasl) {\n      const { sasl } = kafkaConfig;\n      kafkaJS.sasl = {\n        mechanism: 'oauthbearer',\n        oauthBearerProvider: oauthBearerTokenProvider(sasl),\n      };\n      kafkaJS.ssl = true;\n    }\n\n    this.messageMonitor = this.getCorrespondingMonitor();\n\n    this.disableLogs = baseYamlConfig.kafka.disableLogs ?? false;\n\n    this.kafkaBase = new KafkaJS.Kafka({ kafkaJS });\n\n    const consumerConfig: ConsumerConstructorConfig = {\n      kafkaJS: {\n        groupId: baseYamlConfig.kafka.groupId,\n        autoCommitInterval: baseYamlConfig.kafka.autoCommitInterval ?? 5000,\n        fromBeginning: true,\n      },\n    };\n\n    if (baseYamlConfig.kafka.newConsumerProtocol) {\n      this.logger.info('Using new consumer protocol');\n      consumerConfig['group.protocol'] = 'consumer';\n      consumerConfig['group.protocol.type'] = 'consumer';\n      consumerConfig['group.remote.assignor'] = 'uniform';\n    }\n\n    this.consumer = this.kafkaBase.consumer(consumerConfig);\n    this.producer = this.kafkaBase.producer();\n\n    if (\n      !connectorTopic &&\n      (this.baseYamlConfig.kafka.consumerTopics === undefined ||\n        this.baseYamlConfig.kafka.consumerTopics.length === 0)\n    ) {\n      this.logger.warn(\n        'No consumer topics set. skip setting of consumer events callback',\n      );\n      return;\n    }\n\n    this.getRegexTopics().then((topics) => {\n      this.numberOfSubscribedRegexTopics = topics.length;\n    });\n\n    const intervalCheckForNewTopics =\n      this.baseYamlConfig.kafka.intervalCheckForNewTopics ??\n      this.DEFAULT_INTERVAL_CHECK_FOR_NEW_TOPICS;\n    if (intervalCheckForNewTopics > 0) {\n      interval(intervalCheckForNewTopics * 1000).subscribe(() => {\n        this.checkForNewTopics().then(this.restartIfNewTopics.bind(this));\n      });\n    }\n\n    if (process) {\n      this.logger.info('Setting up gracefull shutdown for kafka...');\n\n      this.errorTypes.forEach((type) => {\n        process.on(type, async (e) => {\n          try {\n            this.logger.error(`process.on ${type}`);\n            this.logger.error(e);\n            await this.exitProcess(type);\n          } catch (_) {\n            process.exit(1);\n          }\n        });\n      });\n\n      this.signalTraps.forEach((type) => {\n        process.on(type, async () => {\n          this.logger.error(`process.once ${type}`);\n          try {\n            await this.exitProcess(type);\n          } finally {\n            process.exit(0);\n          }\n        });\n      });\n    } else {\n      this.logger.warn('No process found. Gracefull shutdown not possible');\n    }\n  }\n\n  public exitProcess = async (type: string): Promise<void> => {\n    this.logger.warn(\n      `Got ${type}. Graceful shutdown Kafka start ${new Date().toISOString()}`,\n    );\n    this.logger.info('Disconnecting consumer and producer');\n\n    try {\n      await this.consumer?.disconnect();\n      this.logger.info('Consumer disconnected');\n    } catch (error) {\n      this.logger.error('Error while disconnecting consumer');\n      console.error(error);\n    }\n\n    try {\n      await this.producer?.disconnect();\n      this.logger.info('Producer disconnected');\n    } catch (error) {\n      this.logger.error('Error while disconnecting producer');\n      console.error(error);\n    }\n\n    this.logger.info(\n      `Graceful shutdown Kafka complete ${new Date().toISOString()}`,\n    );\n    process.exit(0);\n  };\n\n  private getCorrespondingMonitor(): MessageMonitorInterface | undefined {\n    if (this.baseYamlConfig.kafka.messageMonitor?.type === 'in-memory') {\n      if (this.baseYamlConfig.debug)\n        this.logger.debug('Using in-memory message monitor');\n      return new InMemoryMessageMonitor(\n        this.baseYamlConfig.kafka.messageMonitor,\n        this.baseYamlConfig,\n      );\n    }\n\n    if (this.baseYamlConfig.kafka.messageMonitor?.type === 'redis') {\n      if (this.baseYamlConfig.debug)\n        this.logger.debug('Using Redis message monitor');\n      return new RedisMessageMonitor(\n        this.baseYamlConfig.kafka.messageMonitor,\n        this.baseYamlConfig,\n      );\n    }\n\n    if (this.baseYamlConfig.kafka.messageMonitor?.type === 'disabled') {\n      if (this.baseYamlConfig.debug)\n        this.logger.debug('Message monitor disabled');\n      return undefined;\n    }\n\n    if (this.baseYamlConfig.debug)\n      this.logger.debug('No setting, Message monitor disabled');\n    return undefined;\n  }\n\n  private checkForNewTopics = async (): Promise<boolean> => {\n    const applicableTopics = await this.getRegexTopics();\n    const numberOfApplicableTopics = applicableTopics.length;\n    return numberOfApplicableTopics !== this.numberOfSubscribedRegexTopics;\n  };\n\n  protected getRegularTopics = (): Array<string> => {\n    return (this.baseYamlConfig.kafka.consumerTopics ?? []).filter(\n      (t) => !isTopicRegex(t),\n    ) as Array<string>;\n  };\n\n  protected getRegexTopics = async (): Promise<Array<string>> => {\n    const regexTopics = (this.baseYamlConfig.kafka.consumerTopics ?? []).filter(\n      (t) => isTopicRegex(t),\n    );\n\n    if (regexTopics.length === 0) {\n      return [];\n    }\n\n    const regexList = regexTopics.map(\n      (topic) => new RegExp(topic.pattern, topic.flags),\n    );\n\n    const admin = this.kafkaBase.admin();\n    await admin.connect();\n    const existingTopics = await admin.listTopics();\n    await admin.disconnect();\n\n    return existingTopics.filter((topic) =>\n      regexList.some((regex) => regex.test(topic)),\n    );\n  };\n\n  private restartIfNewTopics = async (newTopics: boolean): Promise<void> => {\n    if (newTopics) {\n      try {\n        this.logger.info('New topics found, restarting consumer');\n        await this.consumer.disconnect();\n        await this.init();\n      } catch (error) {\n        captureException(error);\n        process.exit(1);\n      }\n    }\n  };\n}\n"],
  "mappings": "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",
  "names": ["authTokenResponse", "uuidv4"]
}
