{
  "version": 3,
  "sources": ["../../../../../../../libs/kafka-base-service/src/lib/redis.message-monitor.ts"],
  "sourcesContent": ["import {\n  BaseConnectorConfig,\n  RedisMessageMonitorConfig,\n  XodBaseMessageType,\n} from '@xip-online-data/types';\nimport { createClient, RedisClientType } from 'redis';\nimport { Logger } from '@transai/logger';\nimport { AbstractMessageMonitor } from './abstract.message-monitor';\n\nexport class RedisMessageMonitor extends AbstractMessageMonitor {\n  private redisClient: RedisClientType | undefined = undefined;\n\n  private initialized = false;\n\n  private readonly DEFAULT_TTL = 2 * 60 * 60;\n\n  constructor(\n    private readonly config: RedisMessageMonitorConfig,\n    baseConfig: BaseConnectorConfig,\n  ) {\n    super(baseConfig);\n\n    createClient({\n      url: this.config.url,\n    })\n      .on('error', (err) =>\n        Logger.getInstance().error(\n          '[REDIS MESSAGE MONITOR] Redis Client Error',\n          err,\n        ),\n      )\n      .connect()\n      .then((client) => {\n        this.redisClient = client as RedisClientType;\n        this.initialized = true;\n      });\n  }\n\n  protected override async isProcessed(\n    message: XodBaseMessageType,\n  ): Promise<boolean> {\n    if (this.redisClient === undefined || !this.initialized) {\n      Logger.getInstance().error(\n        '[REDIS MESSAGE MONITOR] Not initialized. continue to handle message',\n      );\n      return false;\n    }\n\n    return (\n      (await this.redisClient.exists(\n        this.getMessageProcessIdentifier(message),\n      )) === 1\n    );\n  }\n\n  protected override async addProcessedMessage(\n    message: XodBaseMessageType,\n  ): Promise<void> {\n    if (this.redisClient === undefined || !this.initialized) {\n      Logger.getInstance().error(\n        '[REDIS MESSAGE MONITOR] Not initialized. Cannot store message details',\n      );\n      return;\n    }\n\n    await this.redisClient.set(this.getMessageProcessIdentifier(message), '1', {\n      EX: this.config.ttl ?? this.DEFAULT_TTL,\n    });\n  }\n\n  private getMessageProcessIdentifier(message: XodBaseMessageType): string {\n    return `${this.baseConfig.processIdentifier}.${message.eventId}`;\n  }\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAKA,mBAA8C;AAC9C,oBAAuB;AACvB,sBAAuC;AAEhC,MAAM,4BAA4B,uCAAuB;AAAA,EAO9D,YACmB,QACjB,YACA;AACA,UAAM,UAAU;AAHC;AAPnB,SAAQ,cAA2C;AAEnD,SAAQ,cAAc;AAEtB,SAAiB,cAAc,IAAI,KAAK;AAQtC,mCAAa;AAAA,MACX,KAAK,KAAK,OAAO;AAAA,IACnB,CAAC,EACE;AAAA,MAAG;AAAA,MAAS,CAAC,QACZ,qBAAO,YAAY,EAAE;AAAA,QACnB;AAAA,QACA;AAAA,MACF;AAAA,IACF,EACC,QAAQ,EACR,KAAK,CAAC,WAAW;AAChB,WAAK,cAAc;AACnB,WAAK,cAAc;AAAA,IACrB,CAAC;AAAA,EACL;AAAA,EAEA,MAAyB,YACvB,SACkB;AAClB,QAAI,KAAK,gBAAgB,UAAa,CAAC,KAAK,aAAa;AACvD,2BAAO,YAAY,EAAE;AAAA,QACnB;AAAA,MACF;AACA,aAAO;AAAA,IACT;AAEA,WACG,MAAM,KAAK,YAAY;AAAA,MACtB,KAAK,4BAA4B,OAAO;AAAA,IAC1C,MAAO;AAAA,EAEX;AAAA,EAEA,MAAyB,oBACvB,SACe;AACf,QAAI,KAAK,gBAAgB,UAAa,CAAC,KAAK,aAAa;AACvD,2BAAO,YAAY,EAAE;AAAA,QACnB;AAAA,MACF;AACA;AAAA,IACF;AAEA,UAAM,KAAK,YAAY,IAAI,KAAK,4BAA4B,OAAO,GAAG,KAAK;AAAA,MACzE,IAAI,KAAK,OAAO,OAAO,KAAK;AAAA,IAC9B,CAAC;AAAA,EACH;AAAA,EAEQ,4BAA4B,SAAqC;AACvE,WAAO,GAAG,KAAK,WAAW,iBAAiB,IAAI,QAAQ,OAAO;AAAA,EAChE;AACF;",
  "names": []
}
