{
  "version": 3,
  "sources": ["../../../../../../../libs/connector-runner-mqtt/src/lib/mqtt.client.ts"],
  "sourcesContent": ["import { MqttClient as mqtt, connect } from 'mqtt';\nimport { KafkaSourceInterface } from '@xip-online-data/kafka-base-service';\nimport {\n  BaseConnectorConfig,\n  XodSourceMessageType,\n  XodSourcePayloadType,\n} from '@xip-online-data/types';\nimport { v4 as uuidv4 } from 'uuid';\nimport { Logger } from '@transai/logger';\nimport { MqttConfig } from './types';\n\nexport function generateKafkaTopic(\n  connectorConfig: BaseConnectorConfig,\n): string {\n  return `${connectorConfig.tenantIdentifier}_SOURCE_${connectorConfig.datasourceIdentifier}`;\n}\n\nexport class MqttClient {\n  readonly #baseConnectorConfig: BaseConnectorConfig;\n\n  readonly #client: mqtt | undefined;\n\n  readonly #kafkaService: KafkaSourceInterface;\n\n  readonly #logger: Logger;\n\n  constructor(\n    baseConnectorConfig: BaseConnectorConfig,\n    private readonly mqttConfig: MqttConfig,\n    kafkaService: KafkaSourceInterface,\n  ) {\n    this.#logger = Logger.getInstance();\n    this.#baseConnectorConfig = baseConnectorConfig;\n    this.#kafkaService = kafkaService;\n    this.#client = connect(mqttConfig.brokerUrl, {\n      clientId: mqttConfig.clientId,\n      username: mqttConfig.username,\n      password: mqttConfig.password,\n      rejectUnauthorized: false,\n    });\n\n    this.#client.on('connect', () => {\n      this.#logger.info('Connected to MQTT broker');\n      this.#client?.subscribe(mqttConfig.topic);\n    });\n\n    this.#client.on('error', (err) => {\n      this.#logger.error('MQTT connection error:', err);\n    });\n\n    this.#client.on('message', async (topic: string, message: object) => {\n      const msg = message.toString();\n      this.#logger.debug(\n        `Received message from MQTT broker with topic ${topic}: ${msg}`,\n      );\n      let body: {\n        [key: string]: unknown;\n      };\n      try {\n        body = JSON.parse(msg) as {\n          [key: string]: unknown;\n        };\n      } catch (error) {\n        this.#logger.error(`Error parsing message ${msg}:`, error);\n        body = {\n          body: msg,\n        };\n      }\n\n      const kafkaPayload = this.#buildKafkaPayload(topic, body);\n      const kafkaTopic = generateKafkaTopic(this.#baseConnectorConfig);\n      this.#logger.debug(\n        `Sending message to Kafka with topic ${kafkaTopic}:`,\n        kafkaPayload,\n      );\n      await this.#kafkaService.send([kafkaPayload], kafkaTopic);\n    });\n  }\n\n  async stop() {\n    this.#client?.removeAllListeners();\n    await this.#client?.unsubscribeAsync(this.mqttConfig.topic);\n    await this.#client?.endAsync();\n  }\n\n  #buildKafkaPayload = (\n    topic: string,\n    message: {\n      [key: string]: unknown;\n    },\n  ): XodSourceMessageType => {\n    return {\n      type: 'SOURCE',\n      eventId: uuidv4(),\n      eventType: 'event.metric',\n      created: Date.now(),\n      ttl: 3600000, // 1 month\n      tenantIdentifier: this.#baseConnectorConfig.tenantIdentifier,\n      payload: this.#buildPayload(topic, message),\n    };\n  };\n\n  #buildPayload = (\n    topic: string,\n    message: {\n      [key: string]: unknown;\n    },\n  ): XodSourcePayloadType => {\n    return {\n      collection: topic,\n      body: message,\n    };\n  };\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,kBAA4C;AAO5C,kBAA6B;AAC7B,oBAAuB;AAGhB,SAAS,mBACd,iBACQ;AACR,SAAO,GAAG,gBAAgB,gBAAgB,WAAW,gBAAgB,oBAAoB;AAC3F;AAEO,MAAM,WAAW;AAAA,EAStB,YACE,qBACiB,YACjB,cACA;AAFiB;AAGjB,SAAK,UAAU,qBAAO,YAAY;AAClC,SAAK,uBAAuB;AAC5B,SAAK,gBAAgB;AACrB,SAAK,cAAU,qBAAQ,WAAW,WAAW;AAAA,MAC3C,UAAU,WAAW;AAAA,MACrB,UAAU,WAAW;AAAA,MACrB,UAAU,WAAW;AAAA,MACrB,oBAAoB;AAAA,IACtB,CAAC;AAED,SAAK,QAAQ,GAAG,WAAW,MAAM;AAC/B,WAAK,QAAQ,KAAK,0BAA0B;AAC5C,WAAK,SAAS,UAAU,WAAW,KAAK;AAAA,IAC1C,CAAC;AAED,SAAK,QAAQ,GAAG,SAAS,CAAC,QAAQ;AAChC,WAAK,QAAQ,MAAM,0BAA0B,GAAG;AAAA,IAClD,CAAC;AAED,SAAK,QAAQ,GAAG,WAAW,OAAO,OAAe,YAAoB;AACnE,YAAM,MAAM,QAAQ,SAAS;AAC7B,WAAK,QAAQ;AAAA,QACX,gDAAgD,KAAK,KAAK,GAAG;AAAA,MAC/D;AACA,UAAI;AAGJ,UAAI;AACF,eAAO,KAAK,MAAM,GAAG;AAAA,MAGvB,SAAS,OAAO;AACd,aAAK,QAAQ,MAAM,yBAAyB,GAAG,KAAK,KAAK;AACzD,eAAO;AAAA,UACL,MAAM;AAAA,QACR;AAAA,MACF;AAEA,YAAM,eAAe,KAAK,mBAAmB,OAAO,IAAI;AACxD,YAAM,aAAa,mBAAmB,KAAK,oBAAoB;AAC/D,WAAK,QAAQ;AAAA,QACX,uCAAuC,UAAU;AAAA,QACjD;AAAA,MACF;AACA,YAAM,KAAK,cAAc,KAAK,CAAC,YAAY,GAAG,UAAU;AAAA,IAC1D,CAAC;AAAA,EACH;AAAA,EA3DS;AAAA,EAEA;AAAA,EAEA;AAAA,EAEA;AAAA,EAuDT,MAAM,OAAO;AACX,SAAK,SAAS,mBAAmB;AACjC,UAAM,KAAK,SAAS,iBAAiB,KAAK,WAAW,KAAK;AAC1D,UAAM,KAAK,SAAS,SAAS;AAAA,EAC/B;AAAA,EAEA,qBAAqB,CACnB,OACA,YAGyB;AACzB,WAAO;AAAA,MACL,MAAM;AAAA,MACN,aAAS,YAAAA,IAAO;AAAA,MAChB,WAAW;AAAA,MACX,SAAS,KAAK,IAAI;AAAA,MAClB,KAAK;AAAA;AAAA,MACL,kBAAkB,KAAK,qBAAqB;AAAA,MAC5C,SAAS,KAAK,cAAc,OAAO,OAAO;AAAA,IAC5C;AAAA,EACF;AAAA,EAEA,gBAAgB,CACd,OACA,YAGyB;AACzB,WAAO;AAAA,MACL,YAAY;AAAA,MACZ,MAAM;AAAA,IACR;AAAA,EACF;AACF;",
  "names": ["uuidv4"]
}
