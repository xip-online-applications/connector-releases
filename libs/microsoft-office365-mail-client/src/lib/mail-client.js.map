{
  "version": 3,
  "sources": ["../../../../../../../libs/microsoft-office365-mail-client/src/lib/mail-client.ts"],
  "sourcesContent": ["import { Logger } from '@transai/logger';\n\nimport { MailClientInterface } from './mail-client.interface';\nimport { Office365Client } from './office365-client';\nimport { Office365MailParser } from './office365-mail-parser';\nimport { Office365Folder, Office365Mail } from './office365-types';\nimport { MailAttachment, MailConfig, MailMessage } from './types';\n\nexport class MailClient implements MailClientInterface {\n  /**\n   * 6 hours (tune if needed)\n   */\n  readonly #OVERLAP_MS = 21_600_000;\n\n  readonly #office365Client: Office365Client;\n\n  readonly #office365Parser: Office365MailParser;\n\n  readonly #config: MailConfig;\n\n  readonly #logger: Logger;\n\n  constructor(\n    config: MailConfig,\n    office365Client?: Office365Client,\n    office365Parser?: Office365MailParser,\n  ) {\n    this.#config = config;\n    this.#logger = Logger.getInstance();\n    this.#office365Client =\n      office365Client ??\n      new Office365Client(\n        this.#config.username,\n        this.#config.emlTestMode ?? false,\n      );\n    this.#office365Parser = office365Parser ?? new Office365MailParser();\n\n    if (\n      !this.#config.tenantId ||\n      !this.#config.clientId ||\n      !this.#config.clientSecret\n    ) {\n      throw new Error('Graph requires tenantId, clientId, and clientSecret');\n    }\n  }\n\n  async readMailbox(\n    mailbox: string,\n    lastSeenTimestamp = 0,\n    lastSeenId: string = undefined,\n    limit = 10,\n  ): Promise<Array<MailMessage>> {\n    try {\n      await this.#init();\n\n      // Overlap backwards to avoid missing events with identical timestamps\n      const fromEpoch = Math.max(\n        0,\n        (lastSeenTimestamp || 0) - this.#OVERLAP_MS,\n      );\n\n      const folder = await this.#office365Client.getFolder(mailbox);\n      if (!folder) {\n        throw new Error(`Mailbox folder not found: ${mailbox}`);\n      }\n\n      const mails = await this.#office365Client.getMails(\n        folder,\n        limit,\n        fromEpoch,\n      );\n\n      // Per-run dedupe by Graph message id\n      const seenIds = new Set<string>();\n\n      const messages = await Promise.all(\n        mails\n          .filter((office365Mail) => !!office365Mail)\n          .filter((office365Mail) => !seenIds.has(office365Mail.id))\n          .map(\n            async (office365Mail): Promise<MailMessage | undefined> =>\n              this.#parseEmail(\n                office365Mail,\n                folder,\n                seenIds,\n                lastSeenTimestamp,\n                lastSeenId,\n              ),\n          ),\n      );\n\n      return messages\n        .filter((gm) => !!gm)\n        .sort((a, b) => {\n          if (a.deltaTimestamp !== b.deltaTimestamp) {\n            return a.deltaTimestamp - b.deltaTimestamp;\n          }\n\n          return a.deltaId.localeCompare(b.deltaId);\n        });\n    } catch (err) {\n      const message = `Failed to read email from mailbox ${mailbox}`;\n      this.#logger.warn(message, err);\n      throw new Error(message);\n    }\n  }\n\n  async reply(\n    messageId: string,\n    from: string,\n    body: string,\n    concept = true,\n  ): Promise<void> {\n    await this.#init();\n\n    const originalMail = await this.#office365Client.getMail(messageId);\n    if (!originalMail) {\n      throw new Error(`Message with ID ${messageId} not found`);\n    }\n\n    const draftMail = await this.#office365Client.createReply(\n      originalMail,\n      this.#office365Parser.formatMailReplyBody(originalMail, body),\n      from,\n    );\n\n    if (!concept) {\n      return this.#office365Client.sendMail(draftMail);\n    }\n\n    // Ensure in Drafts (createReply usually does this)\n    const draftsFolder = await this.#office365Client.getFolder('Drafts');\n    if (!draftsFolder) {\n      throw new Error('Folder not found: Drafts');\n    }\n\n    return this.#office365Client.moveMailToFolder(draftMail, draftsFolder);\n  }\n\n  async getAttachments(\n    mailbox: string,\n    messageId: string,\n  ): Promise<Array<MailAttachment>> {\n    const folder = await this.#office365Client.getFolder(mailbox);\n    if (!folder) {\n      throw new Error(`Mailbox folder not found: ${mailbox}`);\n    }\n\n    const attachments = await this.#office365Client.listAttachments(\n      folder.id,\n      messageId,\n    );\n\n    return attachments.map((attachment) => ({\n      id: attachment.cid ?? attachment.id,\n      contentType: attachment.contentType,\n      filename: attachment.fileName,\n      content: attachment.contentBytes\n        ? // @ts-expect-error contentBytes is base64-encoded string\n          Buffer.from(attachment.contentBytes, 'base64').toString('utf-8')\n        : undefined,\n      contentBytes: attachment.contentBytes\n        ? // @ts-expect-error contentBytes is base64-encoded string\n          Buffer.from(attachment.contentBytes, 'base64')\n        : undefined,\n    }));\n  }\n\n  async addCategory(\n    messageId: string,\n    ...category: Array<string>\n  ): Promise<void> {\n    await this.#init();\n\n    const originalMail = await this.#office365Client.getMail(messageId);\n    if (!originalMail) {\n      throw new Error(`Message with ID ${messageId} not found`);\n    }\n\n    const categories =\n      await this.#office365Client.getMailCategories(originalMail);\n    const current = (categories?.categories as Array<string>) || [];\n\n    await this.#office365Client.updateMailCategories(originalMail, {\n      categories: Array.from(new Set([...current, ...category]).values()),\n    });\n  }\n\n  async removeCategory(\n    messageId: string,\n    ...category: Array<string>\n  ): Promise<void> {\n    await this.#init();\n\n    const originalMail = await this.#office365Client.getMail(messageId);\n    if (!originalMail) {\n      throw new Error(`Message with ID ${messageId} not found`);\n    }\n\n    const categories =\n      await this.#office365Client.getMailCategories(originalMail);\n    const current = (categories?.categories as Array<string>) || [];\n\n    await this.#office365Client.updateMailCategories(originalMail, {\n      categories: current.filter((c) => !category.includes(c)),\n    });\n  }\n\n  async #init(): Promise<void> {\n    this.#logger.verbose(\n      `Initializing Microsoft Office 365 mail client for ${this.#config.username}`,\n    );\n\n    await this.#office365Client.init(\n      this.#config.tenantId,\n      this.#config.clientId,\n      this.#config.clientSecret,\n    );\n\n    this.#logger.debug(\n      `Microsoft Office 365 mail client initialized for ${this.#config.username}`,\n    );\n  }\n\n  #isAfterCursor(\n    t: number,\n    id: string,\n    lastTime: number,\n    lastId?: string,\n  ): boolean {\n    if (t > lastTime) return true;\n    if (t < lastTime) return false;\n    // equal time \u2192 break ties by id (string compare)\n    if (!lastId) return true; // first run with only time\n    return id > lastId;\n  }\n\n  async #parseEmail(\n    office365Mail: Office365Mail,\n    office365Folder: Office365Folder,\n    seenIds: Set<string>,\n    lastSeenTimestamp: number,\n    lastSeenId: string,\n  ): Promise<MailMessage | undefined> {\n    // eslint-disable-next-line no-nested-ternary\n    const receivedMs = office365Mail.receivedDateTime\n      ? new Date(office365Mail.receivedDateTime).getTime()\n      : office365Mail.sentDateTime\n        ? new Date(office365Mail.sentDateTime).getTime()\n        : 0;\n\n    // Only emit strictly newer than the stored watermark\n    if (\n      !this.#isAfterCursor(\n        receivedMs,\n        office365Mail.id,\n        lastSeenTimestamp,\n        lastSeenId,\n      )\n    ) {\n      return undefined;\n    }\n\n    try {\n      const fullMail = await this.#office365Client.getFullMail(\n        office365Folder,\n        office365Mail,\n      );\n\n      seenIds.add(office365Mail.id);\n\n      return this.#office365Parser.parsedToMailMessage(\n        office365Mail,\n        fullMail,\n        new Date(receivedMs),\n      );\n    } catch (err) {\n      seenIds.delete(office365Mail.id);\n      this.#logger.warn(\n        `Failed to read full mail and parse: [${office365Folder.id}] ${office365Folder.displayName} // [${office365Mail.id}] ${office365Mail.subject}`,\n        err,\n      );\n      return undefined;\n    }\n  }\n}\n"],
  "mappings": "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",
  "names": []
}
