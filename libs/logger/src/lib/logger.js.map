{
  "version": 3,
  "sources": ["../../../../../../../libs/logger/src/lib/logger.ts"],
  "sourcesContent": ["import process from 'node:process';\n\nimport * as winston from 'winston';\n\nexport enum LogLevels {\n  error = 'error',\n  warn = 'warn',\n  info = 'info',\n  http = 'http',\n  debug = 'debug',\n}\n\nexport class Logger {\n  // eslint-disable-next-line no-use-before-define\n  private static instance: Logger;\n\n  private readonly logger: winston.Logger;\n\n  #datadogTransport?: winston.transports.HttpTransportInstance;\n\n  constructor(identifier = 'default', loglevel: LogLevels = LogLevels.info) {\n    this.logger = winston.createLogger({\n      level: loglevel,\n      format: winston.format.combine(\n        winston.format.label({ label: identifier }),\n        winston.format.timestamp(),\n        winston.format.json(),\n      ),\n    });\n\n    let transportsAdded = false;\n\n    if (\n      process.env['NODE_ENV'] !== 'production' ||\n      process.env['LOG_TO_CONSOLE'] === 'true'\n    ) {\n      transportsAdded = true;\n      this.logger.add(\n        new winston.transports.Console({\n          format: winston.format.printf(\n            ({ label, level, message }) => `[${label}] ${level}: ${message}`,\n          ),\n        }),\n      );\n    }\n\n    if (process.env['LOG_TO_FILE'] === 'true') {\n      transportsAdded = true;\n      this.logger.add(\n        new winston.transports.File({\n          filename: 'error.log',\n          level: LogLevels.error,\n        }),\n      );\n      this.logger.add(\n        new winston.transports.File({ filename: 'combined.log' }),\n      );\n    }\n\n    if (!transportsAdded) {\n      // Always add a transport to prevent memory leaks!\n      this.logger.add(\n        new winston.transports.Console({\n          format: winston.format.printf(\n            ({ label, level, message }) => `[${label}] ${level}: ${message}`,\n          ),\n        }),\n      );\n    }\n  }\n\n  static getInstance(identifier?: string, loglevel?: LogLevels): Logger {\n    if (!Logger.instance) {\n      Logger.instance = new Logger(\n        identifier ?? 'default',\n        Logger.#getLogLevel(loglevel),\n      );\n    }\n    return Logger.instance;\n  }\n\n  setDatadogTransport(context?: {\n    service?: string;\n    env?: string;\n    source?: string;\n    tags?: { [tag: string]: string };\n    apiKey?: string;\n  }): Logger {\n    const apiKey = context?.apiKey ?? process.env['DATADOG_API_KEY'];\n    if (!apiKey) {\n      this.debug('DATADOG_API_KEY is not set, cannot add Datadog transport');\n      return this;\n    }\n\n    const searchParams = new URLSearchParams({\n      'dd-api-key': apiKey,\n      ddsource: context?.source ?? process.env['DD_SOURCE'] ?? 'nodejs',\n      service: context?.service ?? process.env['DD_SERVICE'] ?? 'unknown',\n      env: context?.env ?? process.env['DD_ENV'] ?? 'prod',\n    });\n\n    if (context?.tags) {\n      searchParams.append(\n        'ddtags',\n        Object.entries(context.tags)\n          .map(([key, value]) => `${key}:${value}`)\n          .join(','),\n      );\n    }\n\n    const httpTransportOptions: winston.transports.HttpTransportOptions = {\n      host: `http-intake.logs.${process.env['DD_SITE'] ?? 'datadoghq.eu'}`,\n      path: `/api/v2/logs?${searchParams.toString()}`,\n      ssl: true,\n      batch: true,\n      format: winston.format.json(),\n      level: LogLevels.info,\n    };\n\n    if (this.#datadogTransport) {\n      this.logger.remove(this.#datadogTransport);\n    }\n\n    this.#datadogTransport = new winston.transports.Http(httpTransportOptions);\n    this.logger.add(this.#datadogTransport);\n\n    return this;\n  }\n\n  info(...args: Array<unknown>): void {\n    this.#logFunction(this.logger.info, ...args);\n  }\n\n  debug(...args: Array<unknown>): void {\n    this.#logFunction(this.logger.debug, ...args);\n  }\n\n  error(...args: Array<unknown>): void {\n    this.#logFunction(this.logger.error, ...args);\n  }\n\n  warn(...args: Array<unknown>): void {\n    this.#logFunction(this.logger.warn, ...args);\n  }\n\n  verbose(...args: Array<unknown>): void {\n    this.#logFunction(this.logger.verbose, ...args);\n  }\n\n  #logFunction(\n    func: (message: string, ...meta: Array<unknown>) => unknown,\n    ...meta: Array<unknown>\n  ): void {\n    try {\n      const message = meta.map((param) =>\n        typeof param === 'object' ? JSON.stringify(param) : String(param),\n      );\n      func(message.join(' '), ...meta);\n    } catch (error) {\n      // eslint-disable-next-line no-console\n      console.error('unknown error in log, function', error);\n    }\n  }\n\n  static #getLogLevel = (givenLevel?: LogLevels): LogLevels => {\n    if (givenLevel !== undefined) {\n      return givenLevel;\n    }\n\n    let logLevel = (process.env['LOG_LEVEL'] as LogLevels) || LogLevels.info;\n    const validLogLevels = Object.values(LogLevels);\n    const faultyLogLevel = !validLogLevels.includes(logLevel);\n\n    if (faultyLogLevel) {\n      logLevel = LogLevels.info;\n    }\n\n    if (faultyLogLevel) {\n      // Console since the logger is not yet setup\n      // eslint-disable-next-line no-console\n      console.error(\n        `Invalid log level: ${logLevel} only allow; 'error', 'warn', 'info', 'debug', 'trace'. Using info as default.`,\n      );\n    }\n\n    return logLevel;\n  };\n}\n"],
  "mappings": "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",
  "names": ["LogLevels", "process"]
}
