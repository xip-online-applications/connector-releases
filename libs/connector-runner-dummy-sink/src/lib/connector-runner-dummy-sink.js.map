{
  "version": 3,
  "sources": ["../../../../../../../libs/connector-runner-dummy-sink/src/lib/connector-runner-dummy-sink.ts"],
  "sourcesContent": ["import { ConnectorRuntime } from '@transai/connector-runtime';\nimport {\n  ActionInterface,\n  KafkaCallbackResponse,\n  XodActionType,\n  XodBaseMessageType,\n  XodJobType,\n} from '@xip-online-data/types';\nimport {\n  BadRequest,\n  InternalServerError,\n  Ok\n} from '@xip-online-data/kafka-base-service';\nimport { Logger } from '@transai/logger';\n\nexport class ConnectorRunnerDummySink extends ConnectorRuntime<{\n  failProbability?: number;\n}> {\n  readonly CONNECTOR_INSTANCE: string = 'XOD_CONNECTOR_DUMMY_SINK_CONFIG';\n\n  override init = async (): Promise<void> => {\n    const failProbability = this.config.failProbability || 0.0;\n    if (failProbability > 0) {\n      Logger.getInstance().debug('Fail probability set to', failProbability);\n    }\n\n    const dummyProcessFailed = () => {\n      return Math.random() < failProbability;\n    };\n\n    const jobCallbackFunction = (\n      callbackFunction: (\n        message: XodBaseMessageType,\n      ) => Promise<KafkaCallbackResponse>,\n    ) => {\n      return async (m: XodBaseMessageType) => {\n        if (m.type !== 'JOB') {\n          return callbackFunction(m);\n        }\n        const message = m as XodJobType;\n        let action: ActionInterface;\n        try {\n          action = this.getActionConfig(message);\n        } catch (error: unknown) {\n          if (error instanceof Error) {\n            return BadRequest(`No action found: ${error.message}`)(message);\n          }\n          return BadRequest('Unknown error occured')(message);\n        }\n\n        Logger.getInstance().info(\n          `Dummy process for job: ${message.eventId}, ${message.actionIdentifier}, version: ${message.actionVersion}. Action: ${action.name}, ${action.version}`,\n        );\n        return callbackFunction(message);\n      };\n    };\n\n    const actionCallbackFunction = (\n      callbackFunction: (\n        message: XodBaseMessageType,\n      ) => Promise<KafkaCallbackResponse>,\n    ) => {\n      return async (m: XodBaseMessageType) => {\n        if (m.type !== 'ACTION') {\n          return callbackFunction(m);\n        }\n\n        const message = m as XodActionType;\n        Logger.getInstance().info(\n          'Received message: ',\n          message.testRun ? '(test run)' : '',\n          message.eventId,\n          message.payload,\n        );\n\n        if (dummyProcessFailed()) {\n          Logger.getInstance().error('Dummy process failed');\n          return InternalServerError('Dummy process failed')(message);\n        }\n\n        return callbackFunction(message);\n      };\n    };\n\n    this.callbackFunction = jobCallbackFunction(\n      actionCallbackFunction(this.emitEventType(Ok())),\n    );\n  };\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,+BAAiC;AAQjC,gCAIO;AACP,oBAAuB;AAEhB,MAAM,iCAAiC,0CAE3C;AAAA,EAFI;AAAA;AAGL,SAAS,qBAA6B;AAEtC,SAAS,OAAO,YAA2B;AACzC,YAAM,kBAAkB,KAAK,OAAO,mBAAmB;AACvD,UAAI,kBAAkB,GAAG;AACvB,6BAAO,YAAY,EAAE,MAAM,2BAA2B,eAAe;AAAA,MACvE;AAEA,YAAM,qBAAqB,MAAM;AAC/B,eAAO,KAAK,OAAO,IAAI;AAAA,MACzB;AAEA,YAAM,sBAAsB,CAC1B,qBAGG;AACH,eAAO,OAAO,MAA0B;AACtC,cAAI,EAAE,SAAS,OAAO;AACpB,mBAAO,iBAAiB,CAAC;AAAA,UAC3B;AACA,gBAAM,UAAU;AAChB,cAAI;AACJ,cAAI;AACF,qBAAS,KAAK,gBAAgB,OAAO;AAAA,UACvC,SAAS,OAAgB;AACvB,gBAAI,iBAAiB,OAAO;AAC1B,yBAAO,sCAAW,oBAAoB,MAAM,OAAO,EAAE,EAAE,OAAO;AAAA,YAChE;AACA,uBAAO,sCAAW,uBAAuB,EAAE,OAAO;AAAA,UACpD;AAEA,+BAAO,YAAY,EAAE;AAAA,YACnB,0BAA0B,QAAQ,OAAO,KAAK,QAAQ,gBAAgB,cAAc,QAAQ,aAAa,aAAa,OAAO,IAAI,KAAK,OAAO,OAAO;AAAA,UACtJ;AACA,iBAAO,iBAAiB,OAAO;AAAA,QACjC;AAAA,MACF;AAEA,YAAM,yBAAyB,CAC7B,qBAGG;AACH,eAAO,OAAO,MAA0B;AACtC,cAAI,EAAE,SAAS,UAAU;AACvB,mBAAO,iBAAiB,CAAC;AAAA,UAC3B;AAEA,gBAAM,UAAU;AAChB,+BAAO,YAAY,EAAE;AAAA,YACnB;AAAA,YACA,QAAQ,UAAU,eAAe;AAAA,YACjC,QAAQ;AAAA,YACR,QAAQ;AAAA,UACV;AAEA,cAAI,mBAAmB,GAAG;AACxB,iCAAO,YAAY,EAAE,MAAM,sBAAsB;AACjD,uBAAO,+CAAoB,sBAAsB,EAAE,OAAO;AAAA,UAC5D;AAEA,iBAAO,iBAAiB,OAAO;AAAA,QACjC;AAAA,MACF;AAEA,WAAK,mBAAmB;AAAA,QACtB,uBAAuB,KAAK,kBAAc,8BAAG,CAAC,CAAC;AAAA,MACjD;AAAA,IACF;AAAA;AACF;",
  "names": []
}
