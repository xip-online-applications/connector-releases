{
  "version": 3,
  "sources": ["../../../../../../../libs/connector-runner-mail-sink/src/lib/connector-runner-mail-sink.ts"],
  "sourcesContent": ["import { ConnectorRuntime } from '@transai/connector-runtime';\nimport {\n  ActionInterface,\n  BaseConnectorConfig,\n  ConnectorInterface,\n  KafkaCallbackResponse,\n  XodActionType,\n  XodBaseMessageType,\n  XodJobType,\n} from '@xip-online-data/types';\nimport {\n  BadRequest,\n  Created,\n  InternalServerError,\n} from '@xip-online-data/kafka-base-service';\nimport { Logger } from '@transai/logger';\nimport { MailSinkConfig } from './types';\nimport { MailClient } from '../../../mail-client/src';\n\nexport class ConnectorRunnerMailSink extends ConnectorRuntime<MailSinkConfig> {\n  readonly CONNECTOR_INSTANCE: string = 'XOD_CONNECTOR_MAIL_SINK_CONFIG';\n\n  private mailClientInstance: MailClient | undefined;\n\n  constructor(\n    connector: ConnectorInterface,\n    mailSinkConfig: MailSinkConfig & BaseConnectorConfig,\n    actionConfigs: Array<ActionInterface>,\n    readonly injectedMailClientInstance?: MailClient,\n  ) {\n    super(connector, mailSinkConfig, actionConfigs);\n    this.mailClientInstance = injectedMailClientInstance;\n  }\n\n  override init = async (): Promise<void> => {\n    if (this.mailClientInstance === undefined) {\n      this.mailClientInstance = new MailClient(this.config.mailConfig);\n    }\n\n    const jobCallbackFunction = (\n      callbackFunction: (\n        message: XodBaseMessageType,\n      ) => Promise<KafkaCallbackResponse>,\n    ) => {\n      return async (m: XodBaseMessageType) => {\n        if (m.type !== 'JOB') {\n          return callbackFunction(m);\n        }\n\n        const message = m as XodJobType;\n        let action: ActionInterface;\n        try {\n          action = this.getActionConfig(message);\n        } catch (error: unknown) {\n          if (error instanceof Error) {\n            return BadRequest(`No action found: ${error.message}`)(message);\n          }\n          return BadRequest('Unknown error occured')(message);\n        }\n\n        try {\n          const handleBars = action.config['parsedTemplates'] as {\n            url: HandlebarsTemplateDelegate<unknown>;\n            body: HandlebarsTemplateDelegate<unknown>;\n          };\n\n          const parsedUrl = handleBars\n            .url({\n              inputs: message.payload,\n            })\n            .trim();\n\n          const parsedBody = handleBars\n            .body({\n              inputs: message.payload,\n            })\n            .trim();\n\n          if (message.testRun) {\n            Logger.getInstance().info(\n              `Test run for ${message.eventId} with payload ${parsedBody} to path ${parsedUrl}`,\n            );\n            return callbackFunction(message);\n          }\n\n          const parsedBodyJson = JSON.parse(parsedBody);\n\n          switch (parsedBodyJson.actionType) {\n            case 'REPLY':\n              this.mailClientInstance.reply(\n                parsedBodyJson.from,\n                parsedBodyJson.Malbox,\n                parsedBodyJson.messageId,\n                parsedBodyJson.mailBody,\n                true,\n              );\n              break;\n            case 'FORWARD':\n              // this.mailClientInstance.forward(parsedBody);\n              break;\n            case 'SEND':\n              // this.mailClientInstance.send(parsedBody);\n              break;\n            case 'TAG_ADD':\n              break;\n            case 'TAG_REMOVE':\n              break;\n            default:\n              throw new Error(\n                `Unknown action type: ${parsedBodyJson.actionType}`,\n              );\n          }\n\n          const result = { success: true, data: 'Not implemented yet' };\n\n          if (result.success) {\n            return callbackFunction(message);\n          }\n          return InternalServerError(result.data)(message);\n        } catch (error: unknown) {\n          if (error instanceof Error) {\n            return InternalServerError(error.message)(message);\n          }\n          return InternalServerError('Unknown error occured')(message);\n        }\n      };\n    };\n\n    const actionCallbackFunction = (\n      callbackFunction: (\n        message: XodBaseMessageType,\n      ) => Promise<KafkaCallbackResponse>,\n    ) => {\n      return async (m: XodBaseMessageType) => {\n        if (m.type !== 'ACTION') {\n          return callbackFunction(m);\n        }\n\n        const message = m as XodActionType;\n        try {\n          if (!message.payload.destination || !message.payload.content) {\n            return BadRequest('Destination or content not found')(message);\n          }\n\n          // her comes the action handling logic\n          const result = { success: true, data: 'Not implemented yet' };\n\n          if (result.success) {\n            return callbackFunction(message);\n          }\n          return InternalServerError(result.data)(message);\n        } catch (error) {\n          if (error instanceof Error) {\n            return InternalServerError(error.message)(message);\n          }\n          return InternalServerError('Unknown error occurred')(message);\n        }\n      };\n    };\n\n    this.callbackFunction = jobCallbackFunction(\n      actionCallbackFunction(this.emitEventType(Created())),\n    );\n  };\n}\n"],
  "mappings": "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",
  "names": []
}
