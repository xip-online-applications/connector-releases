{
  "version": 3,
  "sources": ["../../../../../../../../libs/connector-runtime/src/lib/offset-store/cloud-offset-store.service.ts"],
  "sourcesContent": ["import * as process from 'node:process';\n\nimport {\n  OffsetStore,\n  PersistentOffsetStoreInterface,\n} from '@transai/connector-runtime';\nimport { Logger } from '@transai/logger';\nimport { ConnectorApiClient } from '@transai/management-api-client';\nimport { BaseConnectorConfig, OffsetInterface } from '@xip-online-data/types';\nimport { catchError, from, interval, mergeMap, of } from 'rxjs';\n\nimport { OffsetStoreService } from './offset-store.service';\n\nexport class CloudOffsetStoreService implements PersistentOffsetStoreInterface {\n  readonly #managementApiClient = new ConnectorApiClient();\n\n  readonly #log = Logger.getInstance();\n\n  readonly #connectorIdentifier: string;\n\n  readonly #offsetStore: OffsetStoreService;\n\n  #initialized = false;\n\n  constructor(\n    offsetDirectory: string,\n    connectorConfig: BaseConnectorConfig,\n    connectorIdentifier: string,\n  ) {\n    this.#offsetStore = new OffsetStoreService(\n      offsetDirectory,\n      connectorConfig,\n    );\n    this.#connectorIdentifier = connectorIdentifier;\n  }\n\n  public async init(): Promise<void> {\n    await this.#offsetStore.init();\n    await this.#initializeOffsets();\n    this.#startSyncInterval();\n  }\n\n  public async deInit(): Promise<void> {\n    await this.#offsetStore.deInit();\n    this.#syncOffsets()\n      .then(() => {\n        this.#log.debug('Successfully synced offsets.');\n      })\n      .catch((error) => {\n        this.#log.error('Error syncing offsets.', error);\n      });\n  }\n\n  public getOffset(identifier: string): Promise<OffsetStore> {\n    return this.#offsetStore.getOffset(identifier);\n  }\n\n  public writeFile(\n    fileName: string,\n    data: { [key: string]: string },\n  ): Promise<void> {\n    return this.#offsetStore.writeFile(fileName, data);\n  }\n\n  public setOffset(offset: OffsetStore, identifier: string): void {\n    this.#offsetStore.setOffset(offset, identifier);\n  }\n\n  async #initializeOffsets(): Promise<void> {\n    this.#log.verbose(`Initializing offset for ${this.#connectorIdentifier}`);\n    await this.#initOffsetsFromCloud();\n\n    if (!this.#initialized) {\n      await new Promise((resolve) => {\n        setTimeout(resolve, 5000);\n      });\n      return this.#initializeOffsets();\n    }\n\n    this.#log.debug(\n      `Initializing offset successfully for ${this.#connectorIdentifier}`,\n    );\n\n    return Promise.resolve();\n  }\n\n  #startSyncInterval(): void {\n    interval(\n      Number(process.env['MANAGEMENT_API_OFFSET_SYNC_INTERVAL'] ?? 60 * 1000),\n    )\n      .pipe(\n        mergeMap(() => from(this.#syncAllOffsets())),\n        catchError((error) => {\n          this.#log.error('Error syncing offsets:', error);\n          return of(null);\n        }),\n      )\n      .subscribe((v) => {\n        if (v !== null) this.#log.verbose('Offsets sync completed.');\n      });\n  }\n\n  async #syncAllOffsets(): Promise<void> {\n    await this.#updateUserOverruledOffsets();\n    await this.#syncOffsets();\n  }\n\n  async #syncOffsets(): Promise<void> {\n    try {\n      const offsetsValues = this.#offsetStore.offsetValues;\n\n      if (offsetsValues.length === 0) {\n        this.#log.debug('No offsets to sync.');\n        return;\n      }\n\n      const offsets = await Promise.all(\n        offsetsValues.map(async (o: string) => ({\n          identifier: o,\n          offset: await this.#offsetStore.getOffset(o),\n        })),\n      );\n\n      await this.#managementApiClient.writeAllOffsets(\n        this.#connectorIdentifier,\n        offsets,\n      );\n\n      this.#log.debug(\n        `Successfully synced ${offsets.length} offsets for ${this.#connectorIdentifier}.`,\n      );\n    } catch (error) {\n      this.#log.error('Error syncing offsets.', error);\n    }\n  }\n\n  async #updateUserOverruledOffsets(): Promise<void> {\n    try {\n      const offsets = await this.#managementApiClient\n        .getAllOffset(this.#connectorIdentifier)\n        .catch((error) => {\n          this.#log.error('Error loading offsets:', error);\n          return [];\n        });\n\n      const userOverridesOffsets = offsets.filter(\n        (offset) => offset.userOverwrite,\n      );\n\n      if (userOverridesOffsets.length === 0) {\n        this.#log.debug('No user overriding offsets to sync.');\n        return;\n      }\n\n      this.#log.debug(\n        `Successfully synced ${userOverridesOffsets.length} user overriding offsets.`,\n      );\n      this.#log.debug(\n        `Overridden offsets: ${userOverridesOffsets.map((o) => o.identifier).join(', ')}`,\n      );\n\n      userOverridesOffsets.forEach((offset) => {\n        this.#offsetStore.setOffset(offset.offset, offset.identifier);\n      });\n    } catch (error) {\n      this.#log.error('Error caching offsets:', error);\n    }\n  }\n\n  async #initOffsetsFromCloud(): Promise<void> {\n    try {\n      const offsets = await this.#managementApiClient\n        .getAllOffset(this.#connectorIdentifier)\n        .catch((error) => {\n          this.#log.error(`Error loading offsets: ${JSON.stringify(error)}`);\n          return [] as Array<OffsetInterface>;\n        });\n\n      this.#log.debug(`Successfully synced ${offsets.length} offsets.`);\n      this.#log.debug(\n        `Set Cloud offsets: ${offsets.map((o) => o.identifier).join(', ')}`,\n      );\n      this.#offsetStore.initCloudOffsets(offsets);\n      this.#initialized = true;\n    } catch (error) {\n      this.#log.error(`Error caching offsets: ${JSON.stringify(error)}`);\n    }\n  }\n}\n"],
  "mappings": "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",
  "names": []
}
