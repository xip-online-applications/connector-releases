{
  "version": 3,
  "sources": ["../../../../../../../libs/connector-runner-file-copy/src/lib/connector-runner-file-copy.ts"],
  "sourcesContent": ["import { ConnectorRuntime } from '@transai/connector-runtime';\nimport { Logger } from '@transai/logger';\nimport {\n  FileHandlerInterface,\n  FileInfo,\n  FileInfoEnum,\n} from '@xip-online-data/file-system-connector';\nimport {\n  BadRequest,\n  Created,\n  InternalServerError,\n  UnprocessableEntity,\n} from '@xip-online-data/kafka-base-service';\nimport {\n  ActionInterface,\n  BaseConnectorConfig,\n  KafkaCallbackResponse,\n  XodActionType,\n  XodBaseMessageType,\n  XodJobType,\n} from '@xip-online-data/types';\n\nimport { fileHandlerFactory } from './file-handler.factory';\nimport { FileCopyConfig } from './types';\n\nexport class ConnectorRunnerFileCopy extends ConnectorRuntime<\n  FileCopyConfig & BaseConnectorConfig\n> {\n  readonly CONNECTOR_INSTANCE: string = 'XOD_CONNECTOR_FILE_LOCAL_COPY_CONFIG';\n\n  private sourceInstance: FileHandlerInterface | undefined;\n\n  private destinationInstance: FileHandlerInterface | undefined;\n\n  private get source(): FileHandlerInterface {\n    if (!this.sourceInstance) {\n      throw new Error('Source FileHandlerInterface not initialized');\n    }\n    return this.sourceInstance;\n  }\n\n  private get destination(): FileHandlerInterface {\n    if (!this.destinationInstance) {\n      throw new Error('Destination FileHandlerInterface not initialized');\n    }\n    return this.destinationInstance;\n  }\n\n  public readonly transferFunction = async (\n    file: FileInfo,\n    requestedPath: string,\n    sourcePath: string,\n  ): Promise<boolean> => {\n    if (file.type !== FileInfoEnum.FILE) {\n      Logger.getInstance().debug(`${file.name} is not a file. Skipping`);\n      return false;\n    }\n\n    const filePath =\n      sourcePath !== '' ? `${sourcePath}/${file.name}` : file.name;\n    const fileData = await this.source.readFile(filePath);\n    let success = false;\n    try {\n      const desiredDestination =\n        (this.config.destination.remoteDirectory ?? '') === ''\n          ? requestedPath\n          : `${this.config.destination.remoteDirectory}/${requestedPath}`;\n      Logger.getInstance().debug(\n        `Transferring ${file.name} from ${filePath} to ${desiredDestination}`,\n      );\n      success = await this.destination.writeFile(\n        fileData,\n        desiredDestination,\n        file.name,\n      );\n      if (!success) {\n        Logger.getInstance().error(\n          `Error while transferring ${file.name} from ${filePath} to ${desiredDestination}`,\n        );\n      }\n\n      if (this.config.source.processedAction === 'move' && success) {\n        const processedFilename =\n          (this.config.source.processedPrefix ?? '') === ''\n            ? file.name\n            : `${this.config.source.processedPrefix}_${file.name}`;\n        success = await this.source.writeFile(\n          fileData,\n          this.config.source.processedDirectory!,\n          processedFilename,\n        );\n      }\n      if (success) {\n        success = await this.source.deleteFile(filePath);\n      }\n    } catch (error: unknown) {\n      if (error instanceof Error) {\n        Logger.getInstance().error(\n          `Error while transferring ${file.name} from ${filePath} to ${requestedPath}: ${error.message}`,\n        );\n      } else {\n        Logger.getInstance().error(\n          `Unknown error while transferring ${file.name} from ${filePath} to ${requestedPath}`,\n        );\n      }\n    } finally {\n      fileData.close();\n    }\n\n    return success;\n  };\n\n  public readonly copyFunction = async (\n    fileRegex: string,\n    sourcePath: string,\n    destinationPath: string,\n    testRun = false,\n  ) => {\n    Logger.getInstance().debug(\n      `Checking for files in ${sourcePath} with regex ${fileRegex}`,\n    );\n    const list = await this.source.list(sourcePath);\n\n    const directories = list\n      .filter((entity) => entity.type === FileInfoEnum.DIRECTORY)\n      .filter((directory) => {\n        if ((this.config.source.processedDirectory ?? '') === '') {\n          return true;\n        }\n\n        const fullPath =\n          sourcePath === ''\n            ? directory.name\n            : `${sourcePath}/${directory.name}`;\n        const processedDirectory =\n          (this.config.source.remoteDirectory ?? '') === ''\n            ? this.config.source.processedDirectory\n            : `${this.config.source.remoteDirectory}/${this.config.source.processedDirectory}`;\n        return fullPath !== processedDirectory;\n      });\n\n    const allFiles = list.filter((entity) => entity.type === FileInfoEnum.FILE);\n    const regex = new RegExp(fileRegex, 'gi');\n    const files = allFiles.filter((file) => {\n      const fullPath =\n        sourcePath === '' ? file.name : `${sourcePath}/${file.name}`;\n      return fullPath.match(regex) !== null;\n    });\n\n    if (files.length !== 0) {\n      Logger.getInstance().debug(\n        `Found ${files.length} to transfer in ${sourcePath}`,\n      );\n      Logger.getInstance().debug(files.map((file) => file.name).join(', '));\n    }\n\n    // eslint-disable-next-line no-restricted-syntax\n    for (const file of files) {\n      if (!testRun) {\n        // eslint-disable-next-line no-await-in-loop\n        await this.transferFunction(file, destinationPath, sourcePath);\n      } else {\n        Logger.getInstance().info(\n          `Test run: Would have transferred ${file.name} from ${sourcePath} to ${destinationPath}. NOTHING DONE DUE TO TESTRUN!`,\n        );\n      }\n    }\n\n    // eslint-disable-next-line no-restricted-syntax\n    for (const directory of directories) {\n      const newDir =\n        sourcePath === '' ? directory.name : `${sourcePath}/${directory.name}`;\n      if (newDir !== this.config.destination.remoteDirectory) {\n        return;\n      }\n\n      // eslint-disable-next-line no-await-in-loop\n      await this.copyFunction(\n        fileRegex,\n        `${sourcePath}/${directory.name}`,\n        destinationPath,\n        testRun,\n      );\n    }\n  };\n\n  override init = async (): Promise<void> => {\n    this.sourceInstance = fileHandlerFactory(this.config.source);\n    this.destinationInstance = fileHandlerFactory(this.config.destination);\n\n    await this.source.init();\n    await this.destination.init();\n\n    const jobCallbackFunction = (\n      callbackFunction: (\n        message: XodBaseMessageType,\n      ) => Promise<KafkaCallbackResponse>,\n    ) => {\n      return async (m: XodBaseMessageType) => {\n        if (m.type !== 'JOB') {\n          return callbackFunction(m);\n        }\n\n        const message = m as XodJobType;\n        let action: ActionInterface;\n        try {\n          action = this.getActionConfig(message);\n        } catch (error: unknown) {\n          if (error instanceof Error) {\n            return BadRequest(`No action found: ${error.message}`)(message);\n          }\n          return BadRequest('Unknown error occured')(message);\n        }\n\n        try {\n          const handleBars = action.config['parsedTemplates'] as {\n            localPath: HandlebarsTemplateDelegate<unknown>;\n            remotePath: HandlebarsTemplateDelegate<unknown>;\n            fileRegex: HandlebarsTemplateDelegate<unknown>;\n          };\n\n          const parsedLocalPath = handleBars\n            .localPath({\n              inputs: message.payload,\n            })\n            .trim();\n\n          const parsedRemotePath = handleBars\n            .remotePath({\n              inputs: message.payload,\n            })\n            .trim();\n\n          const parsedFileRegex = handleBars\n            .fileRegex({\n              inputs: message.payload,\n            })\n            .trim();\n\n          if (message.testRun) {\n            Logger.getInstance().info(\n              `Test run for ${message.eventId} with parsedLocalPath ${parsedLocalPath}, parsedRemotePath ${parsedRemotePath}, parsedFileRegex ${parsedFileRegex}`,\n            );\n          }\n\n          await this.copyFunction(\n            parsedFileRegex,\n            parsedLocalPath,\n            parsedRemotePath,\n            message.testRun,\n          );\n\n          return callbackFunction(m);\n        } catch (error: unknown) {\n          if (error instanceof Error) {\n            return InternalServerError(error.message)(message);\n          }\n\n          return InternalServerError('Unknown Error')(message);\n        }\n      };\n    };\n\n    const actionCallbackFunction = (\n      callbackFunction: (\n        message: XodBaseMessageType,\n      ) => Promise<KafkaCallbackResponse>,\n    ) => {\n      return async (m: XodBaseMessageType) => {\n        if (m.type !== 'ACTION') {\n          return callbackFunction(m);\n        }\n\n        const message = m as XodActionType;\n        try {\n          if (\n            message.payload.content === undefined ||\n            message.payload.destination === undefined\n          ) {\n            return UnprocessableEntity('Content or destination not provided')(\n              message,\n            );\n          }\n          await this.copyFunction(\n            message.payload.content.trim(),\n            this.config.source.remoteDirectory ?? '',\n            message.payload.destination,\n          );\n          return callbackFunction(message);\n        } catch (error: unknown) {\n          if (error instanceof Error) {\n            return InternalServerError(error.message)(message);\n          }\n\n          return InternalServerError('Unknown Error')(message);\n        }\n      };\n    };\n\n    this.callbackFunction = jobCallbackFunction(\n      actionCallbackFunction(this.emitEventType(Created())),\n    );\n  };\n}\n"],
  "mappings": "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",
  "names": []
}
