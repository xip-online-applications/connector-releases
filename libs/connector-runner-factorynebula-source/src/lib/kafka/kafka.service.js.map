{
  "version": 3,
  "sources": ["../../../../../../../../libs/connector-runner-factorynebula-source/src/lib/kafka/kafka.service.ts"],
  "sourcesContent": ["import { XodSourceMessageType } from '@xip-online-data/types';\nimport { KafkaSourceInterface } from '@xip-online-data/kafka-base-service';\nimport { v4 as uuidv4 } from 'uuid';\nimport { Logger } from '@transai/logger';\nimport {\n  generateCollectionName,\n  generateKafkaTopic,\n} from '../helper.functions';\nimport { ApiConfig, ApiSourceConfig } from '../types';\n\nconst getMetadataFromObject = (\n  obj: object,\n  metadata: { [key: string]: string },\n): object => {\n  try {\n    return Object.keys(metadata).reduce((acc, key) => {\n      const requiredVal = metadata[key];\n      // @ts-ignore\n      if (obj[requiredVal]) {\n        // @ts-ignore\n        acc[key] = obj[requiredVal];\n      }\n      return acc;\n    }, {});\n  } catch (e) {\n    Logger.getInstance().debug(\n      'Error while getting metadata from object',\n      e,\n      obj,\n      metadata,\n    );\n    return {};\n  }\n};\n\nexport class KafkaService {\n  constructor(private readonly kafkaSourceService: KafkaSourceInterface) {}\n\n  public async sendDocuments(\n    records: Array<any>,\n    config: ApiSourceConfig,\n    apiConfig: ApiConfig,\n    metadata: object = {},\n  ): Promise<boolean> {\n    const kafkaPayload: Array<XodSourceMessageType> = records.map((record) => {\n      const additionalMetadata = getMetadataFromObject(\n        record,\n        apiConfig.metadata ?? {},\n      );\n      return {\n        type: 'SOURCE' as const,\n        eventId: uuidv4(),\n        eventType: 'event.source-sink.kafka',\n        created: Date.now(),\n        ttl: 3600000, // 1 month\n        tenantIdentifier: config.tenantIdentifier,\n        payload: {\n          keyField: apiConfig.keyField,\n          incrementalField: apiConfig.incrementalField,\n          collection: generateCollectionName(config, apiConfig),\n          body: record,\n          metadata: {\n            ...metadata,\n            ...additionalMetadata,\n          },\n        },\n      };\n    });\n\n    const topic = generateKafkaTopic(config);\n\n    return this.kafkaSourceService.send(kafkaPayload, topic);\n  }\n\n  public async sendTooldataToKafka(\n    records: Array<{\n      value: {\n        [key: string]: number | string;\n      };\n      metadata: {\n        [key: string]: string;\n      };\n    }>,\n    config: ApiSourceConfig,\n    apiConfig: ApiConfig,\n  ): Promise<boolean> {\n    const kafkaPayload: Array<XodSourceMessageType> = records.map((body) => {\n      const additionalMetadata = getMetadataFromObject(\n        body.value,\n        apiConfig.metadata ?? {},\n      );\n      return {\n        type: 'SOURCE',\n        eventId: uuidv4(),\n        eventType: 'event.metric',\n        created: Date.now(),\n        ttl: -1,\n        tenantIdentifier: config.tenantIdentifier,\n        payload: {\n          body: body.value,\n          metadata: {\n            ...body.metadata,\n            ...additionalMetadata,\n          },\n        },\n      };\n    });\n\n    const topic = generateKafkaTopic(config);\n    return this.kafkaSourceService.send(kafkaPayload, topic);\n  }\n\n  public async sendMetric(\n    records: Array<any>,\n    config: ApiSourceConfig,\n    apiConfig: ApiConfig,\n    metadata: object = {},\n  ): Promise<boolean> {\n    const kafkaPayload: Array<XodSourceMessageType> = records.map((body) => {\n      const additionalMetadata = getMetadataFromObject(\n        body,\n        apiConfig.metadata ?? {},\n      );\n      return {\n        type: 'SOURCE',\n        eventId: uuidv4(),\n        eventType: 'event.metric',\n        created: Date.now(),\n        ttl: -1,\n        tenantIdentifier: config.tenantIdentifier,\n        payload: {\n          body,\n          metadata: {\n            ...metadata,\n            ...additionalMetadata,\n          },\n        },\n      };\n    });\n\n    const topic = generateKafkaTopic(config);\n    return this.kafkaSourceService.send(kafkaPayload, topic);\n  }\n}\n"],
  "mappings": "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",
  "names": ["uuidv4"]
}
