{
  "version": 3,
  "sources": ["../../../../../../../libs/connector-runner-factorynebula-source/src/lib/api-result.handler.ts"],
  "sourcesContent": ["import { AxiosResponse } from 'axios';\nimport { decode } from 'html-entities';\nimport { PersistentOffsetStoreInterface } from '@transai/connector-runtime';\nimport { Logger } from '@transai/logger';\nimport { ApiConfig, ApiSourceConfig } from './types';\nimport { KafkaService } from './kafka/kafka.service';\n\nexport class ApiResultHandler {\n  readonly #config: ApiSourceConfig;\n\n  readonly #kafkaService: KafkaService;\n\n  readonly #offsetStore: PersistentOffsetStoreInterface;\n\n  constructor(\n    config: ApiSourceConfig,\n    kafkaService: KafkaService,\n    offsetStore: PersistentOffsetStoreInterface,\n  ) {\n    this.#config = config;\n    this.#kafkaService = kafkaService;\n    this.#offsetStore = offsetStore;\n  }\n\n  public async handleResult(\n    result: AxiosResponse,\n    apiConfig: ApiConfig,\n  ): Promise<void> {\n    const parsedContent = JSON.parse(decode(result.data));\n    const keys = Object.keys(parsedContent);\n\n    if (keys.length === 0) {\n      return;\n    }\n\n    await this.handlePayload(result, keys[0], apiConfig);\n  }\n\n  private async handlePayload(\n    result: AxiosResponse,\n    key: string,\n    apiConfig: ApiConfig,\n  ) {\n    const parsedContent = JSON.parse(decode(result.data))[key];\n\n    if (parsedContent.origin === 'Tooldata') {\n      await this.handleTooldata(parsedContent, apiConfig);\n    } else {\n      await this.handleOthers(parsedContent, apiConfig);\n    }\n  }\n\n  private async handleTooldata(parsedContent: any, apiConfig: ApiConfig) {\n    const values: object = parsedContent.data?.values;\n\n    if (!values) {\n      Logger.getInstance().debug('No values found in Tooldata message.');\n      return;\n    }\n\n    const toolData = Object.entries(values).map(\n      ([key, value]: [\n        string,\n        {\n          [key: string]: number | string;\n        },\n      ]) => {\n        if (value['T Number'] !== 0) {\n          const metadata = {\n            machine: apiConfig.name,\n            location: parsedContent.location,\n            origin: parsedContent.origin,\n            potKey: key,\n          };\n\n          return {\n            value,\n            metadata,\n          };\n        }\n\n        return undefined;\n      },\n    );\n\n    const success = await this.#kafkaService.sendTooldataToKafka(\n      toolData.filter((t) => t !== undefined),\n      this.#config,\n      apiConfig,\n    );\n\n    if (!success) {\n      Logger.getInstance().debug(\n        'Error while sending tool record to Kafka: ',\n        values,\n      );\n    }\n  }\n\n  private async handleOthers(parsedContent: any, apiConfig: ApiConfig) {\n    const metadata = {\n      machine: apiConfig.name,\n      location: parsedContent.location,\n      origin: parsedContent.origin,\n    };\n\n    const success = await this.#kafkaService.sendMetric(\n      [parsedContent.data],\n      this.#config,\n      apiConfig,\n      metadata,\n    );\n\n    if (!success) {\n      Logger.getInstance().debug(\n        'Error while sending other record to Kafka: ',\n        parsedContent.data,\n      );\n    }\n  }\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AACA,2BAAuB;AAEvB,oBAAuB;AAIhB,MAAM,iBAAiB;AAAA,EACnB;AAAA,EAEA;AAAA,EAEA;AAAA,EAET,YACE,QACA,cACA,aACA;AACA,SAAK,UAAU;AACf,SAAK,gBAAgB;AACrB,SAAK,eAAe;AAAA,EACtB;AAAA,EAEA,MAAa,aACX,QACA,WACe;AACf,UAAM,gBAAgB,KAAK,UAAM,6BAAO,OAAO,IAAI,CAAC;AACpD,UAAM,OAAO,OAAO,KAAK,aAAa;AAEtC,QAAI,KAAK,WAAW,GAAG;AACrB;AAAA,IACF;AAEA,UAAM,KAAK,cAAc,QAAQ,KAAK,CAAC,GAAG,SAAS;AAAA,EACrD;AAAA,EAEA,MAAc,cACZ,QACA,KACA,WACA;AACA,UAAM,gBAAgB,KAAK,UAAM,6BAAO,OAAO,IAAI,CAAC,EAAE,GAAG;AAEzD,QAAI,cAAc,WAAW,YAAY;AACvC,YAAM,KAAK,eAAe,eAAe,SAAS;AAAA,IACpD,OAAO;AACL,YAAM,KAAK,aAAa,eAAe,SAAS;AAAA,IAClD;AAAA,EACF;AAAA,EAEA,MAAc,eAAe,eAAoB,WAAsB;AACrE,UAAM,SAAiB,cAAc,MAAM;AAE3C,QAAI,CAAC,QAAQ;AACX,2BAAO,YAAY,EAAE,MAAM,sCAAsC;AACjE;AAAA,IACF;AAEA,UAAM,WAAW,OAAO,QAAQ,MAAM,EAAE;AAAA,MACtC,CAAC,CAAC,KAAK,KAAK,MAKN;AACJ,YAAI,MAAM,UAAU,MAAM,GAAG;AAC3B,gBAAM,WAAW;AAAA,YACf,SAAS,UAAU;AAAA,YACnB,UAAU,cAAc;AAAA,YACxB,QAAQ,cAAc;AAAA,YACtB,QAAQ;AAAA,UACV;AAEA,iBAAO;AAAA,YACL;AAAA,YACA;AAAA,UACF;AAAA,QACF;AAEA,eAAO;AAAA,MACT;AAAA,IACF;AAEA,UAAM,UAAU,MAAM,KAAK,cAAc;AAAA,MACvC,SAAS,OAAO,CAAC,MAAM,MAAM,MAAS;AAAA,MACtC,KAAK;AAAA,MACL;AAAA,IACF;AAEA,QAAI,CAAC,SAAS;AACZ,2BAAO,YAAY,EAAE;AAAA,QACnB;AAAA,QACA;AAAA,MACF;AAAA,IACF;AAAA,EACF;AAAA,EAEA,MAAc,aAAa,eAAoB,WAAsB;AACnE,UAAM,WAAW;AAAA,MACf,SAAS,UAAU;AAAA,MACnB,UAAU,cAAc;AAAA,MACxB,QAAQ,cAAc;AAAA,IACxB;AAEA,UAAM,UAAU,MAAM,KAAK,cAAc;AAAA,MACvC,CAAC,cAAc,IAAI;AAAA,MACnB,KAAK;AAAA,MACL;AAAA,MACA;AAAA,IACF;AAEA,QAAI,CAAC,SAAS;AACZ,2BAAO,YAAY,EAAE;AAAA,QACnB;AAAA,QACA,cAAc;AAAA,MAChB;AAAA,IACF;AAAA,EACF;AACF;",
  "names": []
}
