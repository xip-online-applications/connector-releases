{
  "version": 3,
  "sources": ["../../../../../../../libs/connector-runner-cube-query/src/lib/connector-runner-cube-query.ts"],
  "sourcesContent": ["import cube, { CubeApi, Query } from '@cubejs-client/core';\nimport {\n  ConnectorRuntimeSDK,\n  ConnectorSDKInterface,\n  LoggerSDKInterface,\n} from '@transai/connector-runtime-sdk';\nimport {\n  parseCubeResultToObjects,\n  replacePlaceholdersInConfig,\n} from '@xip-online-data/helper-functions';\nimport { HttpServiceBuilder } from '@xip-online-data/httpclient';\nimport { BadRequest } from '@xip-online-data/kafka-base-service';\nimport {\n  ActionInterface,\n  ConnectorInterface,\n  KafkaCallbackResponse,\n  XodJobType,\n} from '@xip-online-data/types';\n\nimport { CubeQueryRunnerConfig } from './types';\n\nexport class ConnectorRunnerCubeQuery extends ConnectorRuntimeSDK<CubeQueryRunnerConfig> {\n  readonly #logger: LoggerSDKInterface;\n\n  constructor(\n    connector: ConnectorInterface<CubeQueryRunnerConfig>,\n    connectorSDK: ConnectorSDKInterface,\n  ) {\n    super(connector, connectorSDK);\n    this.#logger = this.connectorSDK.logger;\n  }\n\n  override init = async (): Promise<void> => {\n    const { config } = this.connectorSDK;\n    const { cubeConfig } = config;\n\n    if (\n      !cubeConfig ||\n      !cubeConfig.auth0_token_url ||\n      !cubeConfig.auth0_client_id ||\n      !cubeConfig.auth0_client_secret ||\n      !cubeConfig.auth0_audience\n    ) {\n      throw new Error('Cube config is not valid');\n    }\n\n    const cacheService = HttpServiceBuilder.buildCacheService({});\n    const tokenService = HttpServiceBuilder.buildJwtTokenService(\n      {\n        tokenUrl: cubeConfig.auth0_token_url,\n        clientId: cubeConfig.auth0_client_id,\n        clientSecret: cubeConfig.auth0_client_secret,\n        audience: cubeConfig.auth0_audience,\n        tenantIdentifier: config.tenantIdentifier,\n      },\n      cacheService,\n    );\n\n    const getAuth0CubeJwtToken = async (): Promise<string> => {\n      this.#logger.debug(\n        `Getting Auth0 Cube JWT Token for tenant ${config.tenantIdentifier}`,\n      );\n\n      return tokenService.getToken({\n        tenantIdentifier: config.tenantIdentifier,\n      });\n    };\n\n    const cubeApi: CubeApi = cube(getAuth0CubeJwtToken, {\n      apiUrl: cubeConfig.apiUrl,\n    });\n\n    this.callbackFunction = async (\n      message: XodJobType,\n      action: ActionInterface,\n    ): Promise<KafkaCallbackResponse> => {\n      const config: { query: Query } = action.config as { query: Query };\n      const { payload } = message;\n\n      this.#logger.debug(\n        `Received payload for Cube query: ${JSON.stringify(payload)}`,\n      );\n\n      const payloadKeys = Object.keys(payload);\n\n      if (payload && payloadKeys.length > 0) {\n        const parsedQuery = replacePlaceholdersInConfig(\n          config.query as Record<string, unknown>,\n          payload,\n        );\n        let queryResult;\n        try {\n          queryResult = await cubeApi.load(parsedQuery);\n        } catch (error) {\n          let errorMessage = `Error in query ${JSON.stringify(parsedQuery)}`;\n          if (error instanceof Error) {\n            errorMessage += error.message;\n          }\n          this.#logger.error(errorMessage);\n          return BadRequest(errorMessage)(message);\n        }\n        const result = queryResult.serialize().loadResponse.results;\n\n        this.#logger.info('Cube query executed successfully', result);\n\n        if (result.length > 0) {\n          const response = {\n            ...message,\n            payload: result[0].data.map(parseCubeResultToObjects),\n            meta: {\n              lastRefreshTime: result[0].lastRefreshTime,\n            },\n          };\n\n          return this.connectorSDK.receiver.responses.ok()(response);\n        }\n\n        return this.connectorSDK.receiver.responses.badRequest(\n          'No results found for given query',\n        )({\n          ...message,\n          meta: {\n            query: parsedQuery,\n          },\n        });\n      }\n\n      return this.connectorSDK.receiver.responses.badRequest(\n        'No parameters for query given.',\n      )(message);\n    };\n  };\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,kBAAqC;AACrC,mCAIO;AACP,8BAGO;AACP,wBAAmC;AACnC,gCAA2B;AAUpB,MAAM,iCAAiC,iDAA2C;AAAA,EAGvF,YACE,WACA,cACA;AACA,UAAM,WAAW,YAAY;AAI/B,SAAS,OAAO,YAA2B;AACzC,YAAM,EAAE,OAAO,IAAI,KAAK;AACxB,YAAM,EAAE,WAAW,IAAI;AAEvB,UACE,CAAC,cACD,CAAC,WAAW,mBACZ,CAAC,WAAW,mBACZ,CAAC,WAAW,uBACZ,CAAC,WAAW,gBACZ;AACA,cAAM,IAAI,MAAM,0BAA0B;AAAA,MAC5C;AAEA,YAAM,eAAe,qCAAmB,kBAAkB,CAAC,CAAC;AAC5D,YAAM,eAAe,qCAAmB;AAAA,QACtC;AAAA,UACE,UAAU,WAAW;AAAA,UACrB,UAAU,WAAW;AAAA,UACrB,cAAc,WAAW;AAAA,UACzB,UAAU,WAAW;AAAA,UACrB,kBAAkB,OAAO;AAAA,QAC3B;AAAA,QACA;AAAA,MACF;AAEA,YAAM,uBAAuB,YAA6B;AACxD,aAAK,QAAQ;AAAA,UACX,2CAA2C,OAAO,gBAAgB;AAAA,QACpE;AAEA,eAAO,aAAa,SAAS;AAAA,UAC3B,kBAAkB,OAAO;AAAA,QAC3B,CAAC;AAAA,MACH;AAEA,YAAM,cAAmB,YAAAA,SAAK,sBAAsB;AAAA,QAClD,QAAQ,WAAW;AAAA,MACrB,CAAC;AAED,WAAK,mBAAmB,OACtB,SACA,WACmC;AACnC,cAAMC,UAA2B,OAAO;AACxC,cAAM,EAAE,QAAQ,IAAI;AAEpB,aAAK,QAAQ;AAAA,UACX,oCAAoC,KAAK,UAAU,OAAO,CAAC;AAAA,QAC7D;AAEA,cAAM,cAAc,OAAO,KAAK,OAAO;AAEvC,YAAI,WAAW,YAAY,SAAS,GAAG;AACrC,gBAAM,kBAAc;AAAA,YAClBA,QAAO;AAAA,YACP;AAAA,UACF;AACA,cAAI;AACJ,cAAI;AACF,0BAAc,MAAM,QAAQ,KAAK,WAAW;AAAA,UAC9C,SAAS,OAAO;AACd,gBAAI,eAAe,kBAAkB,KAAK,UAAU,WAAW,CAAC;AAChE,gBAAI,iBAAiB,OAAO;AAC1B,8BAAgB,MAAM;AAAA,YACxB;AACA,iBAAK,QAAQ,MAAM,YAAY;AAC/B,uBAAO,sCAAW,YAAY,EAAE,OAAO;AAAA,UACzC;AACA,gBAAM,SAAS,YAAY,UAAU,EAAE,aAAa;AAEpD,eAAK,QAAQ,KAAK,oCAAoC,MAAM;AAE5D,cAAI,OAAO,SAAS,GAAG;AACrB,kBAAM,WAAW;AAAA,cACf,GAAG;AAAA,cACH,SAAS,OAAO,CAAC,EAAE,KAAK,IAAI,gDAAwB;AAAA,cACpD,MAAM;AAAA,gBACJ,iBAAiB,OAAO,CAAC,EAAE;AAAA,cAC7B;AAAA,YACF;AAEA,mBAAO,KAAK,aAAa,SAAS,UAAU,GAAG,EAAE,QAAQ;AAAA,UAC3D;AAEA,iBAAO,KAAK,aAAa,SAAS,UAAU;AAAA,YAC1C;AAAA,UACF,EAAE;AAAA,YACA,GAAG;AAAA,YACH,MAAM;AAAA,cACJ,OAAO;AAAA,YACT;AAAA,UACF,CAAC;AAAA,QACH;AAEA,eAAO,KAAK,aAAa,SAAS,UAAU;AAAA,UAC1C;AAAA,QACF,EAAE,OAAO;AAAA,MACX;AAAA,IACF;AAtGE,SAAK,UAAU,KAAK,aAAa;AAAA,EACnC;AAAA,EARS;AA8GX;",
  "names": ["cube", "config"]
}
