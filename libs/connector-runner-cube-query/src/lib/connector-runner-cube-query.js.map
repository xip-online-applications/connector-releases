{
  "version": 3,
  "sources": ["../../../../../../../libs/connector-runner-cube-query/src/lib/connector-runner-cube-query.ts"],
  "sourcesContent": ["import { ConnectorRuntime } from '@transai/connector-runtime';\nimport {\n  ActionInterface,\n  KafkaCallbackResponse,\n  XodBaseMessageType,\n  XodJobType,\n} from '@xip-online-data/types';\nimport {\n  BadRequest,\n  InternalServerError,\n  Ok,\n} from '@xip-online-data/kafka-base-service';\nimport cube, { CubeApi, Query } from '@cubejs-client/core';\nimport { HttpServiceBuilder } from '@xip-online-data/httpclient';\nimport {\n  parseCubeResultToObjects,\n  replacePlaceholdersInConfig,\n} from '@xip-online-data/helper-functions';\nimport { CubeQueryRunnerConfig } from './types';\n\nexport class ConnectorRunnerCubeQuery extends ConnectorRuntime<CubeQueryRunnerConfig> {\n  readonly CONNECTOR_INSTANCE: string = 'XOD_CONNECTOR_API_SINK_CONFIG';\n\n  override init = async (): Promise<void> => {\n    if (\n      !this.config.cubeConfig ||\n      !this.config.cubeConfig.auth0_token_url ||\n      !this.config.cubeConfig.auth0_client_id ||\n      !this.config.cubeConfig.auth0_client_secret ||\n      !this.config.cubeConfig.auth0_audience\n    ) {\n      throw new Error('Cube config is not valid');\n    }\n\n    const cacheService = HttpServiceBuilder.buildCacheService({});\n    const tokenService = HttpServiceBuilder.buildJwtTokenService(\n      {\n        tokenUrl: this.config.cubeConfig.auth0_token_url,\n        clientId: this.config.cubeConfig.auth0_client_id,\n        clientSecret: this.config.cubeConfig.auth0_client_secret,\n        audience: this.config.cubeConfig.auth0_audience,\n        tenantIdentifier: this.connector.tenantIdentifier,\n      },\n      cacheService,\n    );\n\n    const getAuth0CubeJwtToken = async (): Promise<string> => {\n      return tokenService.getToken({\n        tenantIdentifier: this.connector.tenantIdentifier,\n      });\n    };\n\n    const cubeApi: CubeApi = cube(getAuth0CubeJwtToken, {\n      apiUrl: this.config.cubeConfig.apiUrl,\n    });\n\n    const mainCallbackFunction = (\n      callbackFunction: (\n        message: XodBaseMessageType,\n      ) => Promise<KafkaCallbackResponse>,\n    ) => {\n      return async (m: XodBaseMessageType) => {\n        if (m.type !== 'JOB') {\n          return BadRequest('Message type is not JOB')(m);\n        }\n\n        const message: XodJobType = m as XodJobType;\n        try {\n          let action: ActionInterface;\n          try {\n            action = this.getActionConfig(message);\n          } catch (error) {\n            if (error instanceof Error) {\n              return BadRequest(`No action found: ${error.message}`)(message);\n            }\n            return BadRequest('Unknown error occured')(message);\n          }\n\n          const config: { query: Query } = action.config as { query: Query };\n          const { payload } = message;\n          const payloadKeys = Object.keys(payload);\n\n          if (payload && payloadKeys.length > 0) {\n            const parsedQuery = replacePlaceholdersInConfig(\n              config.query as Record<string, unknown>,\n              payload,\n            );\n            let queryResult;\n            try {\n              queryResult = await cubeApi.load(parsedQuery);\n            } catch (error) {\n              let errorMessage = `Error in query ${JSON.stringify(parsedQuery)}`;\n              if (error instanceof Error) {\n                errorMessage += error.message;\n              }\n              this.log.error(errorMessage);\n              return BadRequest(errorMessage)(message);\n            }\n            const result = queryResult.serialize().loadResponse.results;\n\n            if (result.length > 0) {\n              const response = {\n                ...message,\n                payload: result[0].data.map(parseCubeResultToObjects),\n                meta: {\n                  lastRefreshTime: result[0].lastRefreshTime,\n                },\n              };\n\n              return callbackFunction(response);\n            }\n            return BadRequest('No results found for given query')({\n              ...message,\n              meta: {\n                query: parsedQuery,\n              },\n            });\n          }\n          return BadRequest('No parameters for query given.')(message);\n        } catch (error) {\n          if (error instanceof Error) {\n            return InternalServerError(error.message)(message);\n          }\n          return InternalServerError('Unknown error occured')(message);\n        }\n      };\n    };\n\n    this.callbackFunction = mainCallbackFunction(this.emitEventType(Ok()));\n  };\n}\n"],
  "mappings": "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",
  "names": ["cube"]
}
