{
  "version": 3,
  "sources": ["../../../../../../../../libs/connector-runner-api-source/src/lib/api-extractor/api-extractor.service.ts"],
  "sourcesContent": ["import { interval, Subscription } from 'rxjs';\nimport {\n  OffsetStore,\n  PersistentOffsetStoreInterface,\n} from '@transai/connector-runtime';\nimport { Logger } from '@transai/logger';\nimport Handlebars from 'handlebars';\nimport helpers from 'handlebars-helpers';\nimport { decode } from 'html-entities';\nimport jsonata from 'jsonata';\nimport { generateOffsetIdentifier } from '../helper.functions';\nimport { ApiResultHandler } from '../api-result.handler';\nimport { ApiConfig, ApiResponseData, ApiSourceConfig } from '../types';\nimport { Api } from '../api/api';\nimport { wrapAsync } from '../../../../helper-functions/src/lib/asyncHelpers';\n\nexport class ApiExtractorService {\n  readonly #api: Api;\n\n  readonly #config: ApiSourceConfig;\n\n  readonly #apiConfig: ApiConfig;\n\n  readonly #apiResultHandler: ApiResultHandler;\n\n  readonly #offsetStore: PersistentOffsetStoreInterface;\n\n  readonly #handlebarsTemplate: HandlebarsTemplateDelegate | undefined;\n\n  readonly #urlTemplate: HandlebarsTemplateDelegate | undefined;\n\n  readonly #urlDetailTemplate: HandlebarsTemplateDelegate | undefined;\n\n  #processing = false;\n\n  readonly #handlebarsInstance: typeof Handlebars | undefined;\n\n  #logger: Logger;\n\n  #subscriptions: Array<Subscription> = [];\n\n  constructor(\n    config: ApiSourceConfig,\n    apiConfig: ApiConfig,\n    api: Api,\n    apiResultHandler: ApiResultHandler,\n    offsetStore: PersistentOffsetStoreInterface,\n  ) {\n    this.#config = config;\n    this.#apiConfig = apiConfig;\n    this.#apiResultHandler = apiResultHandler;\n    this.#offsetStore = offsetStore;\n    this.#api = api;\n\n    if (!apiConfig.url) {\n      throw new Error('URL is not defined in apiConfig');\n    }\n\n    this.#logger = Logger.getInstance();\n    this.#logger.debug(\n      `Api source service initialized: ${this.#apiConfig.name} with interval of ${this.#apiConfig.interval} seconds`,\n    );\n\n    const handlebars = Handlebars.create();\n    this.#handlebarsInstance = wrapAsync(handlebars, true);\n    helpers({ handlebars: this.#handlebarsInstance });\n    this.#handlebarsInstance?.registerHelper(\n      'formatISODate',\n      (timestamp: number) => {\n        const date = new Date(timestamp);\n        return date.toISOString();\n      },\n    );\n    this.#handlebarsInstance.registerHelper(\n      'jsonata',\n      function (exprStr: string) {\n        const expr = jsonata(exprStr);\n        // @ts-ignore\n        return expr.evaluate(this);\n      },\n    );\n    if (apiConfig.body) {\n      this.#handlebarsInstance?.compile(apiConfig.body, {\n        strict: true,\n      });\n      this.validateTemplate();\n    }\n\n    if (apiConfig.detailApiUrl) {\n      this.#urlDetailTemplate = this.#handlebarsInstance?.compile(\n        apiConfig.detailApiUrl,\n        { strict: true },\n      );\n    }\n\n    this.#urlTemplate = this.#handlebarsInstance?.compile(apiConfig.url, {\n      strict: true,\n    });\n\n    this.#logger.debug(\n      'HB instance id',\n      (this.#handlebarsInstance as any).__ASYNC_WRAPPED__,\n      Handlebars.VERSION,\n    );\n    this.#logger.debug(\n      'Has jsonata helper?',\n      typeof (this.#handlebarsInstance as any).helpers?.jsonata,\n    );\n    for (const [name, fn] of Object.entries(Handlebars.helpers)) {\n      this.#logger.debug(name, \"wrapped?\", !!(fn as any).__ASYNC_WRAPPED__);\n    }\n\n    this.#subscriptions.push(\n      interval(this.#apiConfig.interval * 1000).subscribe(async () => {\n        await this.extract();\n      }),\n    );\n  }\n\n  stop() {\n    this.#subscriptions.forEach((subscription) => subscription.unsubscribe());\n  }\n\n  private async extract(): Promise<void> {\n    if (this.#processing) {\n      this.#logger.debug(\n        'Api source service is already processing: ',\n        this.#apiConfig.name,\n      );\n      return;\n    }\n\n    this.#processing = true;\n    try {\n      const latestOffset = await this.#offsetStore.getOffset(\n        generateOffsetIdentifier(this.#apiConfig),\n      );\n      if (this.#config.debug)\n        Logger.getInstance().debug(\n          `Latest offset for ${this.#apiConfig.name}: ${JSON.stringify(latestOffset)}`,\n        );\n      const body = await this.getBody(\n        latestOffset,\n        this.#apiConfig.batchSize ?? 10,\n      );\n      const url = await this.getUrl(\n        latestOffset,\n        this.#apiConfig.batchSize ?? 10,\n      );\n\n      try {\n        const result: ApiResponseData = await this.#api.executeApi(url, body);\n\n        const parsedContent = JSON.parse(decode(result.data));\n\n        if (this.#apiConfig.detailApiUrl) {\n          this.#logger.debug(\n            'Detail API URL is set, fetching details for each item',\n          );\n          const selector = jsonata(this.#apiConfig.listField ?? '');\n          const resultList = await selector.evaluate(parsedContent);\n\n          for (const row of resultList) {\n            const detailUrl = await this.getDetailUrl(row);\n            const detailResult = await this.#api.executeApi(detailUrl);\n\n            await this.#apiResultHandler.handleResult(\n              detailResult,\n              this.#apiConfig,\n            );\n          }\n        } else {\n          await this.#apiResultHandler.handleResult(result, this.#apiConfig);\n        }\n      } catch (error) {\n        this.#logger.debug(error);\n        this.#logger.debug(\n          `Error while extracting data from api source service: ${JSON.stringify(error)}`,\n        );\n      }\n    } catch (error) {\n      Logger.getInstance().debug(JSON.stringify(error));\n    } finally {\n      this.#processing = false;\n    }\n  }\n\n  private async getBody(offset: OffsetStore, limit: number): Promise<string> {\n    if (!this.#handlebarsTemplate) {\n      return '';\n    }\n\n    return this.#handlebarsTemplate({\n      ...offset,\n      limit,\n    });\n  }\n\n  private async getUrl(offset: OffsetStore, limit: number): Promise<string> {\n    if (!this.#urlTemplate) return '';\n\n    const maybe = this.#urlTemplate({ ...offset, limit });\n    this.#logger.debug('template() returned thenable?', !!(maybe as any)?.then);\n\n    const out = await maybe;\n    this.#logger.debug('rendered url (type):', typeof out, out); // expect \"string\" or \"object\" (SafeString)\n\n    return String(out); // normalize SafeString or anything else to a real string\n  }\n\n  private async getDetailUrl(item: any): Promise<string> {\n    if (!this.#urlDetailTemplate) {\n      return '';\n    }\n\n    return this.#urlDetailTemplate({\n      item,\n    });\n  }\n\n  private validateTemplate(): void {\n    this.getBody({ timestamp: 0, id: 0, rawTimestamp: 0 }, 0);\n  }\n}\n"],
  "mappings": "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",
  "names": ["Handlebars", "helpers", "jsonata"]
}
