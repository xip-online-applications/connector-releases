{
  "version": 3,
  "sources": ["../../../../../../../../libs/connector-runner-api-source/src/lib/api/api.ts"],
  "sourcesContent": ["import { Logger } from '@transai/logger';\nimport { makeNodeRequest } from '../helper.functions';\nimport { ApiConfig, ApiResponseData, ApiSourceConfig } from '../types';\nimport { TokenManager } from '../token-manager/token-manager';\nimport { JsessionManager } from '../jsession-manager/jsession-manager';\n\nexport class Api {\n  readonly #config: ApiSourceConfig;\n\n  #logger: Logger;\n\n  #tokenManager: TokenManager | undefined;\n\n  #sessionManager: JsessionManager | undefined;\n\n  constructor(\n    private readonly config: ApiSourceConfig,\n    tokenManager?: TokenManager,\n    sessionManager?: JsessionManager,\n  ) {\n    this.#logger = Logger.getInstance();\n    this.#config = config;\n    this.#tokenManager = tokenManager;\n    this.#sessionManager = sessionManager;\n  }\n\n  public async executeApi(\n    url: string,\n    body = '',\n    method = 'GET',\n    format = 'json',\n  ): Promise<ApiResponseData> {\n    Logger.getInstance().debug(\n      `Executing ${method} request to ${url} with body ${body}`,\n    );\n    const contentType: string = format;\n    const headers: {\n      'Content-Type'?: string;\n      Authorization?: string;\n      Cookie?: string;\n      'X-CustomerID'?: string;\n    } = {};\n    if (contentType && method !== 'GET') {\n      headers['Content-Type'] = contentType;\n    }\n\n    if (this.#tokenManager) {\n      this.#logger.debug('Initialising token manager');\n      const token = await this.#tokenManager.getAccessToken();\n      if (token) {\n        headers['Authorization'] = `Bearer ${token}`;\n      }\n    }\n\n    if (this.#sessionManager) {\n      this.#logger.debug('Initialising session manager');\n      const sessionCookie = await this.#sessionManager.getSessionCooky();\n      if (sessionCookie) {\n        headers['Cookie'] = sessionCookie;\n        headers['X-CustomerID'] = this.#config.apiKey;\n      }\n      this.#logger.debug(`Session cookie: ${sessionCookie}`);\n    }\n\n    if (this.#config.authorization) {\n      // add authorization header from authorization from apiConfig if set\n      headers['Authorization'] = this.#config.authorization;\n    }\n\n    // Fix Cookie header: only send JSESSIONID value\n    if (headers['Cookie']) {\n      const jsessionMatch = headers['Cookie'].match(/JSESSIONID=([^;]+)/);\n      if (jsessionMatch) {\n        headers['Cookie'] = `JSESSIONID=${jsessionMatch[1]}`;\n      } else {\n        delete headers['Cookie'];\n      }\n    }\n\n    // Native Node request implementation\n    let responseText = '';\n    this.#logger.debug('Making request to', url, headers, body);\n    responseText = await makeNodeRequest(\n      url,\n      method,\n      headers,\n      body,\n      !!this.#config.forceTls12,\n    );\n    // Create Axios-like response object\n    const responseObj: ApiResponseData = {\n      data: responseText,\n      status: 200,\n      statusText: 'OK',\n      headers,\n      config: {},\n    };\n\n    return responseObj;\n  }\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,oBAAuB;AACvB,oBAAgC;AAKzB,MAAM,IAAI;AAAA,EASf,YACmB,QACjB,cACA,gBACA;AAHiB;AAIjB,SAAK,UAAU,qBAAO,YAAY;AAClC,SAAK,UAAU;AACf,SAAK,gBAAgB;AACrB,SAAK,kBAAkB;AAAA,EACzB;AAAA,EAjBS;AAAA,EAET;AAAA,EAEA;AAAA,EAEA;AAAA,EAaA,MAAa,WACX,KACA,OAAO,IACP,SAAS,OACT,SAAS,QACiB;AAC1B,yBAAO,YAAY,EAAE;AAAA,MACnB,aAAa,MAAM,eAAe,GAAG,cAAc,IAAI;AAAA,IACzD;AACA,UAAM,cAAsB;AAC5B,UAAM,UAKF,CAAC;AACL,QAAI,eAAe,WAAW,OAAO;AACnC,cAAQ,cAAc,IAAI;AAAA,IAC5B;AAEA,QAAI,KAAK,eAAe;AACtB,WAAK,QAAQ,MAAM,4BAA4B;AAC/C,YAAM,QAAQ,MAAM,KAAK,cAAc,eAAe;AACtD,UAAI,OAAO;AACT,gBAAQ,eAAe,IAAI,UAAU,KAAK;AAAA,MAC5C;AAAA,IACF;AAEA,QAAI,KAAK,iBAAiB;AACxB,WAAK,QAAQ,MAAM,8BAA8B;AACjD,YAAM,gBAAgB,MAAM,KAAK,gBAAgB,gBAAgB;AACjE,UAAI,eAAe;AACjB,gBAAQ,QAAQ,IAAI;AACpB,gBAAQ,cAAc,IAAI,KAAK,QAAQ;AAAA,MACzC;AACA,WAAK,QAAQ,MAAM,mBAAmB,aAAa,EAAE;AAAA,IACvD;AAEA,QAAI,KAAK,QAAQ,eAAe;AAE9B,cAAQ,eAAe,IAAI,KAAK,QAAQ;AAAA,IAC1C;AAGA,QAAI,QAAQ,QAAQ,GAAG;AACrB,YAAM,gBAAgB,QAAQ,QAAQ,EAAE,MAAM,oBAAoB;AAClE,UAAI,eAAe;AACjB,gBAAQ,QAAQ,IAAI,cAAc,cAAc,CAAC,CAAC;AAAA,MACpD,OAAO;AACL,eAAO,QAAQ,QAAQ;AAAA,MACzB;AAAA,IACF;AAGA,QAAI,eAAe;AACnB,SAAK,QAAQ,MAAM,qBAAqB,KAAK,SAAS,IAAI;AAC1D,mBAAe,UAAM;AAAA,MACnB;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,MACA,CAAC,CAAC,KAAK,QAAQ;AAAA,IACjB;AAEA,UAAM,cAA+B;AAAA,MACnC,MAAM;AAAA,MACN,QAAQ;AAAA,MACR,YAAY;AAAA,MACZ;AAAA,MACA,QAAQ,CAAC;AAAA,IACX;AAEA,WAAO;AAAA,EACT;AACF;",
  "names": []
}
