{
  "version": 3,
  "sources": ["../../../../../../../libs/samba-client/src/lib/samba-client.ts"],
  "sourcesContent": ["import * as path from 'path';\nimport { ExecaInterface } from './execa.interface';\nimport { ExecaWrapper } from './execa.wrapper';\nimport { SambaConfig } from './types';\n\nconst singleSlash = /\\//g;\n\n/*\n * NT_STATUS_NO_SUCH_FILE - when trying to dir a file in a directory that *does* exist\n * NT_STATUS_OBJECT_NAME_NOT_FOUND - when trying to dir a file in a directory that *does not* exist\n */\nconst missingFileRegex =\n  /(NT_STATUS_OBJECT_NAME_NOT_FOUND|NT_STATUS_NO_SUCH_FILE)/im;\n\nconst getCleanedSmbClientArgs = (args: string | Array<string>) => {\n  if (Array.isArray(args)) {\n    return args.map((arg) => `${arg.replace(singleSlash, '\\\\')}`).join(' ');\n  }\n  return `${args.replace(singleSlash, '\\\\')}`;\n};\n\nexport interface ListMetaData {\n  name: string;\n\n  type: 'D' | 'A';\n\n  size: number;\n\n  modifyTime: Date;\n}\n\nexport class SambaClient {\n  // https://www.samba.org/samba/docs/current/man-html/smb.conf.5.html#CLIENTMAXPROTOCOL\n  private execa: ExecaInterface;\n\n  constructor(\n    private config: SambaConfig,\n    execa: ExecaInterface = new ExecaWrapper(),\n  ) {\n    this.execa = execa;\n  }\n\n  async getFile(\n    remotePath: string | Array<string>,\n    localPath: string,\n    workingDir = '',\n  ) {\n    return this.execute(\n      'get',\n      `\"${getCleanedSmbClientArgs(remotePath)}\" \"${localPath}\"`,\n      workingDir,\n    );\n  }\n\n  async sendFile(cmdPath: string, destination: string) {\n    const workingDir = path.dirname(cmdPath);\n    return this.execute(\n      'put',\n      [path.basename(cmdPath), destination],\n      workingDir,\n    );\n  }\n\n  async deleteFile(fileName: string) {\n    return this.execute('del', [`\"${getCleanedSmbClientArgs(fileName)}\"`], '');\n  }\n\n  async listFiles(fileNamePrefix: string, fileNameSuffix: string) {\n    try {\n      const cmdArgs = `${fileNamePrefix}*${fileNameSuffix}`;\n      const allOutput = await this.execute('dir', cmdArgs, '');\n      const fileList: Array<string> = [];\n      const lines = allOutput.split('\\n');\n      lines.forEach((l) => {\n        const line = l.toString().trim();\n        if (line.startsWith(fileNamePrefix)) {\n          const parsed = line.substring(\n            0,\n            line.indexOf(fileNameSuffix) + fileNameSuffix.length,\n          );\n          fileList.push(parsed);\n        }\n      });\n      return fileList;\n    } catch (e) {\n      if (e instanceof Error) {\n        if (e.message.match(missingFileRegex)) {\n          return [];\n        }\n      }\n      throw e;\n    }\n  }\n\n  async mkdir(remotePath: string, cwd?: string) {\n    return this.execute('mkdir', [remotePath], cwd);\n  }\n\n  async dir(remotePath: string, cwd?: string) {\n    return this.execute(['-D', remotePath, '-c', 'dir'], [], cwd);\n  }\n\n  async fileExists(remotePath: string, cwd = '') {\n    try {\n      await this.dir(remotePath, cwd);\n      return true;\n    } catch (e) {\n      if (e instanceof Error) {\n        if (e.message.match(missingFileRegex)) {\n          return false;\n        }\n      }\n      throw e;\n    }\n  }\n\n  async list(remotePath: string): Promise<Array<ListMetaData>> {\n    const remoteDirList = [];\n    const remoteDirContents = await this.dir(remotePath);\n    const lines = remoteDirContents.matchAll(\n      /\\s*(.+?)\\s{6,}([A-Z0-9]{1,2})\\s+([0-9]+)\\s{2}(.+)/g,\n    );\n    // eslint-disable-next-line no-restricted-syntax\n    for (const content of lines) {\n      remoteDirList.push({\n        name: content[1],\n        type: content[2] === 'D' ? 'D' : ('A' as 'D' | 'A'),\n        size: parseInt(content[3], 10),\n        modifyTime: new Date(`${content[4]}Z`),\n      });\n    }\n    return remoteDirList;\n  }\n\n  private getSmbClientArgs(\n    smbCommand: string | Array<string>,\n    smbCommandArgs: string | Array<string>,\n  ) {\n    const args = [];\n\n    if (this.config.username) {\n      args.push('-U', this.config.username);\n    }\n    if (!this.config.password) {\n      args.push('-N');\n    }\n\n    args.push(this.config.address);\n\n    if (this.config.password) {\n      args.push('--password', this.config.password);\n    }\n\n    if (this.config.domain) {\n      args.push('-W', this.config.domain);\n    }\n\n    if (this.config.directory) {\n      args.push('-D', this.config.directory);\n    }\n\n    if (this.config.maxProtocol) {\n      args.push('--max-protocol', this.config.maxProtocol);\n    }\n\n    if (this.config.port) {\n      args.push('-p', this.config.port);\n    }\n\n    if (this.config.timeout) {\n      args.push('-t', this.config.timeout);\n    }\n\n    let cleanedSmbArgs = '';\n    if (Array.isArray(smbCommandArgs)) {\n      cleanedSmbArgs = getCleanedSmbClientArgs(smbCommandArgs);\n    } else {\n      cleanedSmbArgs = smbCommandArgs;\n    }\n\n    if (!Array.isArray(smbCommand)) {\n      // eslint-disable-next-line no-param-reassign\n      smbCommand = ['-c', `${smbCommand} ${cleanedSmbArgs}`];\n    } else {\n      smbCommand.push(cleanedSmbArgs);\n    }\n\n    args.push(...smbCommand);\n\n    return args;\n  }\n\n  private async execute(\n    smbCommand: string | Array<string>,\n    smbCommandArgs: string | Array<string>,\n    workingDir?: string,\n  ): Promise<string> {\n    const args = this.getSmbClientArgs(smbCommand, smbCommandArgs);\n\n    const options = {\n      all: true,\n      cwd: workingDir || '',\n    };\n\n    const val = await this.execa.execute('smbclient', args, options);\n    return val.all;\n  }\n\n  async getAllShares() {\n    const { stdout } = await this.execa.execute(\n      'smbtree',\n      ['-U', 'guest', '-N'],\n      {\n        all: true,\n      },\n    );\n\n    const shares: Array<string> = [];\n    for (const line in stdout.split(/\\r?\\n/)) {\n      const words = line.split(/\\t/);\n      if (words.length > 2 && words[2].match(/^\\s*$/) !== null) {\n        shares.push(words[2].trim());\n      }\n    }\n\n    return shares;\n  }\n}\n"],
  "mappings": "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",
  "names": ["import_execa"]
}
