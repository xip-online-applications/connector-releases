{
  "version": 3,
  "sources": ["../../../../../../../libs/connector-runner-file-sink/src/lib/connector-runner-file-sink.ts"],
  "sourcesContent": ["import { ConnectorRuntime } from '@transai/connector-runtime';\nimport {\n  ActionInterface,\n  BaseConnectorConfig,\n  ConnectorInterface,\n  KafkaCallbackResponse,\n  XodActionType,\n  XodBaseMessageType,\n  XodJobType,\n} from '@xip-online-data/types';\nimport {\n  BadRequest,\n  Created,\n  UnprocessableEntity,\n} from '@xip-online-data/kafka-base-service';\nimport {\n  ConnectSftpClient,\n  SftpClient,\n  SftpInterface,\n} from '@xip-online-data/sftp-client';\nimport { handleError } from '@xip-online-data/handle-error';\nimport { FileSinkConfig } from './types';\nimport { Logger } from '@transai/logger';\n\nexport class ConnectorRunnerFileSink extends ConnectorRuntime<FileSinkConfig> {\n  readonly CONNECTOR_INSTANCE: string = 'XOD_CONNECTOR_FILE_SINK_CONFIG';\n\n  private sftpClientInstance: SftpInterface | undefined;\n\n  private get sftpClient(): SftpInterface {\n    if (this.sftpClientInstance === undefined) {\n      throw new Error('Sftp client not initialized');\n    }\n    return this.sftpClientInstance;\n  }\n\n  constructor(\n    connector: ConnectorInterface,\n    apiConfig: FileSinkConfig & BaseConnectorConfig,\n    actionConfigs: Array<ActionInterface>,\n    readonly injectedSftpInstance?: SftpInterface,\n  ) {\n    super(connector, apiConfig, actionConfigs);\n    this.sftpClientInstance = injectedSftpInstance;\n  }\n\n  override init = async (): Promise<void> => {\n    if (this.sftpClientInstance === undefined) {\n      this.sftpClientInstance = this.config.forceReconnect\n        ? new ConnectSftpClient(this.config.sftpConfig, this.config)\n        : new SftpClient(this.config.sftpConfig, this.config);\n    }\n    await this.sftpClient.init();\n\n    const jobCallbackFunction = (\n      callbackFunction: (\n        message: XodBaseMessageType,\n      ) => Promise<KafkaCallbackResponse>,\n    ) => {\n      return async (m: XodBaseMessageType) => {\n        if (m.type !== 'JOB') {\n          return callbackFunction(m);\n        }\n        const message = m as XodJobType;\n\n        let action: ActionInterface;\n        try {\n          action = this.getActionConfig(message);\n        } catch (error: unknown) {\n          if (error instanceof Error) {\n            return BadRequest(`No action found: ${error.message}`)(message);\n          }\n          return BadRequest('Unknown error occured')(message);\n        }\n\n        const handleBars = action.config['parsedTemplates'] as {\n          filename: HandlebarsTemplateDelegate<unknown>;\n          contents: HandlebarsTemplateDelegate<unknown>;\n        };\n\n        const parsedContent = handleBars\n          .contents({\n            inputs: message.payload,\n          })\n          .trim();\n\n        const parsedFilename = handleBars\n          .filename({\n            inputs: message.payload,\n          })\n          .trim();\n\n        if (message.testRun) {\n          Logger.getInstance().info(\n            `Test run for ${message.eventId} with parsedContent ${parsedContent}, parsedFilename ${parsedFilename}`,\n          );\n          return callbackFunction(message);\n        }\n\n        try {\n          if (parsedContent === undefined || parsedFilename === undefined) {\n            return UnprocessableEntity('Content or destination not provided')(\n              message,\n            );\n          }\n          await this.sftpClient.writeFile(parsedFilename, parsedContent);\n        } catch (error) {\n          handleError('Cannot write file', error);\n        }\n        return callbackFunction(message);\n      };\n    };\n\n    const actionCallbackFunction = (\n      callbackFunction: (\n        message: XodBaseMessageType,\n      ) => Promise<KafkaCallbackResponse>,\n    ) => {\n      return async (m: XodBaseMessageType) => {\n        if (m.type !== 'ACTION') {\n          return callbackFunction(m);\n        }\n\n        const message = m as XodActionType;\n        try {\n          if (\n            message.payload.destination === undefined ||\n            message.payload.content === undefined\n          ) {\n            return UnprocessableEntity('Content or destination not provided')(\n              message,\n            );\n          }\n          await this.sftpClient.writeFile(\n            message.payload.destination,\n            message.payload.content,\n          );\n        } catch (error) {\n          handleError('Cannot write file', error);\n        }\n        return callbackFunction(message);\n      };\n    };\n\n    this.callbackFunction = jobCallbackFunction(\n      actionCallbackFunction(this.emitEventType(Created())),\n    );\n  };\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,+BAAiC;AAUjC,gCAIO;AACP,yBAIO;AACP,0BAA4B;AAE5B,oBAAuB;AAEhB,MAAM,gCAAgC,0CAAiC;AAAA,EAY5E,YACE,WACA,WACA,eACS,sBACT;AACA,UAAM,WAAW,WAAW,aAAa;AAFhC;AAfX,SAAS,qBAA6B;AAqBtC,SAAS,OAAO,YAA2B;AACzC,UAAI,KAAK,uBAAuB,QAAW;AACzC,aAAK,qBAAqB,KAAK,OAAO,iBAClC,IAAI,qCAAkB,KAAK,OAAO,YAAY,KAAK,MAAM,IACzD,IAAI,8BAAW,KAAK,OAAO,YAAY,KAAK,MAAM;AAAA,MACxD;AACA,YAAM,KAAK,WAAW,KAAK;AAE3B,YAAM,sBAAsB,CAC1B,qBAGG;AACH,eAAO,OAAO,MAA0B;AACtC,cAAI,EAAE,SAAS,OAAO;AACpB,mBAAO,iBAAiB,CAAC;AAAA,UAC3B;AACA,gBAAM,UAAU;AAEhB,cAAI;AACJ,cAAI;AACF,qBAAS,KAAK,gBAAgB,OAAO;AAAA,UACvC,SAAS,OAAgB;AACvB,gBAAI,iBAAiB,OAAO;AAC1B,yBAAO,sCAAW,oBAAoB,MAAM,OAAO,EAAE,EAAE,OAAO;AAAA,YAChE;AACA,uBAAO,sCAAW,uBAAuB,EAAE,OAAO;AAAA,UACpD;AAEA,gBAAM,aAAa,OAAO,OAAO,iBAAiB;AAKlD,gBAAM,gBAAgB,WACnB,SAAS;AAAA,YACR,QAAQ,QAAQ;AAAA,UAClB,CAAC,EACA,KAAK;AAER,gBAAM,iBAAiB,WACpB,SAAS;AAAA,YACR,QAAQ,QAAQ;AAAA,UAClB,CAAC,EACA,KAAK;AAER,cAAI,QAAQ,SAAS;AACnB,iCAAO,YAAY,EAAE;AAAA,cACnB,gBAAgB,QAAQ,OAAO,uBAAuB,aAAa,oBAAoB,cAAc;AAAA,YACvG;AACA,mBAAO,iBAAiB,OAAO;AAAA,UACjC;AAEA,cAAI;AACF,gBAAI,kBAAkB,UAAa,mBAAmB,QAAW;AAC/D,yBAAO,+CAAoB,qCAAqC;AAAA,gBAC9D;AAAA,cACF;AAAA,YACF;AACA,kBAAM,KAAK,WAAW,UAAU,gBAAgB,aAAa;AAAA,UAC/D,SAAS,OAAO;AACd,iDAAY,qBAAqB,KAAK;AAAA,UACxC;AACA,iBAAO,iBAAiB,OAAO;AAAA,QACjC;AAAA,MACF;AAEA,YAAM,yBAAyB,CAC7B,qBAGG;AACH,eAAO,OAAO,MAA0B;AACtC,cAAI,EAAE,SAAS,UAAU;AACvB,mBAAO,iBAAiB,CAAC;AAAA,UAC3B;AAEA,gBAAM,UAAU;AAChB,cAAI;AACF,gBACE,QAAQ,QAAQ,gBAAgB,UAChC,QAAQ,QAAQ,YAAY,QAC5B;AACA,yBAAO,+CAAoB,qCAAqC;AAAA,gBAC9D;AAAA,cACF;AAAA,YACF;AACA,kBAAM,KAAK,WAAW;AAAA,cACpB,QAAQ,QAAQ;AAAA,cAChB,QAAQ,QAAQ;AAAA,YAClB;AAAA,UACF,SAAS,OAAO;AACd,iDAAY,qBAAqB,KAAK;AAAA,UACxC;AACA,iBAAO,iBAAiB,OAAO;AAAA,QACjC;AAAA,MACF;AAEA,WAAK,mBAAmB;AAAA,QACtB,uBAAuB,KAAK,kBAAc,mCAAQ,CAAC,CAAC;AAAA,MACtD;AAAA,IACF;AAxGE,SAAK,qBAAqB;AAAA,EAC5B;AAAA,EAfA,IAAY,aAA4B;AACtC,QAAI,KAAK,uBAAuB,QAAW;AACzC,YAAM,IAAI,MAAM,6BAA6B;AAAA,IAC/C;AACA,WAAO,KAAK;AAAA,EACd;AAkHF;",
  "names": []
}
