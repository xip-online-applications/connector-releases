{
  "version": 3,
  "sources": ["../../../../../../../../libs/file-system-connector/src/lib/handler/disk.filehandler.ts"],
  "sourcesContent": ["/* eslint-disable security/detect-non-literal-fs-filename */\nimport * as fs from 'node:fs';\nimport path from 'node:path';\n\nimport {\n  ActiveFileHandlerInterface,\n  FileHandlerConfig,\n  FileHandlerInterface,\n} from '../file-handler.interface';\nimport { GenericActiveFileActiveFileHandler } from '../generic-active-file.active-file-handler';\nimport { FileInfo, FileInfoEnum } from '../types';\n\nexport interface DiskConfig extends FileHandlerConfig {\n  type: 'disk';\n  path: string;\n}\n\nexport class DiskFileHandler implements FileHandlerInterface {\n  readonly #config: DiskConfig;\n\n  constructor(config: DiskConfig) {\n    this.#config = config;\n  }\n\n  static fromDsn(dsn: string): DiskFileHandler | null {\n    if (!dsn.startsWith('file:')) {\n      return null;\n    }\n\n    const url = new URL(dsn);\n\n    return new DiskFileHandler({\n      type: 'disk',\n      path: url.pathname,\n      processedAction: url.searchParams.get('processedAction') ?? 'move',\n    } as DiskConfig);\n  }\n\n  get config(): DiskConfig {\n    return this.#config;\n  }\n\n  async list(dir: string): Promise<Array<FileInfo>> {\n    const fullPath = [this.#config.path, dir].filter(Boolean).join('/');\n\n    return new Promise<Array<FileInfo>>((resolve, reject) => {\n      fs.readdir(fullPath, (err, files) => {\n        if (err) {\n          return reject(err);\n        }\n\n        const fileInfos = files.map((file): FileInfo => {\n          const fileInfo = fs.statSync(`${fullPath}/${file}`);\n\n          return {\n            type: fileInfo.isFile()\n              ? FileInfoEnum.FILE\n              : FileInfoEnum.DIRECTORY,\n            name: file,\n            size: fileInfo.size,\n            modifyTime: fileInfo.mtime,\n          };\n        });\n\n        return resolve(fileInfos);\n      });\n    });\n  }\n\n  async readFile(filepath: string): Promise<ActiveFileHandlerInterface> {\n    const fullPath = [this.#config.path, filepath].filter(Boolean).join('/');\n\n    return new Promise<ActiveFileHandlerInterface>((resolve, reject) => {\n      fs.readFile(fullPath, (err, files) => {\n        if (err) {\n          return reject(err);\n        }\n\n        return resolve(new GenericActiveFileActiveFileHandler(files));\n      });\n    });\n  }\n\n  async writeFile(\n    data: ActiveFileHandlerInterface,\n    remotePath: string,\n    filename: string,\n  ): Promise<boolean> {\n    const fullPath = [this.#config.path, remotePath, filename]\n      .filter(Boolean)\n      .join('/');\n\n    return new Promise<boolean>((resolve, reject) => {\n      fs.mkdirSync(path.dirname(fullPath), { recursive: true });\n      // @ts-expect-error ignore for now?\n      fs.writeFile(fullPath, data.get(), 'base64', (err) => {\n        if (err) {\n          return reject(err);\n        }\n\n        return resolve(true);\n      });\n    });\n  }\n\n  async deleteFile(filepath: string): Promise<boolean> {\n    const fullPath = [this.#config.path, filepath].filter(Boolean).join('/');\n\n    return new Promise<boolean>((resolve, reject) => {\n      fs.rm(fullPath, (err) => {\n        if (err) {\n          return reject(err);\n        }\n\n        return resolve(true);\n      });\n    });\n  }\n\n  async fileExists(location: string): Promise<boolean> {\n    const fullPath = [this.#config.path, location].filter(Boolean).join('/');\n\n    return new Promise<boolean>((resolve) => {\n      fs.stat(fullPath, (err) => {\n        if (err) {\n          return resolve(false);\n        }\n\n        return resolve(true);\n      });\n    });\n  }\n\n  pathAsDsn(filepath: string): string {\n    return `file://${path.join(this.#config.path, filepath)}`;\n  }\n\n  async init(): Promise<void> {\n    /* empty */\n  }\n}\n"],
  "mappings": "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",
  "names": ["path"]
}
