{
  "version": 3,
  "sources": ["../../../../../../../../libs/file-system-connector/src/lib/handler/samba.filehandler.ts"],
  "sourcesContent": ["/* eslint-disable security/detect-non-literal-fs-filename */\n/* eslint-disable no-console */\n/* eslint-disable max-classes-per-file */\nimport * as fs from 'node:fs';\nimport path from 'node:path';\n\nimport {\n  ListMetaData,\n  SambaClient,\n  SambaConfig as BasicSambaConfig,\n} from '@xip-online-data/samba-client';\nimport { v4 as uuid } from 'uuid';\n\nimport {\n  ActiveFileHandlerInterface,\n  FileHandlerConfig,\n  FileHandlerInterface,\n} from '../file-handler.interface';\nimport { FileInfo, FileInfoEnum } from '../types';\n\nexport interface SambaConfig extends BasicSambaConfig, FileHandlerConfig {\n  type: 'samba';\n}\n\nconst mapFileInfo = (fileInfo: ListMetaData): FileInfo => {\n  return {\n    name: fileInfo.name,\n    size: fileInfo.size,\n    modifyTime: fileInfo.modifyTime,\n    type: fileInfo.type === 'D' ? FileInfoEnum.DIRECTORY : FileInfoEnum.FILE,\n  };\n};\n\nexport class SambaFile implements ActiveFileHandlerInterface {\n  readonly #file: Buffer;\n\n  readonly #tempFile: string;\n\n  constructor(file: Buffer, tempFile: string) {\n    this.#file = file;\n    this.#tempFile = tempFile;\n  }\n\n  get(): Buffer {\n    return this.#file;\n  }\n\n  close(): boolean {\n    let success = false;\n    fs.unlink(this.#tempFile, (err) => {\n      success = err === null;\n    });\n    return success;\n  }\n}\n\nexport class SambaFilehandler implements FileHandlerInterface {\n  static readonly DEFAULT_PORT = '445';\n\n  static readonly DEFAULT_TMP_DIR = '/tmp/transai/samba';\n\n  readonly #sambaClient: SambaClient;\n\n  readonly #sambaConfig: SambaConfig;\n\n  constructor(sambaConfig: SambaConfig) {\n    this.#sambaConfig = sambaConfig;\n\n    fs.mkdirSync(this.#sambaConfig.tmpDirectory, { recursive: true });\n    this.#sambaClient = new SambaClient(this.#sambaConfig);\n  }\n\n  static fromDsn(dsn: string): SambaFilehandler | null {\n    if (!dsn.startsWith('smb:')) {\n      return null;\n    }\n\n    const url = new URL(dsn);\n    const pathnameWithoutPrefixSlash = url.pathname.replace(/^\\//, '');\n    const domain = pathnameWithoutPrefixSlash.split('/', 2)[0];\n    const directory = pathnameWithoutPrefixSlash.substring(domain.length);\n\n    const config = {\n      type: 'samba',\n      processedAction: url.searchParams.get('processedAction') ?? 'move',\n      address: decodeURIComponent(url.hostname),\n      port: url.port === '' ? SambaFilehandler.DEFAULT_PORT : url.port,\n      directory: decodeURIComponent(directory),\n      username: decodeURIComponent(url.username),\n      password: decodeURIComponent(url.password),\n      domain: domain ? decodeURIComponent(domain) : undefined,\n      tmpDirectory:\n        url.searchParams.get('tmpDirectory') ??\n        SambaFilehandler.DEFAULT_TMP_DIR,\n      timeout: url.searchParams.get('timeout') ?? undefined,\n      maskCmd: url.searchParams.get('maskCmd') !== null,\n      maxProtocol: url.searchParams.get('maxProtocol') ?? undefined,\n    } as SambaConfig;\n\n    return new SambaFilehandler(config);\n  }\n\n  get config(): SambaConfig {\n    return this.#sambaConfig;\n  }\n\n  async init(): Promise<void> {\n    /* empty */\n  }\n\n  async list(dir: string): Promise<Array<FileInfo>> {\n    const list = await this.#sambaClient.list(dir);\n    // Filter out the current and parent directory. They are not needed.\n    const directories = list.filter(\n      (r) => !(r.type === 'D' && (r.name === '.' || r.name === '..')),\n    );\n    return directories.map(mapFileInfo);\n  }\n\n  async readFile(remoteFile: string): Promise<ActiveFileHandlerInterface> {\n    const tempFilename = `${uuid()}.tmp`;\n    const localFile = `${this.#sambaConfig.tmpDirectory}/${tempFilename}`;\n    await this.#sambaClient.getFile(remoteFile, localFile);\n    const buffer = fs.readFileSync(localFile);\n    return new SambaFile(buffer, localFile);\n  }\n\n  async writeFile(\n    data: ActiveFileHandlerInterface,\n    remotePath: string,\n    filename: string,\n  ): Promise<boolean> {\n    console.log(\n      `Writing file ${filename} to ${remotePath}, checking if directory exists`,\n    );\n    let directoryExists = false;\n    try {\n      const exist = await this.#sambaClient.fileExists(remotePath);\n      directoryExists = exist;\n    } catch (e) {\n      console.error(e);\n    }\n\n    if (!directoryExists) {\n      await this.#sambaClient.mkdir(remotePath);\n    }\n\n    const buffer = data.get();\n    const tempFilename = `${uuid()}.tmp`;\n    const localFile = `${this.#sambaConfig.tmpDirectory}/${tempFilename}`;\n\n    fs.writeFileSync(localFile, new Uint8Array(buffer));\n    let success = false;\n    try {\n      const path = remotePath === '' ? filename : `${remotePath}/${filename}`;\n      await this.#sambaClient.sendFile(localFile, path);\n      success = true;\n    } catch (e) {\n      console.error(e);\n    } finally {\n      fs.unlinkSync(localFile);\n    }\n    return success;\n  }\n\n  async deleteFile(remoteFile: string): Promise<boolean> {\n    try {\n      await this.#sambaClient.deleteFile(remoteFile);\n    } catch (e) {\n      console.log(e);\n      return false;\n    }\n\n    return true;\n  }\n\n  fileExists(location: string): Promise<boolean> {\n    return this.#sambaClient.fileExists(location);\n  }\n\n  pathAsDsn(filepath: string): string {\n    const fullPath = path.join(\n      encodeURIComponent(this.#sambaConfig.domain ?? ''),\n      this.#sambaConfig.directory ?? '',\n      filepath,\n    );\n\n    return `smb://${encodeURIComponent(this.#sambaConfig.address)}:${this.#sambaConfig.port}/${fullPath}`;\n  }\n}\n"],
  "mappings": "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",
  "names": ["uuid", "path"]
}
