{
  "version": 3,
  "sources": ["../../../../../../../../libs/file-system-connector/src/lib/handler/sftp-reconnect.filehandler.ts"],
  "sourcesContent": ["import { Logger } from '@transai/logger';\n\nimport { ActiveFileHandlerInterface } from '../file-handler.interface';\nimport { FileInfo } from '../types';\n\nimport { SftpConfig, SftpFilehandler } from './sftp.filehandler';\n\nexport interface SftpConnectConfig extends SftpConfig {\n  type: 'sftp-reconnect';\n}\n\nexport class SftpReconnectFilehandler extends SftpFilehandler {\n  readonly #logger: Logger;\n\n  constructor(config: SftpConfig) {\n    if (config.type === 'sftp') {\n      throw new Error(\n        'SftpReconnectFilehandler requires a SftpConnectConfig with type \"sftp-reconnect\".',\n      );\n    }\n    super(config);\n    this.#logger = Logger.getInstance();\n    this.#logger.info('SFTP Reconnect File handler setup!');\n  }\n\n  static override fromDsn(dsn: string): SftpReconnectFilehandler | null {\n    if (!dsn.startsWith('sftp-reconnect:')) {\n      return null;\n    }\n\n    const url = new URL(dsn);\n    const keepaliveInterval = url.searchParams.get('keepaliveInterval');\n    const config = {\n      type: 'sftp-reconnect',\n      processedAction: url.searchParams.get('processedAction') ?? 'move',\n      sftpIdentifier: decodeURIComponent(url.hostname),\n      host: decodeURIComponent(url.hostname),\n      port: url.port\n        ? Number.parseInt(url.port, 10)\n        : SftpFilehandler.DEFAULT_PORT,\n      username: decodeURIComponent(url.username),\n      password: decodeURIComponent(url.password),\n      protocol: url.searchParams.get('protocol') ?? undefined,\n      privateKey: url.searchParams.get('privateKey') ?? undefined,\n      keepaliveInterval: keepaliveInterval\n        ? Number.parseInt(keepaliveInterval, 10)\n        : undefined,\n    } as SftpConnectConfig;\n\n    return new SftpReconnectFilehandler(config);\n  }\n\n  override async init(): Promise<void> {\n    await super.init();\n    await this.sftpClient.end();\n  }\n\n  override async list(dir: string): Promise<Array<FileInfo>> {\n    await this.sftpClient.connect(this.config);\n\n    try {\n      return await super.list(dir);\n    } finally {\n      await this.sftpClient.end();\n    }\n  }\n\n  override async readFile(\n    filepath: string,\n  ): Promise<ActiveFileHandlerInterface> {\n    await this.sftpClient.connect(this.config);\n\n    try {\n      return super.readFile(filepath);\n    } finally {\n      await this.sftpClient.end();\n    }\n  }\n\n  override async writeFile(\n    data: ActiveFileHandlerInterface,\n    remotePath: string,\n    filename: string,\n  ): Promise<boolean> {\n    await this.sftpClient.connect(this.config);\n\n    try {\n      return super.writeFile(data, remotePath, filename);\n    } finally {\n      await this.sftpClient.end();\n    }\n  }\n\n  override async deleteFile(filepath: string): Promise<boolean> {\n    await this.sftpClient.connect(this.config);\n\n    try {\n      return super.deleteFile(filepath);\n    } finally {\n      await this.sftpClient.end();\n    }\n  }\n\n  override async fileExists(filepath: string): Promise<boolean> {\n    await this.sftpClient.connect(this.config);\n\n    try {\n      return super.fileExists(filepath);\n    } finally {\n      await this.sftpClient.end();\n    }\n  }\n\n  override pathAsDsn(filepath: string): string {\n    return `sftp-reconnect:${encodeURIComponent(this.config.host)}:${this.config.port}/${filepath}`;\n  }\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,oBAAuB;AAKvB,kBAA4C;AAMrC,MAAM,iCAAiC,4BAAgB;AAAA,EACnD;AAAA,EAET,YAAY,QAAoB;AAC9B,QAAI,OAAO,SAAS,QAAQ;AAC1B,YAAM,IAAI;AAAA,QACR;AAAA,MACF;AAAA,IACF;AACA,UAAM,MAAM;AACZ,SAAK,UAAU,qBAAO,YAAY;AAClC,SAAK,QAAQ,KAAK,oCAAoC;AAAA,EACxD;AAAA,EAEA,OAAgB,QAAQ,KAA8C;AACpE,QAAI,CAAC,IAAI,WAAW,iBAAiB,GAAG;AACtC,aAAO;AAAA,IACT;AAEA,UAAM,MAAM,IAAI,IAAI,GAAG;AACvB,UAAM,oBAAoB,IAAI,aAAa,IAAI,mBAAmB;AAClE,UAAM,SAAS;AAAA,MACb,MAAM;AAAA,MACN,iBAAiB,IAAI,aAAa,IAAI,iBAAiB,KAAK;AAAA,MAC5D,gBAAgB,mBAAmB,IAAI,QAAQ;AAAA,MAC/C,MAAM,mBAAmB,IAAI,QAAQ;AAAA,MACrC,MAAM,IAAI,OACN,OAAO,SAAS,IAAI,MAAM,EAAE,IAC5B,4BAAgB;AAAA,MACpB,UAAU,mBAAmB,IAAI,QAAQ;AAAA,MACzC,UAAU,mBAAmB,IAAI,QAAQ;AAAA,MACzC,UAAU,IAAI,aAAa,IAAI,UAAU,KAAK;AAAA,MAC9C,YAAY,IAAI,aAAa,IAAI,YAAY,KAAK;AAAA,MAClD,mBAAmB,oBACf,OAAO,SAAS,mBAAmB,EAAE,IACrC;AAAA,IACN;AAEA,WAAO,IAAI,yBAAyB,MAAM;AAAA,EAC5C;AAAA,EAEA,MAAe,OAAsB;AACnC,UAAM,MAAM,KAAK;AACjB,UAAM,KAAK,WAAW,IAAI;AAAA,EAC5B;AAAA,EAEA,MAAe,KAAK,KAAuC;AACzD,UAAM,KAAK,WAAW,QAAQ,KAAK,MAAM;AAEzC,QAAI;AACF,aAAO,MAAM,MAAM,KAAK,GAAG;AAAA,IAC7B,UAAE;AACA,YAAM,KAAK,WAAW,IAAI;AAAA,IAC5B;AAAA,EACF;AAAA,EAEA,MAAe,SACb,UACqC;AACrC,UAAM,KAAK,WAAW,QAAQ,KAAK,MAAM;AAEzC,QAAI;AACF,aAAO,MAAM,SAAS,QAAQ;AAAA,IAChC,UAAE;AACA,YAAM,KAAK,WAAW,IAAI;AAAA,IAC5B;AAAA,EACF;AAAA,EAEA,MAAe,UACb,MACA,YACA,UACkB;AAClB,UAAM,KAAK,WAAW,QAAQ,KAAK,MAAM;AAEzC,QAAI;AACF,aAAO,MAAM,UAAU,MAAM,YAAY,QAAQ;AAAA,IACnD,UAAE;AACA,YAAM,KAAK,WAAW,IAAI;AAAA,IAC5B;AAAA,EACF;AAAA,EAEA,MAAe,WAAW,UAAoC;AAC5D,UAAM,KAAK,WAAW,QAAQ,KAAK,MAAM;AAEzC,QAAI;AACF,aAAO,MAAM,WAAW,QAAQ;AAAA,IAClC,UAAE;AACA,YAAM,KAAK,WAAW,IAAI;AAAA,IAC5B;AAAA,EACF;AAAA,EAEA,MAAe,WAAW,UAAoC;AAC5D,UAAM,KAAK,WAAW,QAAQ,KAAK,MAAM;AAEzC,QAAI;AACF,aAAO,MAAM,WAAW,QAAQ;AAAA,IAClC,UAAE;AACA,YAAM,KAAK,WAAW,IAAI;AAAA,IAC5B;AAAA,EACF;AAAA,EAES,UAAU,UAA0B;AAC3C,WAAO,kBAAkB,mBAAmB,KAAK,OAAO,IAAI,CAAC,IAAI,KAAK,OAAO,IAAI,IAAI,QAAQ;AAAA,EAC/F;AACF;",
  "names": []
}
