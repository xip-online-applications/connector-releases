{
  "version": 3,
  "sources": ["../../../../../../../../libs/file-system-connector/src/lib/handler/sftp.filehandler.ts"],
  "sourcesContent": ["import path from 'node:path';\n\nimport { Logger } from '@transai/logger';\nimport sftp = require('ssh2-sftp-client');\n\nimport {\n  ActiveFileHandlerInterface,\n  FileHandlerConfig,\n  FileHandlerInterface,\n} from '../file-handler.interface';\nimport { GenericActiveFileActiveFileHandler } from '../generic-active-file.active-file-handler';\nimport { FileInfo, FileInfoEnum } from '../types';\n\nexport interface SftpConfig extends FileHandlerConfig {\n  type: 'sftp' | 'sftp-reconnect';\n  sftpIdentifier: string;\n  host: string;\n  port: number;\n  username: string;\n  password?: string;\n  protocol?: string;\n  privateKey?: string;\n  keepaliveInterval?: number;\n}\n\nexport interface SftpRegularConfig extends SftpConfig {\n  type: 'sftp';\n}\n\nconst mapFileInfo = (fileInfo: sftp.FileInfo): FileInfo => {\n  return {\n    name: fileInfo.name,\n    size: fileInfo.size,\n    modifyTime: new Date(fileInfo.modifyTime),\n    type: fileInfo.type === '-' ? FileInfoEnum.FILE : FileInfoEnum.DIRECTORY,\n  };\n};\n\nexport class SftpFilehandler implements FileHandlerInterface {\n  static readonly DEFAULT_PORT = 22;\n\n  protected readonly sftpClient: sftp;\n\n  readonly #config: SftpConfig;\n\n  constructor(config: SftpConfig) {\n    this.#config = config;\n\n    // eslint-disable-next-line no-param-reassign\n    this.#config.privateKey = this.#config.privateKey?.replace(/\\\\n/g, '\\n');\n    // eslint-disable-next-line new-cap\n    this.sftpClient = new sftp(this.#config.sftpIdentifier);\n  }\n\n  static fromDsn(dsn: string): SftpFilehandler | null {\n    if (!dsn.startsWith('sftp:')) {\n      return null;\n    }\n\n    const url = new URL(dsn);\n    const keepaliveInterval = url.searchParams.get('keepaliveInterval');\n    const config = {\n      type: 'sftp',\n      processedAction: url.searchParams.get('processedAction') ?? 'move',\n      sftpIdentifier: decodeURIComponent(url.hostname),\n      host: decodeURIComponent(url.hostname),\n      port: url.port\n        ? Number.parseInt(url.port, 10)\n        : SftpFilehandler.DEFAULT_PORT,\n      username: decodeURIComponent(url.username),\n      password: decodeURIComponent(url.password),\n      protocol: url.searchParams.get('protocol') ?? undefined,\n      privateKey: url.searchParams.get('privateKey') ?? undefined,\n      keepaliveInterval: keepaliveInterval\n        ? Number.parseInt(keepaliveInterval, 10)\n        : undefined,\n    } as SftpConfig;\n\n    return new SftpFilehandler(config);\n  }\n\n  get config(): SftpConfig {\n    return this.#config;\n  }\n\n  async init(): Promise<void> {\n    await this.sftpClient.connect(this.#config);\n  }\n\n  async list(dir: string): Promise<Array<FileInfo>> {\n    const listings = await this.sftpClient.list(dir);\n    return listings.filter((entity) => entity.type !== 'l').map(mapFileInfo);\n  }\n\n  async readFile(filepath: string): Promise<ActiveFileHandlerInterface> {\n    const content = await this.sftpClient.get(filepath);\n\n    if (typeof content === 'string') {\n      return new GenericActiveFileActiveFileHandler(\n        Buffer.from(content, 'utf-8'),\n      ); // Convert the string content to a Buffer\n    }\n    if (Buffer.isBuffer(content)) {\n      return new GenericActiveFileActiveFileHandler(content); // Convert the string content to a Buffer\n    }\n    throw new Error(\n      `Unexpected content type received from SFTP: ${typeof content}`,\n    );\n  }\n\n  async writeFile(\n    data: ActiveFileHandlerInterface,\n    remotePath: string,\n    filename: string,\n  ): Promise<boolean> {\n    await this.sftpClient.put(data.get(), `${remotePath}/${filename}`, {\n      writeStreamOptions: {\n        flags: 'w', // w - write and a - append\n        mode: 0o666, // mode to use for created file (rwx)\n      },\n    });\n    return true;\n  }\n\n  async deleteFile(filepath: string): Promise<boolean> {\n    try {\n      await this.sftpClient.delete(filepath);\n      return true;\n    } catch (error) {\n      if (error instanceof Error) {\n        Logger.getInstance().error(`Error removing file: ${error.message}`);\n      }\n      return false;\n    }\n  }\n\n  async fileExists(filepath: string): Promise<boolean> {\n    const file = await this.sftpClient.exists(filepath);\n\n    return file !== false;\n  }\n\n  pathAsDsn(filepath: string): string {\n    return `sftp://${encodeURIComponent(this.#config.host)}:${this.#config.port}/${filepath.replace(/^\\//, '')}`;\n  }\n}\n"],
  "mappings": "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",
  "names": []
}
