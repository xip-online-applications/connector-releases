{
  "version": 3,
  "sources": ["../../../../../../../libs/file-system-connector/src/lib/sftp.filehandler.ts"],
  "sourcesContent": ["import sftp = require('ssh2-sftp-client');\nimport { Logger } from '@transai/logger';\nimport {\n  ActiveFileHandlerInterface,\n  FileHandlerConfig,\n  FileHandlerInterface,\n} from './file-handler.interface';\nimport { FileInfo, FileInfoEnum } from './types';\nimport { GenericActiveFileActiveFileHandler } from './generic-active-file.active-file-handler';\n\nexport interface SftpConfig extends FileHandlerConfig {\n  type: 'sftp' | 'sftp-reconnect';\n  sftpIdentifier: string;\n  host: string;\n  port: number;\n  username: string;\n  password?: string;\n  protocol?: string;\n  privateKey?: string;\n  keepaliveInterval?: number;\n}\n\nexport interface SftpRegularConfig extends SftpConfig {\n  type: 'sftp';\n}\n\nconst mapFileInfo = (fileInfo: sftp.FileInfo): FileInfo => {\n  return {\n    name: fileInfo.name,\n    size: fileInfo.size,\n    modifyTime: new Date(fileInfo.modifyTime),\n    type: fileInfo.type === '-' ? FileInfoEnum.FILE : FileInfoEnum.DIRECTORY,\n  };\n};\n\nexport class SftpFilehandler implements FileHandlerInterface {\n  protected readonly sftpClient: sftp;\n\n  constructor(protected readonly config: SftpConfig) {\n    Logger.getInstance().info('SFTP File handler setup!');\n    // eslint-disable-next-line no-param-reassign\n    config.privateKey = config.privateKey?.replace(/\\\\n/g, '\\n');\n    // eslint-disable-next-line new-cap\n    this.sftpClient = new sftp(config.sftpIdentifier);\n  }\n\n  async init(): Promise<void> {\n    Logger.getInstance().info('Initializing sftp: ', this.config.host);\n    await this.sftpClient.connect(this.config);\n    Logger.getInstance().info('SFTP client initialized');\n  }\n\n  async list(dir: string): Promise<Array<FileInfo>> {\n    const listings = await this.sftpClient.list(dir);\n    return listings.filter((entity) => entity.type !== 'l').map(mapFileInfo);\n  }\n\n  async readFile(filepath: string): Promise<ActiveFileHandlerInterface> {\n    const content = await this.sftpClient.get(filepath);\n\n    if (typeof content === 'string') {\n      return new GenericActiveFileActiveFileHandler(\n        Buffer.from(content, 'utf-8'),\n      ); // Convert the string content to a Buffer\n    }\n    if (Buffer.isBuffer(content)) {\n      return new GenericActiveFileActiveFileHandler(content); // Convert the string content to a Buffer\n    }\n    throw new Error(\n      `Unexpected content type received from SFTP: ${typeof content}`,\n    );\n  }\n\n  async writeFile(\n    data: ActiveFileHandlerInterface,\n    remotePath: string,\n    filename: string,\n  ): Promise<boolean> {\n    await this.sftpClient.put(data.get(), `${remotePath}/${filename}`, {\n      writeStreamOptions: {\n        flags: 'w', // w - write and a - append\n        mode: 0o666, // mode to use for created file (rwx)\n      },\n    });\n    return true;\n  }\n\n  async deleteFile(filepath: string): Promise<boolean> {\n    try {\n      await this.sftpClient.delete(filepath);\n      return true;\n    } catch (error) {\n      if (error instanceof Error) {\n        Logger.getInstance().error(`Error removing file: ${error.message}`);\n      }\n      return false;\n    }\n  }\n\n  async fileExists(filepath: string): Promise<boolean> {\n    Logger.getInstance().info(`Checking if file exists: ${filepath}`);\n    const file = await this.sftpClient.exists(filepath);\n    return file !== false;\n  }\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AACA,oBAAuB;AAMvB,mBAAuC;AACvC,iCAAmD;AARnD,MAAO,OAAO,QAAQ;AA0BtB,MAAM,cAAc,CAAC,aAAsC;AACzD,SAAO;AAAA,IACL,MAAM,SAAS;AAAA,IACf,MAAM,SAAS;AAAA,IACf,YAAY,IAAI,KAAK,SAAS,UAAU;AAAA,IACxC,MAAM,SAAS,SAAS,MAAM,0BAAa,OAAO,0BAAa;AAAA,EACjE;AACF;AAEO,MAAM,gBAAgD;AAAA,EAG3D,YAA+B,QAAoB;AAApB;AAC7B,yBAAO,YAAY,EAAE,KAAK,0BAA0B;AAEpD,WAAO,aAAa,OAAO,YAAY,QAAQ,QAAQ,IAAI;AAE3D,SAAK,aAAa,IAAI,KAAK,OAAO,cAAc;AAAA,EAClD;AAAA,EAEA,MAAM,OAAsB;AAC1B,yBAAO,YAAY,EAAE,KAAK,uBAAuB,KAAK,OAAO,IAAI;AACjE,UAAM,KAAK,WAAW,QAAQ,KAAK,MAAM;AACzC,yBAAO,YAAY,EAAE,KAAK,yBAAyB;AAAA,EACrD;AAAA,EAEA,MAAM,KAAK,KAAuC;AAChD,UAAM,WAAW,MAAM,KAAK,WAAW,KAAK,GAAG;AAC/C,WAAO,SAAS,OAAO,CAAC,WAAW,OAAO,SAAS,GAAG,EAAE,IAAI,WAAW;AAAA,EACzE;AAAA,EAEA,MAAM,SAAS,UAAuD;AACpE,UAAM,UAAU,MAAM,KAAK,WAAW,IAAI,QAAQ;AAElD,QAAI,OAAO,YAAY,UAAU;AAC/B,aAAO,IAAI;AAAA,QACT,OAAO,KAAK,SAAS,OAAO;AAAA,MAC9B;AAAA,IACF;AACA,QAAI,OAAO,SAAS,OAAO,GAAG;AAC5B,aAAO,IAAI,8DAAmC,OAAO;AAAA,IACvD;AACA,UAAM,IAAI;AAAA,MACR,+CAA+C,OAAO,OAAO;AAAA,IAC/D;AAAA,EACF;AAAA,EAEA,MAAM,UACJ,MACA,YACA,UACkB;AAClB,UAAM,KAAK,WAAW,IAAI,KAAK,IAAI,GAAG,GAAG,UAAU,IAAI,QAAQ,IAAI;AAAA,MACjE,oBAAoB;AAAA,QAClB,OAAO;AAAA;AAAA,QACP,MAAM;AAAA;AAAA,MACR;AAAA,IACF,CAAC;AACD,WAAO;AAAA,EACT;AAAA,EAEA,MAAM,WAAW,UAAoC;AACnD,QAAI;AACF,YAAM,KAAK,WAAW,OAAO,QAAQ;AACrC,aAAO;AAAA,IACT,SAAS,OAAO;AACd,UAAI,iBAAiB,OAAO;AAC1B,6BAAO,YAAY,EAAE,MAAM,wBAAwB,MAAM,OAAO,EAAE;AAAA,MACpE;AACA,aAAO;AAAA,IACT;AAAA,EACF;AAAA,EAEA,MAAM,WAAW,UAAoC;AACnD,yBAAO,YAAY,EAAE,KAAK,4BAA4B,QAAQ,EAAE;AAChE,UAAM,OAAO,MAAM,KAAK,WAAW,OAAO,QAAQ;AAClD,WAAO,SAAS;AAAA,EAClB;AACF;",
  "names": []
}
