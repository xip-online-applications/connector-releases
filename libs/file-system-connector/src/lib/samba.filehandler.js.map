{
  "version": 3,
  "sources": ["../../../../../../../libs/file-system-connector/src/lib/samba.filehandler.ts"],
  "sourcesContent": ["import { ListMetaData, SambaClient, SambaConfig as BasicSambaConfig } from '@xip-online-data/samba-client';\nimport { FileInfo, FileInfoEnum } from './types';\nimport { v4 as uuid } from 'uuid';\nimport { ActiveFileHandlerInterface, FileHandlerConfig, FileHandlerInterface } from './file-handler.interface';\nimport * as fs from 'node:fs';\n\nexport interface SambaConfig extends BasicSambaConfig, FileHandlerConfig {\n  type: 'samba';\n}\n\nconst mapFileInfo = (fileInfo: ListMetaData): FileInfo => {\n  return {\n    name: fileInfo.name,\n    size: fileInfo.size,\n    modifyTime: fileInfo.modifyTime,\n    type: fileInfo.type === 'D' ? FileInfoEnum.DIRECTORY : FileInfoEnum.FILE,\n  };\n}\n\nexport class SambaFile implements ActiveFileHandlerInterface {\n  constructor(\n    private readonly file: Buffer,\n    private readonly tempFile: string\n  ) {\n  }\n\n  get(): Buffer {\n    return this.file;\n  }\n\n  close(): boolean {\n    let success = false;\n    fs.unlink(this.tempFile, (err) => {\n      success = err === null;\n    });\n    return success;\n  }\n}\n\nexport class SambaFilehandler implements FileHandlerInterface {\n  private sambaClient: SambaClient;\n\n  constructor(\n    private readonly sambaConfig: SambaConfig\n  ) {\n    console.log('Samba File handler setup!');\n    fs.mkdirSync(sambaConfig.tmpDirectory, { recursive: true });\n    this.sambaClient = new SambaClient(sambaConfig);\n  }\n\n  async init(): Promise<void> {}\n\n  async list(dir: string): Promise<FileInfo[]> {\n    const list = await this.sambaClient.list(dir);\n    // Filter out the current and parent directory. They are not needed.\n    const directories =  list.filter(r => !(r.type === 'D' && ( r.name === \".\" || r.name === \"..\")) );\n    return directories.map(mapFileInfo);\n  }\n\n  async readFile(remoteFile: string): Promise<ActiveFileHandlerInterface> {\n    const tempFilename = `${uuid()}.tmp`;\n    const localFile = `${this.sambaConfig.tmpDirectory}/${tempFilename}`;\n    await this.sambaClient.getFile(remoteFile, localFile);\n    const buffer = fs.readFileSync(localFile);\n    return new SambaFile(buffer, localFile);\n  }\n\n  async writeFile(\n    data: ActiveFileHandlerInterface,\n    remotePath: string,\n    filename: string\n  ): Promise<boolean> {\n    console.log(`Writing file ${filename} to ${remotePath}, checking if directory exists`);\n    let directoryExists = false;\n    try {\n      console.log(`Checking if ${remotePath} exists`);\n      const exist = await this.sambaClient.fileExists(remotePath)\n      directoryExists = exist;\n    } catch (e) {\n      console.error(e);\n    }\n\n    if (!directoryExists) {\n      console.log(`Directory ${remotePath} does not exist, creating it`);\n      await this.sambaClient.mkdir(remotePath);\n    }\n    console.log(`Directory ${remotePath} exists, writing file ${filename}`);\n    const buffer = data.get();\n    const tempFilename = `${uuid()}.tmp`;\n    const localFile = `${this.sambaConfig.tmpDirectory}/${tempFilename}`;\n    console.log(`Writing file to ${localFile}`);\n    fs.writeFileSync(\n      localFile,\n      buffer\n    );\n    let success = false;\n    try {\n      const path = remotePath === '' ? filename : `${remotePath}/${filename}`;\n      console.log(`Sending local file ${localFile} to ${path}`);\n      const feedback = await this.sambaClient.sendFile(localFile, path);\n      console.log('feedback', feedback);\n      console.log('feedback includes NT_STATUS_OK', feedback.includes('NT_STATUS_OK'));\n      success = true;\n    } catch (e) {\n      console.log(e);\n    } finally {\n      fs.unlinkSync(localFile);\n    }\n    return success;\n  }\n\n  async deleteFile(remoteFile: string): Promise<boolean> {\n    try {\n      const feedback = await this.sambaClient.deleteFile(remoteFile);\n    } catch (e) {\n      console.log(e);\n      return false;\n    }\n\n    return true;\n  }\n\n  fileExists(location: string): Promise<boolean> {\n    return this.sambaClient.fileExists(location);\n  }\n}\n"],
  "mappings": "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",
  "names": ["uuid"]
}
