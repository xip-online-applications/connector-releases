{
  "version": 3,
  "sources": ["../../../../../../../libs/connector-runner-microsoft-office365-email/src/lib/mail-processor.ts"],
  "sourcesContent": ["import {\n  ConnectorSDKInterface,\n  IntervalHandler,\n  LoggerSDKInterface,\n} from '@transai/connector-runtime-sdk';\n// eslint-disable-next-line @nx/enforce-module-boundaries\nimport {\n  FileHandlerInterface,\n  FileSystemConnector,\n  GenericActiveFileActiveFileHandler,\n} from '@xip-online-data/file-system-connector';\n// eslint-disable-next-line @nx/enforce-module-boundaries\nimport {\n  MailClientInterface,\n  MailMessage,\n  StoredMailAttachment,\n} from '@xip-online-data/microsoft-office365-mail-client';\n\nimport { ConnectorConfig, MailboxConfig } from './types';\n\nexport class MailProcessor implements IntervalHandler {\n  readonly DEFAULT_EVENT_TTL = 3_600_000;\n\n  readonly DEFAULT_INTERVAL_SECONDS = 60;\n\n  readonly MAX_PROCESSING_TRIES = 10;\n\n  readonly #sdk: ConnectorSDKInterface<ConnectorConfig>;\n\n  readonly #mailClient: MailClientInterface;\n\n  readonly #mailboxConfig: MailboxConfig;\n\n  readonly #logger: LoggerSDKInterface;\n\n  readonly #fileHandler: FileHandlerInterface;\n\n  #processing = false;\n\n  #processingTries = 0;\n\n  constructor(\n    sdk: ConnectorSDKInterface<ConnectorConfig>,\n    config: MailboxConfig,\n    mailClient: MailClientInterface,\n  ) {\n    this.#sdk = sdk;\n    this.#mailClient = mailClient;\n    this.#mailboxConfig = config;\n    this.#logger = this.#sdk.logger;\n    this.#fileHandler = new FileSystemConnector().fromDsn(\n      this.#mailboxConfig.attachmentDestination ??\n        this.#sdk.config.attachmentDestination ??\n        'dummy:',\n    );\n  }\n\n  async onRun(): Promise<void> {\n    if (this.#processing) {\n      if (this.#processingTries > this.MAX_PROCESSING_TRIES) {\n        this.#logger.error(\n          `Exceeded processingTries for mailbox processor: ${this.#mailboxConfig.mailboxIdentifier}/${this.#mailboxConfig.mailbox}`,\n        );\n        process.exit(1);\n      }\n\n      this.#logger.debug(\n        `Mailsource processor service is already processing: ${this.#mailboxConfig.mailboxIdentifier}/${this.#mailboxConfig.mailbox}`,\n      );\n      this.#processingTries += 1;\n      return;\n    }\n\n    this.#processing = true;\n\n    try {\n      await this.#processMailbox(this.#mailboxConfig);\n    } catch (error) {\n      this.#logger.warn(\n        `Error processing mailbox: ${this.#mailboxConfig.mailboxIdentifier}/${this.#mailboxConfig.mailbox}`,\n        error.message,\n        error,\n      );\n      this.#processing = false;\n      this.#processingTries += 1;\n      return;\n    }\n\n    this.#processing = false;\n    this.#processingTries = 0;\n  }\n\n  async #processMailbox(config: MailboxConfig): Promise<void> {\n    this.#logger.debug(\n      `Processing mailbox: ${this.#mailboxConfig.mailboxIdentifier}/${this.#mailboxConfig.mailbox}`,\n    );\n\n    const lastOffset = await this.#sdk.offsetStore.getOffset(\n      `${this.#mailboxConfig.offsetFilePrefix ?? 'offset'}_${this.#mailboxConfig.mailboxIdentifier}`,\n    );\n\n    const lastMessageId = (lastOffset?.id as string) || '';\n    const lastMessageTimestamp = (lastOffset?.timestamp as number) || 0;\n\n    this.#logger.verbose(\n      `Last message ID of mailbox ${this.#mailboxConfig.mailboxIdentifier}/${this.#mailboxConfig.mailbox}:`,\n      lastMessageId,\n    );\n    const messages = await this.#mailClient.readMailbox(\n      config.mailbox,\n      lastMessageTimestamp,\n      lastMessageId,\n      config.limit ?? 10,\n    );\n\n    if (messages.length === 0) {\n      this.#logger.debug(\n        `No new messages found for mailbox: ${this.#mailboxConfig.mailboxIdentifier}/${this.#mailboxConfig.mailbox}`,\n      );\n      return;\n    }\n\n    await this.#storeAttachments(config.mailbox, ...messages);\n\n    this.#logger.debug(\n      `Fetched ${messages.length} new messages for mailbox ${this.#mailboxConfig.mailboxIdentifier}/${this.#mailboxConfig.mailbox}, sending as ${this.#mailboxConfig.type}`,\n    );\n\n    const preparedMessages = messages.map((message) => ({\n      ...message,\n      attachments: (message.attachments ?? []).map((attachment) => ({\n        ...attachment,\n        content:\n          attachment.contentType === 'application/json'\n            ? attachment.content\n            : undefined,\n        contentBytes: undefined,\n      })),\n    }));\n\n    if (this.#mailboxConfig.type === 'metric') {\n      await this.#sdk.sender.metricsLegacy(\n        preparedMessages as Array<never>,\n        {\n          keyField: 'messageId',\n          collection: this.#sdk.config.datasourceIdentifier,\n        },\n        {\n          ttl: this.DEFAULT_EVENT_TTL,\n        },\n      );\n    } else {\n      await this.#sdk.sender.documents(\n        preparedMessages,\n        {\n          keyField: 'messageId',\n          collection: this.#sdk.config.datasourceIdentifier,\n        },\n        {\n          ttl: this.DEFAULT_EVENT_TTL,\n        },\n      );\n    }\n    this.#logger.info(\n      `Fetched ${preparedMessages.length} new messages for mailbox ${this.#mailboxConfig.mailboxIdentifier}/${this.#mailboxConfig.mailbox}, sent as ${this.#mailboxConfig.type}`,\n    );\n\n    const lastMessage = preparedMessages[preparedMessages.length - 1];\n    this.#sdk.offsetStore.setOffset(\n      {\n        timestamp: lastMessage.deltaTimestamp,\n        id: lastMessage.deltaId,\n        rawTimestamp: new Date().toISOString(),\n      },\n      `${this.#mailboxConfig.offsetFilePrefix ?? 'offset'}_${this.#mailboxConfig.mailboxIdentifier}`,\n    );\n  }\n\n  async #storeAttachments(mailbox: string, ...messages: Array<MailMessage>) {\n    await Promise.all(\n      messages\n        .filter((message) => message.attachmentsCount > 0)\n        .map(async (message) => {\n          const attachments = await this.#mailClient.getAttachments(\n            mailbox,\n            message.id,\n          );\n\n          if (attachments.length === 0) {\n            this.#logger.info(\n              `Somehow found ${attachments.length} of ${message.attachmentsCount} expected attachments for mail ${this.#mailboxConfig.mailboxIdentifier}/${mailbox}/${message.id}`,\n            );\n            return;\n          }\n\n          this.#logger.verbose(\n            `Found ${attachments.length} attachments for mail ${this.#mailboxConfig.mailboxIdentifier}/${mailbox}/${message.id}`,\n          );\n\n          const storedAttachments = await Promise.all(\n            attachments.map(\n              async (attachment): Promise<StoredMailAttachment> => {\n                if (!attachment.contentBytes) {\n                  return;\n                }\n\n                const file = new GenericActiveFileActiveFileHandler(\n                  attachment.contentBytes,\n                );\n\n                this.#logger.verbose(\n                  `Storing mail ${this.#mailboxConfig.mailboxIdentifier}/${mailbox}/${message.id} attachment \"${attachment.id}--${attachment.filename}\" using ${typeof this.#fileHandler}...`,\n                );\n\n                await this.#fileHandler\n                  .writeFile(\n                    file,\n                    `${mailbox}/${message.id}`,\n                    `${attachment.id}--${attachment.filename}`,\n                  )\n                  .catch((err: Error) => {\n                    this.#logger.error(\n                      `Failed to store attachment to ${mailbox}/${message.id}/${attachment.id}--${attachment.filename} due to: ${err.message}`,\n                      err,\n                    );\n                  });\n\n                this.#logger.debug(\n                  `Stored mail ${this.#mailboxConfig.mailboxIdentifier}/${mailbox}/${message.id} attachment \"${attachment.id}--${attachment.filename}\"`,\n                );\n\n                // eslint-disable-next-line consistent-return\n                return {\n                  id: attachment.id,\n                  dsn: this.#fileHandler.pathAsDsn(\n                    `${mailbox}/${message.id}/${attachment.id}--${attachment.filename}`,\n                  ),\n                  filename: attachment.filename,\n                  contentType: attachment.contentType,\n                };\n              },\n            ),\n          );\n\n          // eslint-disable-next-line no-param-reassign\n          message.storedAttachments = [\n            ...(message.storedAttachments ?? []),\n            ...storedAttachments,\n          ];\n        }),\n    );\n  }\n}\n"],
  "mappings": "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",
  "names": []
}
