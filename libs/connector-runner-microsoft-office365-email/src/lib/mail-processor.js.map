{
  "version": 3,
  "sources": ["../../../../../../../libs/connector-runner-microsoft-office365-email/src/lib/mail-processor.ts"],
  "sourcesContent": ["import {\n  ConnectorSDKInterface,\n  IntervalHandler,\n  LoggerSDKInterface,\n} from '@transai/connector-runtime-sdk';\n// eslint-disable-next-line @nx/enforce-module-boundaries\nimport { MailClientInterface } from '@xip-online-data/microsoft-office365-mail-client';\n\nimport { ConnectorConfig, MailboxConfig } from './types';\n\nexport class MailProcessor implements IntervalHandler {\n  readonly DEFAULT_EVENT_TTL = 3_600_000;\n\n  readonly DEFAULT_INTERVAL_SECONDS = 60;\n\n  readonly MAX_PROCESSING_TRIES = 10;\n\n  readonly #sdk: ConnectorSDKInterface<ConnectorConfig>;\n\n  readonly #mailClient: MailClientInterface;\n\n  readonly #mailboxConfig: MailboxConfig;\n\n  readonly #logger: LoggerSDKInterface;\n\n  #processing = false;\n\n  #processingTries = 0;\n\n  constructor(\n    sdk: ConnectorSDKInterface<ConnectorConfig>,\n    config: MailboxConfig,\n    mailClient: MailClientInterface,\n  ) {\n    this.#sdk = sdk;\n    this.#mailClient = mailClient;\n    this.#mailboxConfig = config;\n    this.#logger = this.#sdk.logger;\n  }\n\n  async onRun(): Promise<void> {\n    if (this.#processing) {\n      if (this.#processingTries > this.MAX_PROCESSING_TRIES) {\n        this.#logger.error(\n          `Exceeded processingTries for mailbox processor: ${this.#mailboxConfig.mailboxIdentifier}/${this.#mailboxConfig.mailbox}`,\n        );\n        process.exit(1);\n      }\n\n      this.#logger.debug(\n        `Mailsource processor service is already processing: ${this.#mailboxConfig.mailboxIdentifier}/${this.#mailboxConfig.mailbox}`,\n      );\n      this.#processingTries += 1;\n      return;\n    }\n\n    this.#processing = true;\n\n    try {\n      await this.#processMailbox(this.#mailboxConfig);\n    } catch (error) {\n      this.#logger.warn(\n        `Error processing mailbox: ${this.#mailboxConfig.mailboxIdentifier}/${this.#mailboxConfig.mailbox}`,\n        JSON.stringify(error),\n      );\n      this.#processing = false;\n      this.#processingTries += 1;\n      return;\n    }\n\n    this.#processing = false;\n    this.#processingTries = 0;\n  }\n\n  async #processMailbox(config: MailboxConfig): Promise<void> {\n    this.#logger.debug(\n      `Processing mailbox: ${this.#mailboxConfig.mailboxIdentifier}/${this.#mailboxConfig.mailbox}`,\n    );\n\n    const lastOffset = await this.#sdk.offsetStore.getOffset(\n      `${this.#mailboxConfig.offsetFilePrefix ?? 'offset'}_${this.#mailboxConfig.mailboxIdentifier}`,\n    );\n\n    const lastMessageId = (lastOffset?.id as string) || '';\n    const lastMessageTimestamp = (lastOffset?.timestamp as number) || 0;\n\n    this.#logger.verbose(\n      `Last message ID of mailbox ${this.#mailboxConfig.mailboxIdentifier}/${this.#mailboxConfig.mailbox}:`,\n      lastMessageId,\n    );\n    const messages = await this.#mailClient.readMailbox(\n      config.mailbox,\n      lastMessageTimestamp,\n      lastMessageId,\n      config.limit ?? 10,\n    );\n\n    if (messages.length === 0) {\n      this.#logger.debug(\n        `No new messages found for mailbox: ${this.#mailboxConfig.mailboxIdentifier}/${this.#mailboxConfig.mailbox}`,\n      );\n      return;\n    }\n\n    this.#logger.debug(\n      `Fetched ${messages.length} new messages for mailbox ${this.#mailboxConfig.mailboxIdentifier}/${this.#mailboxConfig.mailbox}, sending as ${this.#mailboxConfig.type}`,\n    );\n    if (this.#mailboxConfig.type === 'metric') {\n      await this.#sdk.sender.metricsLegacy(\n        messages as Array<never>,\n        {\n          keyField: 'messageId',\n          collection: `${this.#sdk.config.datasourceIdentifier}_${this.#mailboxConfig.mailboxIdentifier}`,\n        },\n        {\n          ttl: this.DEFAULT_EVENT_TTL,\n        },\n      );\n    } else {\n      await this.#sdk.sender.documents(\n        messages,\n        {\n          keyField: 'messageId',\n          collection: `${this.#sdk.config.datasourceIdentifier}_${this.#mailboxConfig.mailboxIdentifier}`,\n        },\n        {\n          ttl: this.DEFAULT_EVENT_TTL,\n        },\n      );\n    }\n    this.#logger.info(\n      `Fetched ${messages.length} new messages for mailbox ${this.#mailboxConfig.mailboxIdentifier}/${this.#mailboxConfig.mailbox}, sent as ${this.#mailboxConfig.type}`,\n    );\n\n    const lastMessage = messages[messages.length - 1];\n    this.#sdk.offsetStore.setOffset(\n      {\n        timestamp: lastMessage.deltaTimestamp,\n        id: lastMessage.deltaId,\n        rawTimestamp: new Date().toISOString(),\n      },\n      `${this.#mailboxConfig.offsetFilePrefix ?? 'offset'}_${this.#mailboxConfig.mailboxIdentifier}`,\n    );\n  }\n}\n"],
  "mappings": "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",
  "names": []
}
