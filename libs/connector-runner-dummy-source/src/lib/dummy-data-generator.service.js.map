{
  "version": 3,
  "sources": ["../../../../../../../libs/connector-runner-dummy-source/src/lib/dummy-data-generator.service.ts"],
  "sourcesContent": ["import { interval, Subscription } from 'rxjs';\nimport { KafkaSourceInterface } from '@xip-online-data/kafka-base-service';\nimport { Logger } from '@transai/logger';\nimport { PersistentOffsetStoreInterface } from '@transai/connector-runtime';\nimport { YamlConfig } from './types';\nimport { buildKafkaMessage } from './kafka-message.factory';\n\nexport class DummyDataGeneratorService {\n  static readonly #EVENT = 'event.source-sink.kafka';\n\n  static readonly #METRIC = 'event.metric.dummy-data-generator';\n\n  readonly #kafkaSourceService: KafkaSourceInterface;\n\n  readonly #config: YamlConfig;\n\n  readonly #offsetStore: PersistentOffsetStoreInterface;\n\n  #processing = false;\n\n  #subscription?: Subscription;\n\n  constructor(\n    kafkaSourceService: KafkaSourceInterface,\n    config: YamlConfig,\n    offsetStore: PersistentOffsetStoreInterface,\n  ) {\n    this.#kafkaSourceService = kafkaSourceService;\n    this.#config = config;\n    this.#offsetStore = offsetStore;\n\n    Logger.getInstance().debug(`DummyDataGeneratorService initialized`);\n    this.#subscription = interval(\n      (this.#config.interval ?? 10) * 1000,\n    ).subscribe(() => this.#generate());\n  }\n\n  stop() {\n    this.#subscription?.unsubscribe();\n  }\n\n  async #generate(): Promise<void> {\n    if (this.#processing) {\n      Logger.getInstance().debug('Api source service is already processing');\n      return;\n    }\n\n    if (this.#config.debug) {\n      Logger.getInstance().debug('Generating dummy data');\n    }\n\n    this.#processing = true;\n    try {\n      const [messages, topic] = buildKafkaMessage(\n        {\n          message: 'Hello World',\n          identifier: 'some-constant-identifier',\n          timestamp: new Date().toISOString(),\n        },\n        {\n          source: 'dummy-data-generator',\n          collection: 'pdc_fm_prodmeld',\n          keyField: 'identifier',\n        },\n        this.#config,\n        DummyDataGeneratorService.#EVENT,\n        10,\n      );\n\n      if (this.#config.debug) {\n        Logger.getInstance().debug('Sending messages', messages.length, topic);\n      }\n\n      // a random number between 1 and x;\n      const x = 3;\n      const random = Math.floor(Math.random() * x) + 1;\n\n      await this.#kafkaSourceService.send(messages, topic);\n      this.#offsetStore.setOffset(\n        {\n          id: 0,\n          timestamp: new Date().getTime(),\n          rawTimestamp: new Date().getTime(),\n        },\n        `dummy-source-${random}`,\n      );\n    } catch (error) {\n      Logger.getInstance().debug(error);\n    } finally {\n      this.#processing = false;\n    }\n  }\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,kBAAuC;AAEvC,oBAAuB;AAGvB,2BAAkC;AAE3B,MAAM,0BAA0B;AAAA,EACrC,OAAgB,SAAS;AAAA,EAEzB,OAAgB,UAAU;AAAA,EAEjB;AAAA,EAEA;AAAA,EAEA;AAAA,EAET,cAAc;AAAA,EAEd;AAAA,EAEA,YACE,oBACA,QACA,aACA;AACA,SAAK,sBAAsB;AAC3B,SAAK,UAAU;AACf,SAAK,eAAe;AAEpB,yBAAO,YAAY,EAAE,MAAM,uCAAuC;AAClE,SAAK,oBAAgB;AAAA,OAClB,KAAK,QAAQ,YAAY,MAAM;AAAA,IAClC,EAAE,UAAU,MAAM,KAAK,UAAU,CAAC;AAAA,EACpC;AAAA,EAEA,OAAO;AACL,SAAK,eAAe,YAAY;AAAA,EAClC;AAAA,EAEA,MAAM,YAA2B;AAC/B,QAAI,KAAK,aAAa;AACpB,2BAAO,YAAY,EAAE,MAAM,0CAA0C;AACrE;AAAA,IACF;AAEA,QAAI,KAAK,QAAQ,OAAO;AACtB,2BAAO,YAAY,EAAE,MAAM,uBAAuB;AAAA,IACpD;AAEA,SAAK,cAAc;AACnB,QAAI;AACF,YAAM,CAAC,UAAU,KAAK,QAAI;AAAA,QACxB;AAAA,UACE,SAAS;AAAA,UACT,YAAY;AAAA,UACZ,YAAW,oBAAI,KAAK,GAAE,YAAY;AAAA,QACpC;AAAA,QACA;AAAA,UACE,QAAQ;AAAA,UACR,YAAY;AAAA,UACZ,UAAU;AAAA,QACZ;AAAA,QACA,KAAK;AAAA,QACL,0BAA0B;AAAA,QAC1B;AAAA,MACF;AAEA,UAAI,KAAK,QAAQ,OAAO;AACtB,6BAAO,YAAY,EAAE,MAAM,oBAAoB,SAAS,QAAQ,KAAK;AAAA,MACvE;AAGA,YAAM,IAAI;AACV,YAAM,SAAS,KAAK,MAAM,KAAK,OAAO,IAAI,CAAC,IAAI;AAE/C,YAAM,KAAK,oBAAoB,KAAK,UAAU,KAAK;AACnD,WAAK,aAAa;AAAA,QAChB;AAAA,UACE,IAAI;AAAA,UACJ,YAAW,oBAAI,KAAK,GAAE,QAAQ;AAAA,UAC9B,eAAc,oBAAI,KAAK,GAAE,QAAQ;AAAA,QACnC;AAAA,QACA,gBAAgB,MAAM;AAAA,MACxB;AAAA,IACF,SAAS,OAAO;AACd,2BAAO,YAAY,EAAE,MAAM,KAAK;AAAA,IAClC,UAAE;AACA,WAAK,cAAc;AAAA,IACrB;AAAA,EACF;AACF;",
  "names": []
}
