{
  "version": 3,
  "sources": ["../../../../../../../libs/sftp-client/src/lib/sftp-client.ts"],
  "sourcesContent": ["import { FileInfo } from 'ssh2-sftp-client';\nimport sftp = require('ssh2-sftp-client');\nimport { Logger } from '@transai/logger';\nimport { SftpConfig } from './types';\nimport { SftpInterface } from './sftp-interface';\n\nexport class SftpClient implements SftpInterface {\n  public readonly sftpClient: sftp;\n\n  constructor(\n    protected readonly config: SftpConfig,\n    protected readonly baseYamlConfig: { processIdentifier: string },\n  ) {\n    // eslint-disable-next-line no-param-reassign\n    config.privateKey = config.privateKey?.replace(/\\\\n/g, '\\n');\n    // eslint-disable-next-line new-cap\n    this.sftpClient = new sftp(baseYamlConfig.processIdentifier);\n  }\n\n  public async init(): Promise<void> {\n    Logger.getInstance().info(\n      `Initializing sftp: ${this.config.host}:${this.config.port} using ${this.config.type}`,\n    );\n    await this.sftpClient.connect(this.config);\n    Logger.getInstance().info('SFTP client initialized');\n  }\n\n  public writeFile(destination: string, content: string): Promise<string> {\n    return this.sftpClient.put(Buffer.from(content, 'utf-8'), destination, {\n      writeStreamOptions: {\n        flags: 'w', // w - write and a - append\n        mode: 0o666, // mode to use for created file (rwx)\n      },\n    });\n  }\n\n  public async readFile(destination: string): Promise<Buffer> {\n    const content = await this.sftpClient.get(destination);\n\n    if (typeof content === 'string') {\n      return Buffer.from(content, 'utf-8'); // Convert the string content to a Buffer\n    }\n    if (Buffer.isBuffer(content)) {\n      return content; // It's already a Buffer, no conversion needed\n    }\n    throw new Error(\n      `Unexpected content type received from SFTP: ${typeof content}`,\n    );\n  }\n\n  public async moveFile(\n    path: string,\n    file: FileInfo,\n    destination: string,\n  ): Promise<void> {\n    try {\n      await this.sftpClient.mkdir(destination, true);\n      await this.sftpClient.rename(path, `${destination}/${file.name}`);\n      Logger.getInstance().info(\n        `File renamed/moved from: ${path} to: ${destination}/${file.name}`,\n      );\n    } catch (error: unknown) {\n      if (error instanceof Error) {\n        Logger.getInstance().error(\n          `Error renaming/moving file: ${error.message}`,\n        );\n      }\n    }\n  }\n\n  public async deleteFile(path: string): Promise<void> {\n    try {\n      await this.sftpClient.delete(path);\n\n      Logger.getInstance().info(`File removed from: ${path}`);\n    } catch (error: unknown) {\n      if (error instanceof Error) {\n        Logger.getInstance().error(`Error removing file: ${error.message}`);\n      }\n    }\n  }\n\n  public async list(destination: string): Promise<Array<FileInfo>> {\n    return this.sftpClient.list(destination);\n  }\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA,oBAAuB;AADvB,MAAO,OAAO,QAAQ;AAKf,MAAM,WAAoC;AAAA,EAG/C,YACqB,QACA,gBACnB;AAFmB;AACA;AAGnB,WAAO,aAAa,OAAO,YAAY,QAAQ,QAAQ,IAAI;AAE3D,SAAK,aAAa,IAAI,KAAK,eAAe,iBAAiB;AAAA,EAC7D;AAAA,EAEA,MAAa,OAAsB;AACjC,yBAAO,YAAY,EAAE;AAAA,MACnB,sBAAsB,KAAK,OAAO,IAAI,IAAI,KAAK,OAAO,IAAI,UAAU,KAAK,OAAO,IAAI;AAAA,IACtF;AACA,UAAM,KAAK,WAAW,QAAQ,KAAK,MAAM;AACzC,yBAAO,YAAY,EAAE,KAAK,yBAAyB;AAAA,EACrD;AAAA,EAEO,UAAU,aAAqB,SAAkC;AACtE,WAAO,KAAK,WAAW,IAAI,OAAO,KAAK,SAAS,OAAO,GAAG,aAAa;AAAA,MACrE,oBAAoB;AAAA,QAClB,OAAO;AAAA;AAAA,QACP,MAAM;AAAA;AAAA,MACR;AAAA,IACF,CAAC;AAAA,EACH;AAAA,EAEA,MAAa,SAAS,aAAsC;AAC1D,UAAM,UAAU,MAAM,KAAK,WAAW,IAAI,WAAW;AAErD,QAAI,OAAO,YAAY,UAAU;AAC/B,aAAO,OAAO,KAAK,SAAS,OAAO;AAAA,IACrC;AACA,QAAI,OAAO,SAAS,OAAO,GAAG;AAC5B,aAAO;AAAA,IACT;AACA,UAAM,IAAI;AAAA,MACR,+CAA+C,OAAO,OAAO;AAAA,IAC/D;AAAA,EACF;AAAA,EAEA,MAAa,SACX,MACA,MACA,aACe;AACf,QAAI;AACF,YAAM,KAAK,WAAW,MAAM,aAAa,IAAI;AAC7C,YAAM,KAAK,WAAW,OAAO,MAAM,GAAG,WAAW,IAAI,KAAK,IAAI,EAAE;AAChE,2BAAO,YAAY,EAAE;AAAA,QACnB,4BAA4B,IAAI,QAAQ,WAAW,IAAI,KAAK,IAAI;AAAA,MAClE;AAAA,IACF,SAAS,OAAgB;AACvB,UAAI,iBAAiB,OAAO;AAC1B,6BAAO,YAAY,EAAE;AAAA,UACnB,+BAA+B,MAAM,OAAO;AAAA,QAC9C;AAAA,MACF;AAAA,IACF;AAAA,EACF;AAAA,EAEA,MAAa,WAAW,MAA6B;AACnD,QAAI;AACF,YAAM,KAAK,WAAW,OAAO,IAAI;AAEjC,2BAAO,YAAY,EAAE,KAAK,sBAAsB,IAAI,EAAE;AAAA,IACxD,SAAS,OAAgB;AACvB,UAAI,iBAAiB,OAAO;AAC1B,6BAAO,YAAY,EAAE,MAAM,wBAAwB,MAAM,OAAO,EAAE;AAAA,MACpE;AAAA,IACF;AAAA,EACF;AAAA,EAEA,MAAa,KAAK,aAA+C;AAC/D,WAAO,KAAK,WAAW,KAAK,WAAW;AAAA,EACzC;AACF;",
  "names": []
}
