{
  "version": 3,
  "sources": ["../../../../../../../libs/connector-runner-ai-agent/src/lib/connector-runner-ai-agent.ts"],
  "sourcesContent": ["import { ChatOpenAI } from '@langchain/openai';\nimport {\n  ConnectorRuntimeSDK,\n  ConnectorSDKInterface,\n  LoggerSDKInterface,\n} from '@transai/connector-runtime-sdk';\nimport {\n  ActionInterface,\n  ConnectorInterface,\n  InputParameterInterface,\n  KafkaCallbackResponse,\n  XodBaseMessageType,\n  XodJobType,\n} from '@xip-online-data/types';\nimport { createAgent, HumanMessage, toolStrategy } from 'langchain';\n\nimport { parseParametersToZod } from './output-parsers';\nimport { AiAgentConfig } from './types';\n\nexport class ConnectorRunnerAiAgent extends ConnectorRuntimeSDK<AiAgentConfig> {\n  readonly CONNECTOR_INSTANCE: string = 'XOD_CONNECTOR_AI_AGENT_CONFIG';\n\n  readonly #logger: LoggerSDKInterface;\n\n  readonly #openAISettings: AiAgentConfig['openai'];\n\n  #langchainInstance: ChatOpenAI | undefined;\n\n  private get langchain(): ChatOpenAI {\n    if (this.#langchainInstance === undefined) {\n      throw new Error('Langchain instance not initialized');\n    }\n    return this.#langchainInstance;\n  }\n\n  constructor(\n    connector: ConnectorInterface<AiAgentConfig>,\n    connectorSDK: ConnectorSDKInterface,\n    injectedLangchainInstance?: ChatOpenAI,\n  ) {\n    super(connector, connectorSDK);\n\n    this.#openAISettings = this.connectorSDK.config.openai;\n\n    this.#logger = this.connectorSDK.logger;\n    this.#logger.debug(\n      `Initializing AI Agent Connector Runner with model: ${this.#openAISettings.model}`,\n    );\n\n    this.#langchainInstance =\n      injectedLangchainInstance ??\n      new ChatOpenAI({\n        apiKey: this.#openAISettings.apiKey,\n        model: this.#openAISettings.model || 'gpt-3.5-turbo',\n        temperature: this.#openAISettings.temperature || 0,\n        timeout: this.#openAISettings.timeout || 60000,\n      });\n  }\n\n  override init = async (): Promise<void> => {\n    this.#logger.debug('Initializing AI Agent Connector Runner');\n\n    this.callbackFunction = async (\n      message: XodJobType,\n      action: ActionInterface,\n    ): Promise<KafkaCallbackResponse> => {\n      const systemPrompt = action.config['systemPrompt'] as string;\n      if (!systemPrompt || systemPrompt.trim() === '') {\n        return this.connectorSDK.receiver.responses.unprocessableEntity(\n          'System prompt not found',\n        )(message);\n      }\n\n      const userPrompt = action.config['userPrompt'] as string;\n      if (!userPrompt || userPrompt.trim() === '') {\n        return this.connectorSDK.receiver.responses.unprocessableEntity(\n          'Prompt not found',\n        )(message);\n      }\n\n      const processedSystemPrompt = this.processPromptTemplate(\n        systemPrompt,\n        action.inputParameters,\n        message.payload,\n      );\n\n      const processedUserPrompt = this.processPromptTemplate(\n        userPrompt,\n        action.inputParameters,\n        message.payload,\n      );\n\n      const outputSchema = parseParametersToZod(\n        action.outputParameters as object,\n      );\n      const llm = createAgent({\n        model: this.langchain,\n        responseFormat: toolStrategy(outputSchema),\n        systemPrompt: processedSystemPrompt,\n        tools: [],\n      });\n\n      try {\n        this.#logger.info('Invoking AI agent...');\n\n        const response = await llm.invoke({\n          messages: [new HumanMessage(processedUserPrompt)],\n        });\n        this.#logger.info('AI agent invoked successfully.');\n\n        const returnPayload: XodBaseMessageType = {\n          ...message,\n          payload: {\n            openAiMessages: response.messages,\n            ...response.structuredResponse,\n          },\n        };\n\n        return this.connectorSDK.receiver.responses.ok()(returnPayload);\n      } catch (error: unknown) {\n        this.#logger.error(`Error processing AI agent request: ${error}`);\n        return this.connectorSDK.receiver.responses.internalServerError(\n          `Error processing AI agent request: ${error}`,\n        )(message);\n      }\n    };\n  };\n\n  // Template processing with inputParameters\n  private processPromptTemplate(\n    template: string,\n    inputParams: Array<InputParameterInterface>,\n    payload: any,\n  ): string {\n    let processed = template;\n    inputParams.forEach((param) => {\n      const value = payload[param.name];\n      processed = processed.replace(\n        new RegExp(`\\\\{\\\\{inputs\\\\.${param.name}\\\\}\\\\}`, 'g'),\n        value,\n      );\n    });\n    return processed;\n  }\n}\n"],
  "mappings": "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",
  "names": []
}
