{
  "version": 3,
  "sources": ["../../../../../../../libs/mail-client/src/lib/mail-client.ts"],
  "sourcesContent": ["import { Logger } from '@transai/logger';\nimport { ImapFlow, ImapFlowOptions } from 'imapflow';\nimport { ParsedMail, simpleParser } from 'mailparser';\nimport { htmlToText } from 'html-to-text';\nimport { MailConfig } from './types';\nimport { MailInterface } from './mail-interface';\nimport { getAccessToken } from './mail-token';\nimport { addPdfJsonAttachments } from './mail-attachments';\n\nexport interface Attachment {\n  content?: string;\n  contentType: string;\n  filename?: string;\n  path?: string;\n}\n\nexport interface MailMessage {\n  uid: number;\n  attachments: Array<Attachment>;\n  headers?: Array<{ key: string; header: string }>;\n  headerLines?: Array<{ key: string; line: string }>;\n  subject?: string;\n  references?: string | Array<string>;\n  date?: Date;\n  to?: Array<string>;\n  from?: Array<string>;\n  cc?: Array<string>;\n  bcc?: Array<string>;\n  messageId?: string;\n  inReplyTo?: string;\n  replyTo?: Array<string>;\n  text?: string;\n  html?: string;\n  textAsHtml?: string;\n}\n\nexport class MailClient implements MailInterface {\n  private mailClient: ImapFlow | undefined;\n\n  #logger: Logger;\n\n  constructor(protected readonly config: MailConfig) {\n    this.config = config;\n    this.#logger = Logger.getInstance();\n  }\n\n  public async init(): Promise<void> {\n    Logger.getInstance().info(\n      `Initializing mail: ${this.config.host}:${this.config.port}`,\n    );\n\n    let accessToken: string | undefined;\n\n    if (\n      this.config.tenantId &&\n      this.config.clientId &&\n      this.config.clientSecret\n    ) {\n      accessToken = await getAccessToken(\n        this.config.tenantId,\n        this.config.clientId,\n        this.config.clientSecret,\n      );\n    }\n\n    const imapFlowConfig: ImapFlowOptions = {\n      host: this.config.host,\n      port: this.config.port,\n      secure: this.config.secure ?? true,\n      logger: Logger.getInstance(),\n    };\n\n    if (this.config.password) {\n      imapFlowConfig.auth = {\n        user: this.config.username,\n        pass: this.config.password,\n      };\n    } else if (accessToken) {\n      imapFlowConfig.auth = {\n        user: this.config.username,\n        accessToken,\n      };\n    }\n\n    this.mailClient = new ImapFlow(imapFlowConfig);\n\n    this.mailClient.on('error', (err) => {\n      console.error('IMAP error:', err);\n    });\n\n    this.mailClient.on('close', () => {\n      console.info('IMAP closed');\n    });\n\n    await this.mailClient.connect();\n    Logger.getInstance().info('Mail client initialized');\n  }\n\n  private async ensureLive(): Promise<void> {\n    if (!this.mailClient) throw new Error('Mail client not initialized');\n    try {\n      await this.mailClient.noop();\n    } catch {\n      try {\n        await this.mailClient.logout();\n      } catch {}\n      await this.mailClient.connect();\n    }\n  }\n\n  public async readMail(\n    mailbox: string,\n    lastSeenUid: number,\n  ): Promise<Array<MailMessage>> {\n    const parsedMessages: Array<MailMessage> = [];\n\n    try {\n      await this.init();\n      if (this.mailClient === undefined) {\n        throw new Error('Mail client not initialized');\n      }\n\n      await this.ensureLive();\n\n      const lock = await this.mailClient.getMailboxLock(mailbox, {\n        readOnly: true,\n      });\n      try {\n        let maxUid = lastSeenUid;\n\n        const fromUid = maxUid + 1;\n        const range = `${fromUid}:*`;\n\n        this.#logger.debug(`Fetching messages with range: ${range}`);\n\n        for await (const msg of this.mailClient.fetch(\n          range,\n          {\n            uid: true,\n            flags: true,\n            envelope: true,\n            internalDate: true,\n            size: true,\n            source: true,\n          },\n          { uid: true },\n        )) {\n          if (!msg.source) {\n            this.#logger.warn(\n              `Message with UID ${msg.uid} has no source, skipping`,\n            );\n            continue;\n          }\n          if (msg.uid <= maxUid) {\n            this.#logger.debug(\n              `Message with UID ${msg.uid} already processed, skipping`,\n            );\n            continue;\n          }\n\n          const parsed = await simpleParser(msg.source);\n\n          await addPdfJsonAttachments(parsed);\n\n          const message = this.toJson(parsed, msg.uid);\n          parsedMessages.push(message);\n\n          if (message.uid > maxUid) maxUid = message.uid;\n        }\n      } catch (err: unknown) {\n        if (err instanceof Error) {\n          this.#logger.error(err.message);\n        } else {\n          this.#logger.error(String(err));\n        }\n      } finally {\n        try {\n          lock.release();\n        } catch (_) {\n          this.#logger.error('[lock:error] Failed to release mailbox lock');\n        }\n      }\n    } catch (err: unknown) {\n      if (err instanceof Error) {\n        this.#logger.error(err.message);\n      } else {\n        this.#logger.error(String(err));\n      }\n      try {\n        await this.mailClient?.logout();\n      } catch (_) {\n        this.#logger.error('[logout:error] Failed to logout from mail server');\n      }\n      this.mailClient = undefined; // force reconnect on next poll\n    }\n\n    // \u2705 sort ascending by UID\n    parsedMessages.sort((a, b) => a.uid - b.uid);\n\n    return parsedMessages;\n  }\n\n  private toJson(parsed: ParsedMail, uid: number): MailMessage {\n    const extractAddresses = (addrObj: any): Array<string> | undefined => {\n      if (!addrObj) return undefined;\n      if (Array.isArray(addrObj.value)) {\n        return addrObj.value.map((a: any) => a.address).filter(Boolean);\n      }\n      return typeof addrObj.text === 'string' ? [addrObj.text] : undefined;\n    };\n\n    const headersObj = parsed.headers\n      ? Array.from(parsed.headers.entries()).map(([key, header]) => ({\n          key,\n          header: Array.isArray(header) ? header.join(', ') : String(header),\n        }))\n      : undefined;\n\n    const headerLinesObj = parsed.headerLines\n      ? parsed.headerLines.map((line) => ({\n          key: line.key,\n          line: line.line,\n        }))\n      : undefined;\n\n    return {\n      uid,\n      attachments: parsed.attachments.map((attachment) => ({\n        content:\n          attachment.contentType === 'application/json'\n            ? attachment.content.toString()\n            : undefined,\n        contentType: attachment.contentType,\n        filename: attachment.filename,\n      })),\n      // headers: headersObj,\n      // headerLines: headerLinesObj,\n      subject: parsed.subject,\n      references: parsed.references,\n      date: parsed.date,\n      to: extractAddresses(parsed.to),\n      from: extractAddresses(parsed.from),\n      cc: extractAddresses(parsed.cc),\n      bcc: extractAddresses(parsed.bcc),\n      messageId: parsed.messageId,\n      inReplyTo: parsed.inReplyTo,\n      replyTo: extractAddresses(parsed.replyTo),\n      text: (parsed.text || parsed.html\n        ? htmlToText(parsed.html as string)\n        : ''\n      ).trim(),\n      // html: !parsed.html ? undefined : parsed.html,\n      // textAsHtml: parsed.textAsHtml,\n    };\n  }\n\n  public async reply(\n    from: string,\n    mailbox: string,\n    messageId: string, // Message-ID header value\n    mailBody: string,\n    concept = true,\n  ): Promise<void> {\n    await this.init();\n\n    if (this.mailClient === undefined) {\n      throw new Error('Mail client not initialized');\n    }\n\n    await this.ensureLive();\n    await this.mailClient.mailboxOpen(mailbox);\n\n    const uids = await this.mailClient.search(\n      { header: { 'Message-ID': messageId } },\n      { uid: true },\n    );\n    if (!uids || uids.length === 0) {\n      throw new Error(`Message with Message-ID ${messageId} not found`);\n    }\n    const uid = uids[0];\n    const message = await this.mailClient.fetchOne(\n      uid,\n      { headers: true, source: true, envelope: true },\n      { uid: true },\n    );\n\n    if (!message || !message.source) {\n      throw new Error(`Message with UID ${uid} not found`);\n    }\n\n    const domain = from.split('@')[1] || 'transai.com';\n    const parsed = await simpleParser(message.source);\n\n    const origMessageId = parsed.messageId;\n    const references = parsed.references || [];\n    const subject = parsed.subject || '';\n    const to = parsed.from?.text;\n    const replyTo = parsed.replyTo?.text || to;\n\n    const replyHeaders = {\n      'In-Reply-To': origMessageId,\n      References: [...references, origMessageId].join(' '),\n    };\n\n    const body = `${mailBody}\\n\\n> ${parsed.text?.split('\\n').join('\\n> ')}`;\n\n    const raw = [\n      `From: ${from}`,\n      `To: ${replyTo}`,\n      `Subject: ${subject.startsWith('Re:') ? subject : `Re: ${subject}`}`,\n      `Message-ID: <${Date.now()}.draft@${domain}>`,\n      `Date: ${new Date().toUTCString()}`,\n      `In-Reply-To: ${replyHeaders['In-Reply-To']}`,\n      `References: ${replyHeaders['References']}`,\n      `MIME-Version: 1.0`,\n      `Content-Type: text/plain; charset=utf-8`,\n      ``,\n      body,\n    ].join('\\r\\n');\n\n    await this.mailClient.mailboxOpen('Drafts');\n    await this.mailClient.append('Drafts', raw, ['\\\\Draft']);\n\n    if (!concept) {\n      // todo: send the email\n    }\n  }\n}\n"],
  "mappings": "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",
  "names": []
}
