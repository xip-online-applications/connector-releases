{
  "version": 3,
  "sources": ["../../../../../../../libs/mail-client/src/lib/mail-attachments.ts"],
  "sourcesContent": ["import { ParsedMail } from 'mailparser';\nimport { Readable } from 'stream';\nimport pdf2md from '@opendocsg/pdf2md';\n\nfunction streamToBuffer(stream: Readable): Promise<Buffer> {\n  return new Promise((resolve, reject) => {\n    const chunks: Array<Buffer> = [];\n    stream.on('data', (c: Buffer) => chunks.push(c));\n    stream.once('end', () => resolve(Buffer.concat(chunks)));\n    stream.once('error', reject);\n  });\n}\n\nexport async function addPdfJsonAttachments(parsed: ParsedMail): Promise<void> {\n  if (!Array.isArray(parsed.attachments) || parsed.attachments.length === 0)\n    return;\n\n  const jsonAtts = [];\n  for (const att of parsed.attachments) {\n    const isPdf =\n      (att.contentType &&\n        att.contentType.toLowerCase().includes('application/pdf')) ||\n      (att.filename && att.filename.toLowerCase().endsWith('.pdf'));\n    if (!isPdf) continue;\n\n    const buf = Buffer.isBuffer(att.content)\n      ? att.content\n      : await streamToBuffer(att.content as Readable);\n\n    const pdfParsed = await pdf2md(buf);\n    const jsonFilename = `${att.filename?.replace(/\\.pdf$/i, '') || 'attachment'}.json`;\n\n    jsonAtts.push({\n      filename: jsonFilename,\n      contentType: 'application/json',\n      contentDisposition: att.contentDisposition || 'attachment',\n      headers: att.headers,\n      related: att.related || false,\n      cid: att.cid,\n      type: att.type,\n      size: att.size,\n      headerLines: att.headerLines,\n      checksum: att.checksum,\n      // store as Buffer so your existing mapping stays unchanged\n      content: Buffer.from(pdfParsed),\n    });\n  }\n\n  parsed.attachments.push(...jsonAtts);\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA,oBAAmB;AAEnB,SAAS,eAAe,QAAmC;AACzD,SAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AACtC,UAAM,SAAwB,CAAC;AAC/B,WAAO,GAAG,QAAQ,CAAC,MAAc,OAAO,KAAK,CAAC,CAAC;AAC/C,WAAO,KAAK,OAAO,MAAM,QAAQ,OAAO,OAAO,MAAM,CAAC,CAAC;AACvD,WAAO,KAAK,SAAS,MAAM;AAAA,EAC7B,CAAC;AACH;AAEA,eAAsB,sBAAsB,QAAmC;AAC7E,MAAI,CAAC,MAAM,QAAQ,OAAO,WAAW,KAAK,OAAO,YAAY,WAAW;AACtE;AAEF,QAAM,WAAW,CAAC;AAClB,aAAW,OAAO,OAAO,aAAa;AACpC,UAAM,QACH,IAAI,eACH,IAAI,YAAY,YAAY,EAAE,SAAS,iBAAiB,KACzD,IAAI,YAAY,IAAI,SAAS,YAAY,EAAE,SAAS,MAAM;AAC7D,QAAI,CAAC;AAAO;AAEZ,UAAM,MAAM,OAAO,SAAS,IAAI,OAAO,IACnC,IAAI,UACJ,MAAM,eAAe,IAAI,OAAmB;AAEhD,UAAM,YAAY,UAAM,cAAAA,SAAO,GAAG;AAClC,UAAM,eAAe,GAAG,IAAI,UAAU,QAAQ,WAAW,EAAE,KAAK,YAAY;AAE5E,aAAS,KAAK;AAAA,MACZ,UAAU;AAAA,MACV,aAAa;AAAA,MACb,oBAAoB,IAAI,sBAAsB;AAAA,MAC9C,SAAS,IAAI;AAAA,MACb,SAAS,IAAI,WAAW;AAAA,MACxB,KAAK,IAAI;AAAA,MACT,MAAM,IAAI;AAAA,MACV,MAAM,IAAI;AAAA,MACV,aAAa,IAAI;AAAA,MACjB,UAAU,IAAI;AAAA;AAAA,MAEd,SAAS,OAAO,KAAK,SAAS;AAAA,IAChC,CAAC;AAAA,EACH;AAEA,SAAO,YAAY,KAAK,GAAG,QAAQ;AACrC;",
  "names": ["pdf2md"]
}
