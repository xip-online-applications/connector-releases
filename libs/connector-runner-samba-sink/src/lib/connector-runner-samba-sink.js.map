{
  "version": 3,
  "sources": ["../../../../../../../libs/connector-runner-samba-sink/src/lib/connector-runner-samba-sink.ts"],
  "sourcesContent": ["import { ConnectorRuntime } from '@transai/connector-runtime';\nimport {\n  ActionInterface,\n  BaseConnectorConfig,\n  ConnectorInterface,\n  KafkaCallbackResponse,\n  XodActionType,\n  XodBaseMessageType,\n  XodJobType,\n} from '@xip-online-data/types';\nimport {\n  BadRequest,\n  Created,\n  InternalServerError,\n  UnprocessableEntity,\n} from '@xip-online-data/kafka-base-service';\nimport { Logger } from '@transai/logger';\nimport { SambaFileWriterService } from './samba-fire-writer/samba-file-writer.service';\nimport { SambaSinkConfig } from './types';\n\nexport class ConnectorRunnerSambaSink extends ConnectorRuntime<SambaSinkConfig> {\n  readonly CONNECTOR_INSTANCE: string = 'XOD_CONNECTOR_SAMBA_SINK_CONFIG';\n\n  private sambaFileWriterInstance: SambaFileWriterService | undefined;\n\n  private get sambaFileWriter(): SambaFileWriterService {\n    if (this.sambaFileWriterInstance === undefined) {\n      throw new Error('Samba client not initialized');\n    }\n    return this.sambaFileWriterInstance;\n  }\n\n  constructor(\n    connector: ConnectorInterface,\n    apiConfig: SambaSinkConfig & BaseConnectorConfig,\n    actionConfigs: Array<ActionInterface>,\n    readonly injectedSambaInstance?: SambaFileWriterService,\n  ) {\n    super(connector, apiConfig, actionConfigs);\n    this.sambaFileWriterInstance = injectedSambaInstance;\n  }\n\n  override init = async (): Promise<void> => {\n    if (this.sambaFileWriterInstance === undefined) {\n      this.sambaFileWriterInstance = new SambaFileWriterService(\n        this.config.samba,\n      );\n    }\n\n    const jobCallbackFunction = (\n      callbackFunction: (\n        message: XodBaseMessageType,\n      ) => Promise<KafkaCallbackResponse>,\n    ) => {\n      return async (m: XodBaseMessageType) => {\n        if (m.type !== 'JOB') {\n          return callbackFunction(m);\n        }\n\n        const message = m as XodJobType;\n        let action: ActionInterface;\n        try {\n          action = this.getActionConfig(message);\n        } catch (error: unknown) {\n          if (error instanceof Error) {\n            return BadRequest(`No action found: ${error.message}`)(message);\n          }\n          return BadRequest('Unknown error occured')(message);\n        }\n\n        try {\n          const handleBars = action.config['parsedTemplates'] as {\n            filename: HandlebarsTemplateDelegate<unknown>;\n            contents: HandlebarsTemplateDelegate<unknown>;\n          };\n\n          const parsedContent = handleBars\n            .contents({\n              inputs: message.payload,\n            })\n            .trim();\n\n          const parsedFilename = handleBars\n            .filename({\n              inputs: message.payload,\n            })\n            .trim();\n\n          if (message.testRun) {\n            Logger.getInstance().info(\n              `Test run for ${message.eventId} with payload ${parsedContent} to path ${parsedFilename}`,\n            );\n            return callbackFunction(message);\n          }\n\n          const response = await this.sambaFileWriter.write(\n            message,\n            parsedFilename,\n            parsedContent,\n          );\n\n          if (response.success) {\n            return callbackFunction(message);\n          }\n          return InternalServerError(response.message)(message);\n        } catch (error: unknown) {\n          if (error instanceof Error) {\n            return InternalServerError(error.message)(message);\n          }\n          return InternalServerError('Unknown error')(message);\n        }\n      };\n    };\n\n    const actionCallbackFunction: (\n      callbackFunction: (\n        message: XodBaseMessageType,\n      ) => Promise<KafkaCallbackResponse>,\n    ) => (message: XodBaseMessageType) => Promise<KafkaCallbackResponse> = (\n      callbackFunction: (\n        message: XodBaseMessageType,\n      ) => Promise<KafkaCallbackResponse>,\n    ) => {\n      return async (m: XodBaseMessageType) => {\n        if (m.type !== 'ACTION') {\n          return callbackFunction(m);\n        }\n\n        const message = m as XodActionType;\n        if (\n          message.payload.destination === undefined ||\n          message.payload.content === undefined\n        ) {\n          return UnprocessableEntity('Content or destination not provided')(\n            message,\n          );\n        }\n\n        const response = await this.sambaFileWriter.write(\n          message,\n          message.payload.destination,\n          message.payload.content,\n        );\n\n        if (response.success) {\n          return callbackFunction(message);\n        }\n        return InternalServerError(response.message)(message);\n      };\n    };\n\n    this.callbackFunction = jobCallbackFunction(\n      actionCallbackFunction(this.emitEventType(Created())),\n    );\n  };\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,+BAAiC;AAUjC,gCAKO;AACP,oBAAuB;AACvB,+BAAuC;AAGhC,MAAM,iCAAiC,0CAAkC;AAAA,EAY9E,YACE,WACA,WACA,eACS,uBACT;AACA,UAAM,WAAW,WAAW,aAAa;AAFhC;AAfX,SAAS,qBAA6B;AAqBtC,SAAS,OAAO,YAA2B;AACzC,UAAI,KAAK,4BAA4B,QAAW;AAC9C,aAAK,0BAA0B,IAAI;AAAA,UACjC,KAAK,OAAO;AAAA,QACd;AAAA,MACF;AAEA,YAAM,sBAAsB,CAC1B,qBAGG;AACH,eAAO,OAAO,MAA0B;AACtC,cAAI,EAAE,SAAS,OAAO;AACpB,mBAAO,iBAAiB,CAAC;AAAA,UAC3B;AAEA,gBAAM,UAAU;AAChB,cAAI;AACJ,cAAI;AACF,qBAAS,KAAK,gBAAgB,OAAO;AAAA,UACvC,SAAS,OAAgB;AACvB,gBAAI,iBAAiB,OAAO;AAC1B,yBAAO,sCAAW,oBAAoB,MAAM,OAAO,EAAE,EAAE,OAAO;AAAA,YAChE;AACA,uBAAO,sCAAW,uBAAuB,EAAE,OAAO;AAAA,UACpD;AAEA,cAAI;AACF,kBAAM,aAAa,OAAO,OAAO,iBAAiB;AAKlD,kBAAM,gBAAgB,WACnB,SAAS;AAAA,cACR,QAAQ,QAAQ;AAAA,YAClB,CAAC,EACA,KAAK;AAER,kBAAM,iBAAiB,WACpB,SAAS;AAAA,cACR,QAAQ,QAAQ;AAAA,YAClB,CAAC,EACA,KAAK;AAER,gBAAI,QAAQ,SAAS;AACnB,mCAAO,YAAY,EAAE;AAAA,gBACnB,gBAAgB,QAAQ,OAAO,iBAAiB,aAAa,YAAY,cAAc;AAAA,cACzF;AACA,qBAAO,iBAAiB,OAAO;AAAA,YACjC;AAEA,kBAAM,WAAW,MAAM,KAAK,gBAAgB;AAAA,cAC1C;AAAA,cACA;AAAA,cACA;AAAA,YACF;AAEA,gBAAI,SAAS,SAAS;AACpB,qBAAO,iBAAiB,OAAO;AAAA,YACjC;AACA,uBAAO,+CAAoB,SAAS,OAAO,EAAE,OAAO;AAAA,UACtD,SAAS,OAAgB;AACvB,gBAAI,iBAAiB,OAAO;AAC1B,yBAAO,+CAAoB,MAAM,OAAO,EAAE,OAAO;AAAA,YACnD;AACA,uBAAO,+CAAoB,eAAe,EAAE,OAAO;AAAA,UACrD;AAAA,QACF;AAAA,MACF;AAEA,YAAM,yBAIiE,CACrE,qBAGG;AACH,eAAO,OAAO,MAA0B;AACtC,cAAI,EAAE,SAAS,UAAU;AACvB,mBAAO,iBAAiB,CAAC;AAAA,UAC3B;AAEA,gBAAM,UAAU;AAChB,cACE,QAAQ,QAAQ,gBAAgB,UAChC,QAAQ,QAAQ,YAAY,QAC5B;AACA,uBAAO,+CAAoB,qCAAqC;AAAA,cAC9D;AAAA,YACF;AAAA,UACF;AAEA,gBAAM,WAAW,MAAM,KAAK,gBAAgB;AAAA,YAC1C;AAAA,YACA,QAAQ,QAAQ;AAAA,YAChB,QAAQ,QAAQ;AAAA,UAClB;AAEA,cAAI,SAAS,SAAS;AACpB,mBAAO,iBAAiB,OAAO;AAAA,UACjC;AACA,qBAAO,+CAAoB,SAAS,OAAO,EAAE,OAAO;AAAA,QACtD;AAAA,MACF;AAEA,WAAK,mBAAmB;AAAA,QACtB,uBAAuB,KAAK,kBAAc,mCAAQ,CAAC,CAAC;AAAA,MACtD;AAAA,IACF;AAnHE,SAAK,0BAA0B;AAAA,EACjC;AAAA,EAfA,IAAY,kBAA0C;AACpD,QAAI,KAAK,4BAA4B,QAAW;AAC9C,YAAM,IAAI,MAAM,8BAA8B;AAAA,IAChD;AACA,WAAO,KAAK;AAAA,EACd;AA6HF;",
  "names": []
}
