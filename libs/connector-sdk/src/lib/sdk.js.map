{
  "version": 3,
  "sources": ["../../../../../../../libs/connector-sdk/src/lib/sdk.ts"],
  "sourcesContent": ["import {\n  CloudOffsetStoreService,\n  PersistentOffsetStoreInterface,\n} from '@transai/connector-runtime';\nimport {\n  ConnectorSDKInterface,\n  OffsetStoreSDKInterface,\n  ReceiverSDKInterface,\n  SenderSDKInterface,\n} from '@transai/connector-runtime-sdk';\nimport { Logger } from '@transai/logger';\nimport { buildConnectorTopic } from '@xip-online-data/helper-functions';\nimport {\n  KafkaSourceInterface,\n  RdKafkaSourceService,\n} from '@xip-online-data/kafka-base-service';\nimport { parseYaml } from '@xip-online-data/parse-yaml';\nimport {\n  BaseConnectorConfig,\n  ConnectorInterface,\n} from '@xip-online-data/types';\n\nimport { ProcessingSDKService } from './processing.sdk';\nimport { ReceiverSDKService } from './receiver.sdk';\nimport { SenderSDKService } from './sender.sdk';\nimport { TemplatingSDKService } from './templating.sdk';\n\nexport class TransAIConnectorSDK<\n  T extends BaseConnectorConfig = BaseConnectorConfig,\n> implements ConnectorSDKInterface<T>\n{\n  readonly #DEFAULT_OFFSETS_DIR = '/var/transai/offsets';\n\n  readonly #apiConfig: T;\n\n  readonly #logger: Logger;\n\n  readonly #kafkaServiceInstance: KafkaSourceInterface;\n\n  readonly #sender: SenderSDKService;\n\n  readonly #templating: TemplatingSDKService;\n\n  readonly #offsetStore: PersistentOffsetStoreInterface;\n\n  readonly #processing: ProcessingSDKService;\n\n  readonly #receiver: ReceiverSDKService;\n\n  constructor(connector: ConnectorInterface<T>, logger: Logger) {\n    this.#logger = logger;\n    this.#apiConfig = connector.config;\n\n    const connectorTopic = buildConnectorTopic({\n      tenantIdentifier: connector.tenantIdentifier,\n      identifier: connector.identifier,\n      location: connector.location || 'default',\n    });\n\n    this.#kafkaServiceInstance = new RdKafkaSourceService(\n      this.#apiConfig,\n      connectorTopic,\n    );\n\n    this.#sender = new SenderSDKService(\n      this.#apiConfig,\n      this.#kafkaServiceInstance,\n    );\n    this.#templating = new TemplatingSDKService();\n    this.#processing = new ProcessingSDKService(this.logger);\n    this.#receiver = new ReceiverSDKService(\n      this.#apiConfig,\n      this.#kafkaServiceInstance,\n      connector.actions,\n    );\n\n    this.#offsetStore = new CloudOffsetStoreService(\n      process.env['TRANSAI_TMP_DIR'] ?? this.#DEFAULT_OFFSETS_DIR,\n      this.#apiConfig,\n      connector.identifier,\n    );\n    this.#offsetStore\n      .init()\n      .then(async (): Promise<void> => {\n        this.logger.debug('Offset store initialized. write start time');\n\n        try {\n          await this.#offsetStore.writeFile(connector.identifier, {\n            start: new Date().toISOString(),\n          });\n        } catch (err) {\n          this.logger.error('Error writing start time');\n          throw err;\n        }\n\n        this.logger.debug('Start time written');\n      })\n      .catch((err) => {\n        this.logger.error('Error init offset store');\n        throw err;\n      });\n  }\n\n  async start(): Promise<void> {\n    await Promise.all([\n      this.#processing.start(),\n      this.#kafkaServiceInstance.init(),\n    ]);\n  }\n\n  async stop(): Promise<void> {\n    await Promise.all([\n      this.#processing.stopAll(),\n      this.#kafkaServiceInstance.exitProcess('stop'),\n      this.#offsetStore.deInit(),\n    ]);\n  }\n\n  get logger(): Logger {\n    return this.#logger;\n  }\n\n  get sender(): SenderSDKInterface {\n    return this.#sender;\n  }\n\n  get receiver(): ReceiverSDKInterface {\n    return this.#receiver;\n  }\n\n  get config(): T {\n    return this.#apiConfig;\n  }\n\n  get templating(): TemplatingSDKService {\n    return this.#templating;\n  }\n\n  get processing(): ProcessingSDKService {\n    return this.#processing;\n  }\n\n  get offsetStore(): OffsetStoreSDKInterface {\n    return this.#offsetStore;\n  }\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,+BAGO;AAQP,8BAAoC;AACpC,gCAGO;AAOP,wBAAqC;AACrC,sBAAmC;AACnC,oBAAiC;AACjC,wBAAqC;AAE9B,MAAM,oBAGb;AAAA,EACW,uBAAuB;AAAA,EAEvB;AAAA,EAEA;AAAA,EAEA;AAAA,EAEA;AAAA,EAEA;AAAA,EAEA;AAAA,EAEA;AAAA,EAEA;AAAA,EAET,YAAY,WAAkC,QAAgB;AAC5D,SAAK,UAAU;AACf,SAAK,aAAa,UAAU;AAE5B,UAAM,qBAAiB,6CAAoB;AAAA,MACzC,kBAAkB,UAAU;AAAA,MAC5B,YAAY,UAAU;AAAA,MACtB,UAAU,UAAU,YAAY;AAAA,IAClC,CAAC;AAED,SAAK,wBAAwB,IAAI;AAAA,MAC/B,KAAK;AAAA,MACL;AAAA,IACF;AAEA,SAAK,UAAU,IAAI;AAAA,MACjB,KAAK;AAAA,MACL,KAAK;AAAA,IACP;AACA,SAAK,cAAc,IAAI,uCAAqB;AAC5C,SAAK,cAAc,IAAI,uCAAqB,KAAK,MAAM;AACvD,SAAK,YAAY,IAAI;AAAA,MACnB,KAAK;AAAA,MACL,KAAK;AAAA,MACL,UAAU;AAAA,IACZ;AAEA,SAAK,eAAe,IAAI;AAAA,MACtB,QAAQ,IAAI,iBAAiB,KAAK,KAAK;AAAA,MACvC,KAAK;AAAA,MACL,UAAU;AAAA,IACZ;AACA,SAAK,aACF,KAAK,EACL,KAAK,YAA2B;AAC/B,WAAK,OAAO,MAAM,4CAA4C;AAE9D,UAAI;AACF,cAAM,KAAK,aAAa,UAAU,UAAU,YAAY;AAAA,UACtD,QAAO,oBAAI,KAAK,GAAE,YAAY;AAAA,QAChC,CAAC;AAAA,MACH,SAAS,KAAK;AACZ,aAAK,OAAO,MAAM,0BAA0B;AAC5C,cAAM;AAAA,MACR;AAEA,WAAK,OAAO,MAAM,oBAAoB;AAAA,IACxC,CAAC,EACA,MAAM,CAAC,QAAQ;AACd,WAAK,OAAO,MAAM,yBAAyB;AAC3C,YAAM;AAAA,IACR,CAAC;AAAA,EACL;AAAA,EAEA,MAAM,QAAuB;AAC3B,UAAM,QAAQ,IAAI;AAAA,MAChB,KAAK,YAAY,MAAM;AAAA,MACvB,KAAK,sBAAsB,KAAK;AAAA,IAClC,CAAC;AAAA,EACH;AAAA,EAEA,MAAM,OAAsB;AAC1B,UAAM,QAAQ,IAAI;AAAA,MAChB,KAAK,YAAY,QAAQ;AAAA,MACzB,KAAK,sBAAsB,YAAY,MAAM;AAAA,MAC7C,KAAK,aAAa,OAAO;AAAA,IAC3B,CAAC;AAAA,EACH;AAAA,EAEA,IAAI,SAAiB;AACnB,WAAO,KAAK;AAAA,EACd;AAAA,EAEA,IAAI,SAA6B;AAC/B,WAAO,KAAK;AAAA,EACd;AAAA,EAEA,IAAI,WAAiC;AACnC,WAAO,KAAK;AAAA,EACd;AAAA,EAEA,IAAI,SAAY;AACd,WAAO,KAAK;AAAA,EACd;AAAA,EAEA,IAAI,aAAmC;AACrC,WAAO,KAAK;AAAA,EACd;AAAA,EAEA,IAAI,aAAmC;AACrC,WAAO,KAAK;AAAA,EACd;AAAA,EAEA,IAAI,cAAuC;AACzC,WAAO,KAAK;AAAA,EACd;AACF;",
  "names": []
}
