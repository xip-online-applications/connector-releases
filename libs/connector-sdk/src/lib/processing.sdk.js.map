{
  "version": 3,
  "sources": ["../../../../../../../libs/connector-sdk/src/lib/processing.sdk.ts"],
  "sourcesContent": ["import {\n  IntervalHandler,\n  LoggerSDKInterface,\n  ProcessingSDKInterface,\n  RegisterIntervalOptions,\n} from '@transai/connector-runtime-sdk';\nimport { interval, Subscription } from 'rxjs';\n\nexport class ProcessingSDKService implements ProcessingSDKInterface {\n  readonly #logger: LoggerSDKInterface;\n\n  readonly #intervals: {\n    [id: string]: {\n      interval: number;\n      handler: IntervalHandler;\n      options?: RegisterIntervalOptions;\n      subscription?: Subscription;\n    };\n  } = {};\n\n  constructor(logger: LoggerSDKInterface) {\n    this.#logger = logger;\n  }\n\n  async registerInterval(\n    intervalSeconds: number,\n    handler: IntervalHandler,\n    options?: RegisterIntervalOptions,\n  ): Promise<string> {\n    const name =\n      handler?.name ?? `interval-${Object.keys(this.#intervals).length + 1}`;\n\n    // eslint-disable-next-line security/detect-object-injection\n    if (this.#intervals[name]) {\n      throw new Error(`Interval with name ${name} already exists`);\n    }\n\n    // eslint-disable-next-line security/detect-object-injection\n    this.#intervals[name] = {\n      handler,\n      options,\n      interval: intervalSeconds,\n    };\n\n    return name;\n  }\n\n  async #runHandler(handler: IntervalHandler): Promise<void> {\n    try {\n      await handler.onRun();\n    } catch (error) {\n      this.#logger.error(\n        `Error running interval handler ${handler.name}: ${\n          (error as Error).message\n        }`,\n      );\n    }\n  }\n\n  async stopInterval(name: string): Promise<void> {\n    // eslint-disable-next-line security/detect-object-injection\n    const interval = this.#intervals[name];\n    if (!interval) {\n      return;\n    }\n\n    interval.subscription?.unsubscribe();\n\n    // eslint-disable-next-line security/detect-object-injection\n    delete this.#intervals[name];\n  }\n\n  async start(): Promise<void> {\n    await Promise.all(\n      Object.values(this.#intervals).map(async (intervalData) => {\n        if (intervalData.subscription) {\n          return;\n        }\n\n        // eslint-disable-next-line no-param-reassign\n        intervalData.subscription = interval(\n          intervalData.interval * 1_000,\n        ).subscribe(async () => {\n          await this.#runHandler(intervalData.handler);\n        });\n\n        if (intervalData.handler.onStop) {\n          intervalData.subscription.add(async () => {\n            await intervalData.handler.onStop();\n          });\n        }\n\n        if (intervalData.options?.immediate) {\n          await this.#runHandler(intervalData.handler);\n        }\n      }),\n    );\n  }\n\n  stopAll(): Promise<unknown> {\n    const stopPromises = Object.keys(this.#intervals).map((name) =>\n      this.stopInterval(name),\n    );\n\n    return Promise.all(stopPromises);\n  }\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAMA,kBAAuC;AAEhC,MAAM,qBAAuD;AAAA,EACzD;AAAA,EAEA,aAOL,CAAC;AAAA,EAEL,YAAY,QAA4B;AACtC,SAAK,UAAU;AAAA,EACjB;AAAA,EAEA,MAAM,iBACJ,iBACA,SACA,SACiB;AACjB,UAAM,OACJ,SAAS,QAAQ,YAAY,OAAO,KAAK,KAAK,UAAU,EAAE,SAAS,CAAC;AAGtE,QAAI,KAAK,WAAW,IAAI,GAAG;AACzB,YAAM,IAAI,MAAM,sBAAsB,IAAI,iBAAiB;AAAA,IAC7D;AAGA,SAAK,WAAW,IAAI,IAAI;AAAA,MACtB;AAAA,MACA;AAAA,MACA,UAAU;AAAA,IACZ;AAEA,WAAO;AAAA,EACT;AAAA,EAEA,MAAM,YAAY,SAAyC;AACzD,QAAI;AACF,YAAM,QAAQ,MAAM;AAAA,IACtB,SAAS,OAAO;AACd,WAAK,QAAQ;AAAA,QACX,kCAAkC,QAAQ,IAAI,KAC3C,MAAgB,OACnB;AAAA,MACF;AAAA,IACF;AAAA,EACF;AAAA,EAEA,MAAM,aAAa,MAA6B;AAE9C,UAAMA,YAAW,KAAK,WAAW,IAAI;AACrC,QAAI,CAACA,WAAU;AACb;AAAA,IACF;AAEA,IAAAA,UAAS,cAAc,YAAY;AAGnC,WAAO,KAAK,WAAW,IAAI;AAAA,EAC7B;AAAA,EAEA,MAAM,QAAuB;AAC3B,UAAM,QAAQ;AAAA,MACZ,OAAO,OAAO,KAAK,UAAU,EAAE,IAAI,OAAO,iBAAiB;AACzD,YAAI,aAAa,cAAc;AAC7B;AAAA,QACF;AAGA,qBAAa,mBAAe;AAAA,UAC1B,aAAa,WAAW;AAAA,QAC1B,EAAE,UAAU,YAAY;AACtB,gBAAM,KAAK,YAAY,aAAa,OAAO;AAAA,QAC7C,CAAC;AAED,YAAI,aAAa,QAAQ,QAAQ;AAC/B,uBAAa,aAAa,IAAI,YAAY;AACxC,kBAAM,aAAa,QAAQ,OAAO;AAAA,UACpC,CAAC;AAAA,QACH;AAEA,YAAI,aAAa,SAAS,WAAW;AACnC,gBAAM,KAAK,YAAY,aAAa,OAAO;AAAA,QAC7C;AAAA,MACF,CAAC;AAAA,IACH;AAAA,EACF;AAAA,EAEA,UAA4B;AAC1B,UAAM,eAAe,OAAO,KAAK,KAAK,UAAU,EAAE;AAAA,MAAI,CAAC,SACrD,KAAK,aAAa,IAAI;AAAA,IACxB;AAEA,WAAO,QAAQ,IAAI,YAAY;AAAA,EACjC;AACF;",
  "names": ["interval"]
}
