{
  "version": 3,
  "sources": ["../../../../../../../libs/connector-sdk/src/lib/receiver.sdk.ts"],
  "sourcesContent": ["import * as process from 'node:process';\n\nimport { ReceiverSDKInterface } from '@transai/connector-runtime-sdk';\nimport { expirationValidatorInLine } from '@xip-online-data/helper-functions';\nimport {\n  BadRequest,\n  Created,\n  InternalServerError,\n  KafkaSourceInterface,\n  NotFound,\n  Ok,\n  UnprocessableEntity,\n} from '@xip-online-data/kafka-base-service';\nimport {\n  ActionInterface,\n  BaseConnectorConfig,\n  KafkaCallbackResponse,\n  XodBaseMessageType,\n  XodJobType,\n} from '@xip-online-data/types';\n\nexport class ReceiverSDKService implements ReceiverSDKInterface {\n  readonly #IPC_CHANNEL = 'connector-runtime';\n\n  readonly #connectorConfig: BaseConnectorConfig;\n\n  readonly #kafkaServiceInstance!: KafkaSourceInterface;\n\n  readonly #actionConfigs: Array<ActionInterface>;\n\n  readonly responses = {\n    ok: Ok,\n    created: Created,\n    badRequest: BadRequest,\n    unprocessableEntity: UnprocessableEntity,\n    notFound: NotFound,\n    internalServerError: InternalServerError,\n  };\n\n  constructor(\n    apiConfig: BaseConnectorConfig,\n    kafkaServiceInstance: KafkaSourceInterface,\n    actions: Array<ActionInterface>,\n  ) {\n    this.#connectorConfig = apiConfig;\n    this.#kafkaServiceInstance = kafkaServiceInstance;\n    this.#actionConfigs = actions;\n  }\n\n  registerCallback<T extends XodJobType = XodJobType>(\n    callbackFunction: (message: T) => Promise<KafkaCallbackResponse>,\n    eventType?: string,\n    identifier?: string,\n  ): void {\n    this.#kafkaServiceInstance.setCallbackFunction(\n      this.#validateJobMessage(\n        expirationValidatorInLine(\n          this.#connectorConfig.action?.timeSensitive === true,\n          callbackFunction,\n        ),\n      ),\n      eventType,\n      identifier,\n    );\n  }\n\n  getActionConfig(message: XodJobType): ActionInterface | null {\n    if (!message.actionVersion || message.actionVersion === 'latest') {\n      return this.#getLatestActionConfig(message);\n    }\n\n    return this.#getSpecificActionConfig(message);\n  }\n\n  emitEventType<T extends XodJobType = XodJobType>(\n    callbackFunction: (message: T) => Promise<KafkaCallbackResponse>,\n  ): (message: T) => Promise<KafkaCallbackResponse> {\n    return (message: T) => {\n      this.#emitToIPCChannel(message.eventType);\n      return callbackFunction(message);\n    };\n  }\n\n  #emitToIPCChannel(message: string): void {\n    // Ensure process.send exists before sending\n    if (process.send) {\n      process.send({\n        cmd: this.#IPC_CHANNEL,\n        message,\n      });\n    }\n  }\n\n  #getLatestActionConfig(message: XodJobType): ActionInterface | null {\n    const actions = this.#actionConfigs.filter(\n      (action) => action.identifier === message.actionIdentifier,\n    );\n\n    if (actions.length === 0) {\n      return null;\n    }\n\n    return actions.sort((a, b) => {\n      return a.createdAt > b.createdAt ? -1 : 1;\n    })[0];\n  }\n\n  #getSpecificActionConfig(message: XodJobType): ActionInterface | null {\n    const actions = this.#actionConfigs.filter((action) => {\n      return (\n        action.identifier === message.actionIdentifier &&\n        action.version === message.actionVersion\n      );\n    });\n\n    if (actions.length !== 1) {\n      return null;\n    }\n\n    return actions[0];\n  }\n\n  #validateJobMessage(\n    callbackFunction: (message: XodJobType) => Promise<KafkaCallbackResponse>,\n  ): (message: XodBaseMessageType) => Promise<KafkaCallbackResponse> {\n    return async (message: XodBaseMessageType) => {\n      if (message.type !== 'JOB') {\n        // TODO: RETURN BAD REQUEST @YOURI, WHERE ARE THOSE FUNCTIONS?\n        throw new Error('BAD REQUEST, INVALID MESSAGE TYPE');\n      }\n      return callbackFunction(message as XodJobType);\n    };\n  }\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,cAAyB;AAGzB,8BAA0C;AAC1C,gCAQO;AASA,MAAM,mBAAmD;AAAA,EAkB9D,YACE,WACA,sBACA,SACA;AArBF,SAAS,eAAe;AAQxB,SAAS,YAAY;AAAA,MACnB,IAAI;AAAA,MACJ,SAAS;AAAA,MACT,YAAY;AAAA,MACZ,qBAAqB;AAAA,MACrB,UAAU;AAAA,MACV,qBAAqB;AAAA,IACvB;AAOE,SAAK,mBAAmB;AACxB,SAAK,wBAAwB;AAC7B,SAAK,iBAAiB;AAAA,EACxB;AAAA,EAzBS;AAAA,EAEA;AAAA,EAEA;AAAA,EAEA;AAAA,EAqBT,iBACE,kBACA,WACA,YACM;AACN,SAAK,sBAAsB;AAAA,MACzB,KAAK;AAAA,YACH;AAAA,UACE,KAAK,iBAAiB,QAAQ,kBAAkB;AAAA,UAChD;AAAA,QACF;AAAA,MACF;AAAA,MACA;AAAA,MACA;AAAA,IACF;AAAA,EACF;AAAA,EAEA,gBAAgB,SAA6C;AAC3D,QAAI,CAAC,QAAQ,iBAAiB,QAAQ,kBAAkB,UAAU;AAChE,aAAO,KAAK,uBAAuB,OAAO;AAAA,IAC5C;AAEA,WAAO,KAAK,yBAAyB,OAAO;AAAA,EAC9C;AAAA,EAEA,cACE,kBACgD;AAChD,WAAO,CAAC,YAAe;AACrB,WAAK,kBAAkB,QAAQ,SAAS;AACxC,aAAO,iBAAiB,OAAO;AAAA,IACjC;AAAA,EACF;AAAA,EAEA,kBAAkB,SAAuB;AAEvC,QAAI,QAAQ,MAAM;AAChB,cAAQ,KAAK;AAAA,QACX,KAAK,KAAK;AAAA,QACV;AAAA,MACF,CAAC;AAAA,IACH;AAAA,EACF;AAAA,EAEA,uBAAuB,SAA6C;AAClE,UAAM,UAAU,KAAK,eAAe;AAAA,MAClC,CAAC,WAAW,OAAO,eAAe,QAAQ;AAAA,IAC5C;AAEA,QAAI,QAAQ,WAAW,GAAG;AACxB,aAAO;AAAA,IACT;AAEA,WAAO,QAAQ,KAAK,CAAC,GAAG,MAAM;AAC5B,aAAO,EAAE,YAAY,EAAE,YAAY,KAAK;AAAA,IAC1C,CAAC,EAAE,CAAC;AAAA,EACN;AAAA,EAEA,yBAAyB,SAA6C;AACpE,UAAM,UAAU,KAAK,eAAe,OAAO,CAAC,WAAW;AACrD,aACE,OAAO,eAAe,QAAQ,oBAC9B,OAAO,YAAY,QAAQ;AAAA,IAE/B,CAAC;AAED,QAAI,QAAQ,WAAW,GAAG;AACxB,aAAO;AAAA,IACT;AAEA,WAAO,QAAQ,CAAC;AAAA,EAClB;AAAA,EAEA,oBACE,kBACiE;AACjE,WAAO,OAAO,YAAgC;AAC5C,UAAI,QAAQ,SAAS,OAAO;AAE1B,cAAM,IAAI,MAAM,mCAAmC;AAAA,MACrD;AACA,aAAO,iBAAiB,OAAqB;AAAA,IAC/C;AAAA,EACF;AACF;",
  "names": []
}
