{
  "version": 3,
  "sources": ["../../../../../../../../../libs/datasource/src/lib/driver/postgres/postgres-connection.driver.ts"],
  "sourcesContent": ["import * as postgres from 'pg';\nimport { builtins } from 'pg-types';\nimport { Driver } from '../driver';\nimport { DatasourceService } from '../../datasource.service';\nimport { PostgresConnectionOptions } from './postgres-connection.options';\nimport { PostgresConnectionCredentialsOptions } from './postgres-connection-credentials.options';\nimport { QueryRunnerInterface } from '../query-runner.interface';\nimport { PostgresQueryRunner } from './postgres.query-runner';\nimport { TypeORMError } from '../error';\nimport { Logger } from '@transai/logger';\nconst { types } = postgres;\n\nexport class PostgresConnectionDriver implements Driver {\n  database: string;\n\n  options: PostgresConnectionOptions;\n\n  postgres: any;\n\n  connection: DatasourceService;\n\n  /**\n   * Pool for master database.\n   */\n  master: any;\n\n  /**\n   * Version of Postgres. Requires a SQL query to the DB, so it is not always set\n   */\n  version?: string;\n\n  /**\n   * We store all created query runners because we need to release them.\n   */\n  connectedQueryRunners: Array<QueryRunnerInterface> = [];\n\n  constructor(connection: DatasourceService) {\n    this.connection = connection;\n    this.options = connection.options as PostgresConnectionOptions;\n    this.database = this.options.database;\n    this.loadDependencies();\n  }\n\n  protected loadDependencies(): void {\n    try {\n      Logger.getInstance().info('Loading Postgres driver');\n      if (this.options.disableParsing) {\n        Logger.getInstance().info('Disable parsing of datetime types');\n        const overrideTypes = [\n          builtins.DATE,\n          builtins.TIME,\n          builtins.TIMETZ,\n          builtins.TIMESTAMP,\n          builtins.TIMESTAMPTZ,\n        ];\n\n        overrideTypes.forEach((type) => {\n          types.setTypeParser(type, (value: string) => {\n            return value;\n          });\n        });\n      } else {\n        Logger.getInstance().info('Enable parsing of datetime types (DEFAULT)');\n      }\n      this.postgres = postgres;\n      // try {\n      //     // TODO: Rene: ik laat deze erin staan, want dit is een driver die erg dicht tegen de C library aan zit.\n      //     // Echter moet je daarvoor wel de C library hebben geinstalleerd. Dat is niet altijd het geval, bijvoobeeld momenteel op mijn pc :).\n      //     const pgNative = require(\"pg-native\")\n      //     if (pgNative && this.postgres.native)\n      //         this.postgres = this.postgres.native\n      // } catch (e) {}\n    } catch (e) {\n      // todo: better error for browser env\n      // throw new DriverPackageNotInstalledError(\"Postgres\", \"pg\")\n    }\n  }\n\n  async connect(): Promise<void> {\n    this.master = await this.createPool(this.options, this.options);\n  }\n\n  async afterConnect(): Promise<void> {\n    const [connection, release] = await this.obtainMasterConnection();\n\n    const results = (await this.executeQuery(\n      connection,\n      'SELECT version();',\n    )) as {\n      rows: Array<{\n        version: string;\n      }>;\n    };\n    this.version = results.rows[0].version.replace(\n      /^PostgreSQL ([\\d\\.]+) .*$/,\n      '$1',\n    );\n\n    await release();\n  }\n\n  disconnect(): Promise<void> {\n    return Promise.resolve(undefined);\n  }\n\n  /**\n   * Creates a new connection pool for a given database credentials.\n   */\n  protected async createPool(\n    options: PostgresConnectionOptions,\n    credentials: PostgresConnectionCredentialsOptions,\n  ): Promise<any> {\n    // const { logger } = this.connection\n    credentials = { ...credentials };\n\n    // build connection options for the driver\n    // See: https://github.com/brianc/node-postgres/tree/master/packages/pg-pool#create\n    const connectionOptions = {\n      host: credentials.host,\n      user: credentials.username,\n      password: credentials.password,\n      database: credentials.database,\n      port: credentials.port,\n      ssl: credentials.ssl,\n      connectionTimeoutMillis: options.connectTimeoutMS,\n      application_name: options.applicationName,\n      max: options.poolSize,\n    };\n\n    // create a connection pool\n    const pool = new this.postgres.Pool(connectionOptions);\n\n    // const poolErrorHandler =\n    //     // options.poolErrorHandler ||\n    //     ((error: any) =>\n    //         logger.log(\"warn\", `Postgres pool raised an error. ${error}`))\n\n    /*\n          Attaching an error handler to pool errors is essential, as, otherwise, errors raised will go unhandled and\n          cause the hosting app to crash.\n         */\n    // pool.on(\"error\", poolErrorHandler)\n\n    return new Promise((ok, fail) => {\n      pool.connect((err: any, connection: any, release: Function) => {\n        if (err) return fail(err);\n\n        // if (options.logNotifications) {\n        //     connection.on(\"notice\", (msg: any) => {\n        //         msg && this.connection.logger.log(\"info\", msg.message)\n        //     })\n        //     connection.on(\"notification\", (msg: any) => {\n        //         msg &&\n        //         this.connection.logger.log(\n        //             \"info\",\n        //             `Received NOTIFY on channel ${msg.channel}: ${msg.payload}.`,\n        //         )\n        //     })\n        // }\n        release();\n        ok(pool);\n      });\n    });\n  }\n\n  /**\n   * Obtains a new database connection to a master server.\n   * Used for replication.\n   * If replication is not setup then returns default connection's database connection.\n   */\n  async obtainMasterConnection(): Promise<[any, Function]> {\n    if (!this.master) {\n      throw new TypeORMError('Driver not Connected');\n    }\n\n    return new Promise((ok, fail) => {\n      this.master.connect((err: any, connection: any, release: any) => {\n        err ? fail(err) : ok([connection, release]);\n      });\n    });\n  }\n\n  /**\n   * Executes given query.\n   */\n  protected executeQuery(connection: any, query: string) {\n    // this.connection.logger.logQuery(query)\n\n    return new Promise((ok, fail) => {\n      connection.query(query, (err: any, result: any) =>\n        err ? fail(err) : ok(result),\n      );\n    });\n  }\n\n  createQueryRunner(): QueryRunnerInterface {\n    return new PostgresQueryRunner(this);\n  }\n}\n"],
  "mappings": "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",
  "names": []
}
