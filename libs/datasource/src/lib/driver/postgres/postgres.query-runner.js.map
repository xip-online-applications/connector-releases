{
  "version": 3,
  "sources": ["../../../../../../../../../libs/datasource/src/lib/driver/postgres/postgres.query-runner.ts"],
  "sourcesContent": ["import { QueryRunnerInterface } from '../query-runner.interface';\nimport { DatasourceService } from '../../datasource.service';\nimport { PostgresConnectionDriver } from './postgres-connection.driver';\nimport { QueryResult } from '../query-result';\nimport { QueryRunnerAlreadyReleasedError } from '../error';\n\nexport class PostgresQueryRunner implements QueryRunnerInterface {\n  driver: PostgresConnectionDriver;\n\n  readonly connection: DatasourceService;\n\n  isReleased: boolean;\n\n  isTransactionActive: boolean;\n\n  /**\n   * Special callback provided by a driver used to release a created connection.\n   */\n  protected releaseCallback?: (err: any) => void;\n\n  /**\n   * Real database connection from a connection pool used to perform queries.\n   */\n  protected databaseConnection: any;\n\n  /**\n   * Promise used to obtain a database connection from a pool for a first time.\n   */\n  protected databaseConnectionPromise: Promise<any> | undefined;\n\n  constructor(driver: PostgresConnectionDriver) {\n    this.driver = driver;\n    this.connection = driver.connection;\n    this.isReleased = false;\n    this.isTransactionActive = false;\n  }\n\n  connect(): Promise<any> {\n    if (this.databaseConnection)\n      return Promise.resolve(this.databaseConnection);\n\n    if (this.databaseConnectionPromise) return this.databaseConnectionPromise;\n\n    this.databaseConnectionPromise = this.driver\n      .obtainMasterConnection()\n      .then(([connection, release]: Array<any>) => {\n        this.driver.connectedQueryRunners.push(this);\n        this.databaseConnection = connection;\n\n        const onErrorCallback = (err: Error) =>\n          this.releasePostgresConnection(err);\n        this.releaseCallback = (err?: Error) => {\n          this.databaseConnection.removeListener('error', onErrorCallback);\n          release(err);\n        };\n        this.databaseConnection.on('error', onErrorCallback);\n\n        return this.databaseConnection;\n      });\n\n    return this.databaseConnectionPromise;\n  }\n\n  async query(query: string, parameters?: Array<any>): Promise<QueryResult> {\n    if (this.isReleased) throw new QueryRunnerAlreadyReleasedError();\n\n    const databaseConnection = await this.connect();\n\n    // this.driver.connection.logger.logQuery(query, parameters, this);\n    try {\n      const queryStartTime = +new Date();\n      const raw = await databaseConnection.query(query, parameters);\n      // log slow queries if maxQueryExecution time is set\n      const { maxQueryExecutionTime } = this.driver.options;\n      const queryEndTime = +new Date();\n      const queryExecutionTime = queryEndTime - queryStartTime;\n      // if (\n      //     maxQueryExecutionTime &&\n      //     queryExecutionTime > maxQueryExecutionTime\n      // )\n      //     this.driver.connection.logger.logQuerySlow(\n      //         queryExecutionTime,\n      //         query,\n      //         parameters,\n      //         this,\n      //     )\n\n      const result = new QueryResult();\n\n      if (raw) {\n        if (raw.hasOwnProperty('rows')) {\n          result.records = raw.rows;\n        }\n\n        if (raw.hasOwnProperty('rowCount')) {\n          result.affected = raw.rowCount;\n        }\n\n        switch (raw.command) {\n          case 'DELETE':\n          case 'UPDATE':\n            // for UPDATE and DELETE query additionally return number of affected rows\n            result.raw = [raw.rows, raw.rowCount];\n            break;\n          default:\n            result.raw = raw.rows;\n        }\n      }\n\n      return result;\n    } catch (err) {\n      // this.driver.connection.logger.logQueryError(\n      //     err,\n      //     query,\n      //     parameters,\n      //     this,\n      // )\n      // throw new QueryFailedError(query, parameters, err)\n      throw err;\n    }\n  }\n\n  release(): Promise<void> {\n    return this.releasePostgresConnection();\n  }\n\n  private async releasePostgresConnection(err?: Error) {\n    if (this.isReleased) {\n      return;\n    }\n\n    this.isReleased = true;\n    if (this.releaseCallback) {\n      this.releaseCallback(err);\n      this.releaseCallback = undefined;\n    }\n\n    const index = this.driver.connectedQueryRunners.indexOf(this);\n\n    if (index !== -1) {\n      this.driver.connectedQueryRunners.splice(index, 1);\n    }\n  }\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAGA,0BAA4B;AAC5B,mBAAgD;AAEzC,MAAM,oBAAoD;AAAA,EAwB/D,YAAY,QAAkC;AAC5C,SAAK,SAAS;AACd,SAAK,aAAa,OAAO;AACzB,SAAK,aAAa;AAClB,SAAK,sBAAsB;AAAA,EAC7B;AAAA,EAEA,UAAwB;AACtB,QAAI,KAAK;AACP,aAAO,QAAQ,QAAQ,KAAK,kBAAkB;AAEhD,QAAI,KAAK;AAA2B,aAAO,KAAK;AAEhD,SAAK,4BAA4B,KAAK,OACnC,uBAAuB,EACvB,KAAK,CAAC,CAAC,YAAY,OAAO,MAAkB;AAC3C,WAAK,OAAO,sBAAsB,KAAK,IAAI;AAC3C,WAAK,qBAAqB;AAE1B,YAAM,kBAAkB,CAAC,QACvB,KAAK,0BAA0B,GAAG;AACpC,WAAK,kBAAkB,CAAC,QAAgB;AACtC,aAAK,mBAAmB,eAAe,SAAS,eAAe;AAC/D,gBAAQ,GAAG;AAAA,MACb;AACA,WAAK,mBAAmB,GAAG,SAAS,eAAe;AAEnD,aAAO,KAAK;AAAA,IACd,CAAC;AAEH,WAAO,KAAK;AAAA,EACd;AAAA,EAEA,MAAM,MAAM,OAAe,YAA+C;AACxE,QAAI,KAAK;AAAY,YAAM,IAAI,6CAAgC;AAE/D,UAAM,qBAAqB,MAAM,KAAK,QAAQ;AAG9C,QAAI;AACF,YAAM,iBAAiB,CAAC,oBAAI,KAAK;AACjC,YAAM,MAAM,MAAM,mBAAmB,MAAM,OAAO,UAAU;AAE5D,YAAM,EAAE,sBAAsB,IAAI,KAAK,OAAO;AAC9C,YAAM,eAAe,CAAC,oBAAI,KAAK;AAC/B,YAAM,qBAAqB,eAAe;AAY1C,YAAM,SAAS,IAAI,gCAAY;AAE/B,UAAI,KAAK;AACP,YAAI,IAAI,eAAe,MAAM,GAAG;AAC9B,iBAAO,UAAU,IAAI;AAAA,QACvB;AAEA,YAAI,IAAI,eAAe,UAAU,GAAG;AAClC,iBAAO,WAAW,IAAI;AAAA,QACxB;AAEA,gBAAQ,IAAI,SAAS;AAAA,UACnB,KAAK;AAAA,UACL,KAAK;AAEH,mBAAO,MAAM,CAAC,IAAI,MAAM,IAAI,QAAQ;AACpC;AAAA,UACF;AACE,mBAAO,MAAM,IAAI;AAAA,QACrB;AAAA,MACF;AAEA,aAAO;AAAA,IACT,SAAS,KAAK;AAQZ,YAAM;AAAA,IACR;AAAA,EACF;AAAA,EAEA,UAAyB;AACvB,WAAO,KAAK,0BAA0B;AAAA,EACxC;AAAA,EAEA,MAAc,0BAA0B,KAAa;AACnD,QAAI,KAAK,YAAY;AACnB;AAAA,IACF;AAEA,SAAK,aAAa;AAClB,QAAI,KAAK,iBAAiB;AACxB,WAAK,gBAAgB,GAAG;AACxB,WAAK,kBAAkB;AAAA,IACzB;AAEA,UAAM,QAAQ,KAAK,OAAO,sBAAsB,QAAQ,IAAI;AAE5D,QAAI,UAAU,IAAI;AAChB,WAAK,OAAO,sBAAsB,OAAO,OAAO,CAAC;AAAA,IACnD;AAAA,EACF;AACF;",
  "names": []
}
