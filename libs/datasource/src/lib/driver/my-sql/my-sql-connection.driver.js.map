{
  "version": 3,
  "sources": ["../../../../../../../../../libs/datasource/src/lib/driver/my-sql/my-sql-connection.driver.ts"],
  "sourcesContent": ["import * as mysql from 'mysql2/promise';\nimport { Driver } from '../driver';\nimport { MySqlConnectionOptions } from './my-sql-connection.options';\nimport { DatasourceService } from '../../datasource.service';\nimport { MySqlConnectionCredentialsOptions } from './my-sql-connection-credentials.options';\nimport { MySqlQueryRunner } from './my-sql.query-runner';\n\nexport class MySqlConnectionDriver implements Driver {\n  options: MySqlConnectionOptions;\n\n  connection: DatasourceService;\n\n  /**\n   * Connection pool.\n   */\n  pool: any;\n\n  /**\n   * Master database used to perform all write queries.\n   */\n  database: string;\n\n  /**\n   * Version of MySQL. Requires a SQL query to the DB, so it is not always set\n   */\n  version?: string;\n\n  constructor(connection: DatasourceService) {\n    this.options = connection.options as MySqlConnectionOptions;\n    this.connection = connection;\n    this.database = this.options.database;\n  }\n\n  async connect(): Promise<void> {\n    this.pool = await this.createPool(\n      this.createConnectionOptions(this.options, this.options),\n    );\n\n    const queryRunner = this.createQueryRunner();\n    const result = await queryRunner.query(`SELECT VERSION() AS \\`version\\``);\n    this.version = result.records[0].version;\n\n    await queryRunner.release();\n  }\n\n  afterConnect(): Promise<void> {\n    return Promise.resolve(undefined);\n  }\n\n  disconnect(): Promise<void> {\n    return Promise.resolve(undefined);\n  }\n\n  /**\n   * Creates a new connection pool for a given database credentials.\n   */\n  protected createConnectionOptions(\n    options: MySqlConnectionOptions,\n    credentials: MySqlConnectionCredentialsOptions,\n  ): mysql.PoolOptions {\n    return {\n      charset: options.charset,\n      connectTimeout: options.connectTimeout,\n      insecureAuth: options.insecureAuth,\n      supportBigNumbers:\n        options.supportBigNumbers !== undefined\n          ? options.supportBigNumbers\n          : true,\n      bigNumberStrings:\n        options.bigNumberStrings !== undefined\n          ? options.bigNumberStrings\n          : true,\n      dateStrings: options.dateStrings as\n        | boolean\n        | Array<'TIMESTAMP' | 'DATETIME' | 'DATE'>,\n      debug: options.debug,\n      trace: options.trace,\n      multipleStatements: options.multipleStatements,\n      flags: options.flags,\n      host: credentials.host,\n      user: credentials.username,\n      password: credentials.password,\n      database: credentials.database,\n      port: credentials.port,\n      ssl: options.ssl,\n      socketPath: credentials.socketPath,\n      connectionLimit: options.poolSize,\n    };\n  }\n\n  /**\n   * Creates a new connection pool for a given database credentials.\n   */\n  protected async createPool(\n    connectionOptions: mysql.PoolOptions,\n  ): Promise<mysql.Pool> {\n    // create a connection pool\n    const pool = mysql.createPool(connectionOptions);\n    // get a connection from the pool\n    const conn = // Ignore the IDE message cause it is a mysql2 promise connection,\n      // and not the regular mysql2 that the ide thinks. IT WORKS!\n      (await pool.getConnection()) as unknown as mysql.PoolConnection;\n    conn.release();\n    return pool;\n  }\n\n  /**\n   * Obtains a new database connection to a master server.\n   * Used for replication.\n   * If replication is not setup then returns default connection's database connection.\n   */\n  obtainConnection(): Promise<any> {\n    return this.pool.getConnection();\n  }\n\n  /**\n   * Creates a query runner used to execute database queries.\n   */\n  createQueryRunner() {\n    return new MySqlQueryRunner(this);\n  }\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,YAAuB;AAKvB,oBAAiC;AAE1B,MAAM,sBAAwC;AAAA,EAoBnD,YAAY,YAA+B;AACzC,SAAK,UAAU,WAAW;AAC1B,SAAK,aAAa;AAClB,SAAK,WAAW,KAAK,QAAQ;AAAA,EAC/B;AAAA,EAEA,MAAM,UAAyB;AAC7B,SAAK,OAAO,MAAM,KAAK;AAAA,MACrB,KAAK,wBAAwB,KAAK,SAAS,KAAK,OAAO;AAAA,IACzD;AAEA,UAAM,cAAc,KAAK,kBAAkB;AAC3C,UAAM,SAAS,MAAM,YAAY,MAAM,iCAAiC;AACxE,SAAK,UAAU,OAAO,QAAQ,CAAC,EAAE;AAEjC,UAAM,YAAY,QAAQ;AAAA,EAC5B;AAAA,EAEA,eAA8B;AAC5B,WAAO,QAAQ,QAAQ,MAAS;AAAA,EAClC;AAAA,EAEA,aAA4B;AAC1B,WAAO,QAAQ,QAAQ,MAAS;AAAA,EAClC;AAAA;AAAA;AAAA;AAAA,EAKU,wBACR,SACA,aACmB;AACnB,WAAO;AAAA,MACL,SAAS,QAAQ;AAAA,MACjB,gBAAgB,QAAQ;AAAA,MACxB,cAAc,QAAQ;AAAA,MACtB,mBACE,QAAQ,sBAAsB,SAC1B,QAAQ,oBACR;AAAA,MACN,kBACE,QAAQ,qBAAqB,SACzB,QAAQ,mBACR;AAAA,MACN,aAAa,QAAQ;AAAA,MAGrB,OAAO,QAAQ;AAAA,MACf,OAAO,QAAQ;AAAA,MACf,oBAAoB,QAAQ;AAAA,MAC5B,OAAO,QAAQ;AAAA,MACf,MAAM,YAAY;AAAA,MAClB,MAAM,YAAY;AAAA,MAClB,UAAU,YAAY;AAAA,MACtB,UAAU,YAAY;AAAA,MACtB,MAAM,YAAY;AAAA,MAClB,KAAK,QAAQ;AAAA,MACb,YAAY,YAAY;AAAA,MACxB,iBAAiB,QAAQ;AAAA,IAC3B;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,MAAgB,WACd,mBACqB;AAErB,UAAM,OAAO,MAAM,WAAW,iBAAiB;AAE/C,UAAM;AAAA;AAAA;AAAA,MAEH,MAAM,KAAK,cAAc;AAAA;AAC5B,SAAK,QAAQ;AACb,WAAO;AAAA,EACT;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAOA,mBAAiC;AAC/B,WAAO,KAAK,KAAK,cAAc;AAAA,EACjC;AAAA;AAAA;AAAA;AAAA,EAKA,oBAAoB;AAClB,WAAO,IAAI,+BAAiB,IAAI;AAAA,EAClC;AACF;",
  "names": []
}
