{
  "version": 3,
  "sources": ["../../../../../../../../../libs/datasource/src/lib/driver/sql-server/sql-server.query-runner.ts"],
  "sourcesContent": ["import { QueryRunnerInterface } from '../query-runner.interface';\nimport { DatasourceService } from '../../datasource.service';\nimport { SqlServerConnectionDriver } from './sql-server-connection.driver';\nimport { QueryResult } from '../query-result';\nimport { QueryFailedError, QueryRunnerAlreadyReleasedError } from '../error';\n\nexport class SqlServerQueryRunner implements QueryRunnerInterface {\n  driver: SqlServerConnectionDriver;\n\n  readonly connection: DatasourceService;\n\n  isReleased: boolean;\n\n  isTransactionActive: boolean;\n\n  constructor(driver: SqlServerConnectionDriver) {\n    this.driver = driver;\n    this.connection = driver.connection;\n    this.isReleased = false;\n    this.isTransactionActive = false;\n  }\n\n  /**\n   * Creates/uses database connection from the connection pool to perform further operations.\n   * Returns obtained database connection.\n   */\n  connect(): Promise<void> {\n    return Promise.resolve();\n  }\n\n  /**\n   * Executes a given SQL query.\n   */\n  async query(query: string, parameters?: Array<any>): Promise<any> {\n    if (this.isReleased) throw new QueryRunnerAlreadyReleasedError();\n\n    try {\n      const pool = await this.driver.obtainMasterConnection();\n      const request = new this.driver.mssql.Request(pool);\n      if (parameters && parameters.length) {\n        parameters.forEach((parameter, index) => {\n          const parameterName = index.toString();\n          request.input(parameterName, parameter);\n        });\n      }\n      const queryStartTime = +new Date();\n\n      const raw = await new Promise<any>((ok, fail) => {\n        request.query(query, (err: any, raw: any) => {\n          // log slow queries if maxQueryExecution time is set\n          const { maxQueryExecutionTime } = this.driver.options;\n          const queryEndTime = +new Date();\n          const queryExecutionTime = queryEndTime - queryStartTime;\n\n          if (err) {\n            fail(new QueryFailedError(query, parameters, err));\n          }\n\n          ok(raw);\n        });\n      });\n\n      const result = new QueryResult();\n\n      if (raw?.hasOwnProperty('recordset')) {\n        result.records = raw.recordset;\n      }\n\n      if (raw?.hasOwnProperty('rowsAffected')) {\n        result.affected = raw.rowsAffected[0];\n      }\n\n      const queryType = query.slice(0, query.indexOf(' '));\n      switch (queryType) {\n        case 'DELETE':\n          // for DELETE query additionally return number of affected rows\n          result.raw = [raw.recordset, raw.rowsAffected[0]];\n          break;\n        default:\n          result.raw = raw.recordset;\n      }\n\n      return result;\n    } catch (err) {\n      throw err;\n    }\n  }\n\n  release(): Promise<void> {\n    this.isReleased = true;\n    return Promise.resolve();\n  }\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAGA,0BAA4B;AAC5B,mBAAkE;AAE3D,MAAM,qBAAqD;AAAA,EAShE,YAAY,QAAmC;AAC7C,SAAK,SAAS;AACd,SAAK,aAAa,OAAO;AACzB,SAAK,aAAa;AAClB,SAAK,sBAAsB;AAAA,EAC7B;AAAA;AAAA;AAAA;AAAA;AAAA,EAMA,UAAyB;AACvB,WAAO,QAAQ,QAAQ;AAAA,EACzB;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,MAAM,OAAe,YAAuC;AAChE,QAAI,KAAK;AAAY,YAAM,IAAI,6CAAgC;AAE/D,QAAI;AACF,YAAM,OAAO,MAAM,KAAK,OAAO,uBAAuB;AACtD,YAAM,UAAU,IAAI,KAAK,OAAO,MAAM,QAAQ,IAAI;AAClD,UAAI,cAAc,WAAW,QAAQ;AACnC,mBAAW,QAAQ,CAAC,WAAW,UAAU;AACvC,gBAAM,gBAAgB,MAAM,SAAS;AACrC,kBAAQ,MAAM,eAAe,SAAS;AAAA,QACxC,CAAC;AAAA,MACH;AACA,YAAM,iBAAiB,CAAC,oBAAI,KAAK;AAEjC,YAAM,MAAM,MAAM,IAAI,QAAa,CAAC,IAAI,SAAS;AAC/C,gBAAQ,MAAM,OAAO,CAAC,KAAUA,SAAa;AAE3C,gBAAM,EAAE,sBAAsB,IAAI,KAAK,OAAO;AAC9C,gBAAM,eAAe,CAAC,oBAAI,KAAK;AAC/B,gBAAM,qBAAqB,eAAe;AAE1C,cAAI,KAAK;AACP,iBAAK,IAAI,8BAAiB,OAAO,YAAY,GAAG,CAAC;AAAA,UACnD;AAEA,aAAGA,IAAG;AAAA,QACR,CAAC;AAAA,MACH,CAAC;AAED,YAAM,SAAS,IAAI,gCAAY;AAE/B,UAAI,KAAK,eAAe,WAAW,GAAG;AACpC,eAAO,UAAU,IAAI;AAAA,MACvB;AAEA,UAAI,KAAK,eAAe,cAAc,GAAG;AACvC,eAAO,WAAW,IAAI,aAAa,CAAC;AAAA,MACtC;AAEA,YAAM,YAAY,MAAM,MAAM,GAAG,MAAM,QAAQ,GAAG,CAAC;AACnD,cAAQ,WAAW;AAAA,QACjB,KAAK;AAEH,iBAAO,MAAM,CAAC,IAAI,WAAW,IAAI,aAAa,CAAC,CAAC;AAChD;AAAA,QACF;AACE,iBAAO,MAAM,IAAI;AAAA,MACrB;AAEA,aAAO;AAAA,IACT,SAAS,KAAK;AACZ,YAAM;AAAA,IACR;AAAA,EACF;AAAA,EAEA,UAAyB;AACvB,SAAK,aAAa;AAClB,WAAO,QAAQ,QAAQ;AAAA,EACzB;AACF;",
  "names": ["raw"]
}
