{
  "version": 3,
  "sources": ["../../../../../../../libs/connector-runner-api-sink/src/lib/connector-runner-api-sink.ts"],
  "sourcesContent": ["import { ConnectorRuntime } from '@transai/connector-runtime';\nimport {\n  ActionInterface,\n  BaseConnectorConfig,\n  ConnectorInterface,\n  KafkaCallbackResponse,\n  XodActionType,\n  XodBaseMessageType,\n  XodJobType,\n} from '@xip-online-data/types';\nimport { HttpClient } from '@xip-online-data/http-client';\nimport {\n  BadRequest,\n  Created,\n  InternalServerError,\n} from '@xip-online-data/kafka-base-service';\nimport { Logger } from '@transai/logger';\nimport { ApiSinkConfig } from './types';\n\nexport class ConnectorRunnerApiSink extends ConnectorRuntime<ApiSinkConfig> {\n  readonly CONNECTOR_INSTANCE: string = 'XOD_CONNECTOR_API_SINK_CONFIG';\n\n  private httpClientInstance: HttpClient | undefined;\n\n  private get httpClient(): HttpClient {\n    if (this.httpClientInstance === undefined) {\n      throw new Error('Samba client not initialized');\n    }\n    return this.httpClientInstance;\n  }\n\n  constructor(\n    connector: ConnectorInterface,\n    apiConfig: ApiSinkConfig & BaseConnectorConfig,\n    actionConfigs: Array<ActionInterface>,\n    readonly injectedHttpClientInstance?: HttpClient,\n  ) {\n    super(connector, apiConfig, actionConfigs);\n    this.httpClientInstance = injectedHttpClientInstance;\n  }\n\n  override init = async (): Promise<void> => {\n    if (this.httpClientInstance === undefined) {\n      this.httpClientInstance = new HttpClient(this.config.http);\n    }\n    await this.httpClient.init();\n\n    const jobCallbackFunction = (\n      callbackFunction: (\n        message: XodBaseMessageType,\n      ) => Promise<KafkaCallbackResponse>,\n    ) => {\n      return async (m: XodBaseMessageType) => {\n        if (m.type !== 'JOB') {\n          return callbackFunction(m);\n        }\n\n        const message = m as XodJobType;\n        let action: ActionInterface;\n        try {\n          action = this.getActionConfig(message);\n        } catch (error: unknown) {\n          if (error instanceof Error) {\n            return BadRequest(`No action found: ${error.message}`)(message);\n          }\n          return BadRequest('Unknown error occured')(message);\n        }\n\n        try {\n          const handleBars = action.config['parsedTemplates'] as {\n            url: HandlebarsTemplateDelegate<unknown>;\n            body: HandlebarsTemplateDelegate<unknown>;\n          };\n\n          const parsedUrl = handleBars\n            .url({\n              inputs: message.payload,\n            })\n            .trim();\n\n          const parsedBody = handleBars\n            .body({\n              inputs: message.payload,\n            })\n            .trim();\n\n          if (message.testRun) {\n            Logger.getInstance().info(\n              `Test run for ${message.eventId} with payload ${parsedBody} to path ${parsedUrl}`,\n            );\n            return callbackFunction(message);\n          }\n\n          const result = await this.httpClient.post(parsedUrl, parsedBody);\n          if (result.success) {\n            return callbackFunction(message);\n          }\n          return InternalServerError(result.data)(message);\n        } catch (error: unknown) {\n          if (error instanceof Error) {\n            return InternalServerError(error.message)(message);\n          }\n          return InternalServerError('Unknown error occured')(message);\n        }\n      };\n    };\n\n    const actionCallbackFunction = (\n      callbackFunction: (\n        message: XodBaseMessageType,\n      ) => Promise<KafkaCallbackResponse>,\n    ) => {\n      return async (m: XodBaseMessageType) => {\n        if (m.type !== 'ACTION') {\n          return callbackFunction(m);\n        }\n\n        const message = m as XodActionType;\n        try {\n          if (!message.payload.destination || !message.payload.content) {\n            return BadRequest('Destination or content not found')(message);\n          }\n\n          const result = await this.httpClient.post(\n            message.payload.destination,\n            message.payload.content,\n          );\n          if (result.success) {\n            return callbackFunction(message);\n          }\n          return InternalServerError(result.data)(message);\n        } catch (error) {\n          if (error instanceof Error) {\n            return InternalServerError(error.message)(message);\n          }\n          return InternalServerError('Unknown error occurred')(message);\n        }\n      };\n    };\n\n    this.callbackFunction = jobCallbackFunction(\n      actionCallbackFunction(this.emitEventType(Created())),\n    );\n  };\n}\n"],
  "mappings": "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",
  "names": []
}
