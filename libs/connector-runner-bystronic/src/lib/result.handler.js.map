{
  "version": 3,
  "sources": ["../../../../../../../libs/connector-runner-bystronic/src/lib/result.handler.ts"],
  "sourcesContent": ["import { ConnectorSDKInterface } from '@transai/connector-runtime-sdk';\nimport { OpcuaInterface } from '@transai/opcua-client';\nimport jsonata from 'jsonata';\nimport { DataType, Variant } from 'node-opcua';\n\nimport {\n  BystronicGetRunPartHistoryResponse,\n  BystronicPartInfoResponse,\n  CallConfig,\n  ConnectorConfig,\n} from './types';\n\nexport class ResultHandler {\n  readonly #OPCUA_ID_JSONATA_EXPRESSION = 'JobGuid';\n\n  readonly #INCREMENTAL_FIELD_JSONATA_EXPRESSION = 'TimeStamp';\n\n  readonly #sdk: ConnectorSDKInterface<ConnectorConfig>;\n\n  readonly #opcuaClient: OpcuaInterface;\n\n  readonly #idExpression = jsonata(this.#OPCUA_ID_JSONATA_EXPRESSION);\n\n  constructor(\n    sdk: ConnectorSDKInterface<ConnectorConfig>,\n    opcuaClient: OpcuaInterface,\n  ) {\n    this.#sdk = sdk;\n    this.#opcuaClient = opcuaClient;\n  }\n\n  async handleResult(\n    result: string,\n    opcUaCallConfig: CallConfig,\n  ): Promise<void> {\n    this.#sdk.logger.debug(`Handling result for ${opcUaCallConfig.name}`);\n\n    // for Bystronic it is Json, not in general\n    const data = JSON.parse(\n      result,\n    ) as Array<BystronicGetRunPartHistoryResponse>;\n\n    if (!Array.isArray(data)) {\n      await this.#sendBatch(data, opcUaCallConfig);\n      return;\n    }\n\n    const messages = await this.#processResultItemsIntoMessages(data);\n    await this.#sendBatch(messages, opcUaCallConfig);\n  }\n\n  async #processResultItemsIntoMessages(\n    data: Array<BystronicGetRunPartHistoryResponse>,\n  ): Promise<Array<object>> {\n    this.#sdk.logger.debug(`Processing sub-queries for results`);\n\n    return Promise.all(\n      data.map(async (item) => {\n        this.#sdk.logger.debug('Processing item', item);\n\n        const id = await this.#idExpression.evaluate(item);\n        this.#sdk.logger.debug({ id }, 'Extracted id');\n\n        const result = await this.#opcuaClient.callMethod<string>(\n          `History`,\n          'GetPartInfos',\n          [\n            new Variant({\n              dataType: DataType.Guid,\n              value: id,\n            }),\n          ],\n        );\n\n        if (!result || result.length === 0) {\n          this.#sdk.logger.debug(\n            'No output arguments found for sub-query, sending original item',\n          );\n          return item as object;\n        }\n\n        try {\n          const parsed: Array<BystronicPartInfoResponse> = JSON.parse(\n            result[0],\n          );\n\n          const matchingPart =\n            parsed.find((pi) => pi.PartId === item.PartId) ?? {};\n          const merged = { ...item, ...matchingPart };\n\n          this.#sdk.logger.debug({ merged }, 'Data to send');\n\n          return merged;\n        } catch (e) {\n          this.#sdk.logger.warn(\n            'Invalid JSON in OPC UA response; returning original item',\n            { err: e, jsonPreview: result[0].slice(0, 200) },\n          );\n          return item as object;\n        }\n      }),\n    );\n  }\n\n  async #sendBatch(list: Array<object>, config: CallConfig): Promise<void> {\n    this.#sdk.logger.debug(\n      `Sending ${JSON.stringify(list)} with config ${JSON.stringify(config)}`,\n    );\n\n    if (!(list && Array.isArray(list))) {\n      this.#sdk.logger.debug(\n        `No records found, skipping. ${JSON.stringify(list)}`,\n      );\n      return;\n    }\n\n    // @TODO: fix the metrics/document send below!\n\n    let { incrementalField } = config;\n    if (!incrementalField || incrementalField.length === 0) {\n      incrementalField = this.#INCREMENTAL_FIELD_JSONATA_EXPRESSION;\n    }\n\n    // check only for metric, to ensure backwards compatibility with old code.\n    // Default fallback to document since it is the previous default.\n    if (config.type === 'metric') {\n      await this.#sdk.sender.metricsLegacy(\n        list as Array<never>,\n        config.metadata ?? {},\n      );\n    } else {\n      await this.#sdk.sender.documents(list, config.metadata, {\n        extraPayload: {\n          keyField: config.keyField ?? '',\n          incrementalField,\n        },\n      });\n    }\n\n    const item = list[list.length - 1];\n\n    const expression = jsonata(incrementalField);\n    const value = await expression.evaluate(item);\n\n    this.#sdk.offsetStore.setOffset(\n      {\n        timestamp: (value ? new Date(value) : new Date()).getTime(),\n        id: 0,\n        rawTimestamp: value || '',\n      },\n      `${config.offsetFilePrefix ?? 'offset'}_${config.name}`,\n    );\n  }\n}\n"],
  "mappings": "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",
  "names": ["jsonata"]
}
