{
  "version": 3,
  "sources": ["../../../../../../../libs/connector-runner-bystronic/src/lib/extractor.service.ts"],
  "sourcesContent": ["import {\n  ConnectorSDKInterface,\n  IntervalHandler,\n  StoredOffset,\n} from '@transai/connector-runtime-sdk';\nimport { OpcuaInterface } from '@transai/opcua-client';\nimport { DataType, Variant } from 'node-opcua';\n\nimport { ResultHandler } from './result.handler';\nimport { CallConfig, ConnectorConfig } from './types';\n\nexport class ExtractorService implements IntervalHandler {\n  readonly #sdk: ConnectorSDKInterface<ConnectorConfig>;\n\n  readonly #opcUaCallConfig: CallConfig;\n\n  readonly #opcUaClient: OpcuaInterface;\n\n  readonly #opcUaResultHandler: ResultHandler;\n\n  constructor(\n    sdk: ConnectorSDKInterface<ConnectorConfig>,\n    opcUaCallConfig: CallConfig,\n    opcUaClient: OpcuaInterface,\n    apiResultHandler: ResultHandler,\n  ) {\n    this.#sdk = sdk;\n    this.#opcUaCallConfig = opcUaCallConfig;\n    this.#opcUaClient = opcUaClient;\n    this.#opcUaResultHandler = apiResultHandler;\n\n    this.#sdk.logger.info(\n      `OPC UA extractor service [${this.#opcUaCallConfig.name}] initialized with interval of ${this.#opcUaCallConfig.interval} seconds`,\n    );\n  }\n\n  async onStop(): Promise<void> {\n    await this.#opcUaClient.disconnect();\n  }\n\n  async onRun(): Promise<void> {\n    try {\n      const latestOffset = await this.#sdk.offsetStore.getOffset(\n        `${this.#opcUaCallConfig.offsetFilePrefix ?? 'offset'}_${this.#opcUaCallConfig.name}`,\n      );\n\n      await this.#opcUaClient.init();\n\n      this.#sdk.logger.debug(\n        `Executing query for: ${this.#opcUaCallConfig.name}`,\n      );\n      await this.#performOpcUaCalls(latestOffset);\n      this.#sdk.logger.debug(`Ran query for: ${this.#opcUaCallConfig.name}`);\n    } catch (error) {\n      this.#sdk.logger.error(\n        'Failed to retrieve and process data from OPC UA source service',\n        error,\n      );\n    } finally {\n      this.#sdk.logger.debug(\n        `Disconnecting from OPCUA for: ${this.#opcUaCallConfig.name}`,\n      );\n      await this.#opcUaClient.disconnect();\n    }\n  }\n\n  async #performOpcUaCalls(latestOffset: StoredOffset): Promise<void> {\n    const result = await this.#opcUaClient.callMethod<string | number>(\n      `History`,\n      'GetRunPartHistory',\n      [\n        new Variant({\n          dataType: DataType.DateTime,\n          value: new Date(latestOffset.timestamp),\n        }),\n        new Variant({\n          dataType: DataType.DateTime,\n          value: new Date(),\n        }),\n        new Variant({\n          dataType: DataType.Int32,\n          value: 0,\n        }),\n        new Variant({\n          dataType: DataType.Int32,\n          value: 100,\n        }),\n      ],\n    );\n\n    // Select field 1 and not 0, because 0 is the status code\n    await this.#opcUaResultHandler.handleResult(\n      result[1] as string,\n      this.#opcUaCallConfig,\n    );\n  }\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAMA,wBAAkC;AAK3B,MAAM,iBAA4C;AAAA,EAC9C;AAAA,EAEA;AAAA,EAEA;AAAA,EAEA;AAAA,EAET,YACE,KACA,iBACA,aACA,kBACA;AACA,SAAK,OAAO;AACZ,SAAK,mBAAmB;AACxB,SAAK,eAAe;AACpB,SAAK,sBAAsB;AAE3B,SAAK,KAAK,OAAO;AAAA,MACf,6BAA6B,KAAK,iBAAiB,IAAI,kCAAkC,KAAK,iBAAiB,QAAQ;AAAA,IACzH;AAAA,EACF;AAAA,EAEA,MAAM,SAAwB;AAC5B,UAAM,KAAK,aAAa,WAAW;AAAA,EACrC;AAAA,EAEA,MAAM,QAAuB;AAC3B,QAAI;AACF,YAAM,eAAe,MAAM,KAAK,KAAK,YAAY;AAAA,QAC/C,GAAG,KAAK,iBAAiB,oBAAoB,QAAQ,IAAI,KAAK,iBAAiB,IAAI;AAAA,MACrF;AAEA,YAAM,KAAK,aAAa,KAAK;AAE7B,WAAK,KAAK,OAAO;AAAA,QACf,wBAAwB,KAAK,iBAAiB,IAAI;AAAA,MACpD;AACA,YAAM,KAAK,mBAAmB,YAAY;AAC1C,WAAK,KAAK,OAAO,MAAM,kBAAkB,KAAK,iBAAiB,IAAI,EAAE;AAAA,IACvE,SAAS,OAAO;AACd,WAAK,KAAK,OAAO;AAAA,QACf;AAAA,QACA;AAAA,MACF;AAAA,IACF,UAAE;AACA,WAAK,KAAK,OAAO;AAAA,QACf,iCAAiC,KAAK,iBAAiB,IAAI;AAAA,MAC7D;AACA,YAAM,KAAK,aAAa,WAAW;AAAA,IACrC;AAAA,EACF;AAAA,EAEA,MAAM,mBAAmB,cAA2C;AAClE,UAAM,SAAS,MAAM,KAAK,aAAa;AAAA,MACrC;AAAA,MACA;AAAA,MACA;AAAA,QACE,IAAI,0BAAQ;AAAA,UACV,UAAU,2BAAS;AAAA,UACnB,OAAO,IAAI,KAAK,aAAa,SAAS;AAAA,QACxC,CAAC;AAAA,QACD,IAAI,0BAAQ;AAAA,UACV,UAAU,2BAAS;AAAA,UACnB,OAAO,oBAAI,KAAK;AAAA,QAClB,CAAC;AAAA,QACD,IAAI,0BAAQ;AAAA,UACV,UAAU,2BAAS;AAAA,UACnB,OAAO;AAAA,QACT,CAAC;AAAA,QACD,IAAI,0BAAQ;AAAA,UACV,UAAU,2BAAS;AAAA,UACnB,OAAO;AAAA,QACT,CAAC;AAAA,MACH;AAAA,IACF;AAGA,UAAM,KAAK,oBAAoB;AAAA,MAC7B,OAAO,CAAC;AAAA,MACR,KAAK;AAAA,IACP;AAAA,EACF;AACF;",
  "names": []
}
