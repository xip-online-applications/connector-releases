{
  "version": 3,
  "sources": ["../../../../../../../libs/connector-runtime-sdk/src/lib/connector-runtime.ts"],
  "sourcesContent": ["import * as process from 'node:process';\n\nimport {\n  KafkaCallbackResponse,\n  BaseConnectorConfig,\n  ActionInterface,\n  ConnectorInterface,\n  XodJobType,\n} from '@xip-online-data/types';\n\nimport { ConnectorRuntimeInterface } from './connector-runtime.interface';\nimport { CompileDelegate, ConnectorSDKInterface } from './sdk';\n\nexport interface IpcMessage {\n  cmd: string;\n  message: string;\n}\n\nexport abstract class ConnectorRuntimeSDK<\n  T extends BaseConnectorConfig = BaseConnectorConfig,\n> implements ConnectorRuntimeInterface\n{\n  readonly #IPC_CHANNEL = 'connector-runtime';\n\n  readonly #connectorSDK: ConnectorSDKInterface<T>;\n\n  constructor(\n    connector: ConnectorInterface,\n    connectorSDK: ConnectorSDKInterface,\n  ) {\n    this.#connectorSDK = connectorSDK as ConnectorSDKInterface<T>;\n\n    if (process.on) {\n      process.on('message', (message: IpcMessage) => {\n        if (message.cmd === this.#IPC_CHANNEL) {\n          connectorSDK.logger.verbose(\n            `${process.pid} Received message from parent process:`,\n            message,\n          );\n        }\n      });\n    } else {\n      connectorSDK.logger.warn(\n        'IPC channel is not available. process.on is undefined.',\n      );\n    }\n\n    if (!process.send) {\n      // Check if process.send is available\n      connectorSDK.logger.warn(\n        'IPC channel is not available. process.send is undefined.',\n      );\n    }\n\n    // eslint-disable-next-line no-restricted-syntax\n    connector.actions?.forEach((action: ActionInterface) => {\n      if (action.config['templates'] === undefined) {\n        return;\n      }\n\n      const containers: {\n        [key: string]: CompileDelegate;\n      } = {};\n\n      Object.entries(action.config['templates']).forEach(([key, value]) => {\n        try {\n          // eslint-disable-next-line security/detect-object-injection\n          containers[key] = connectorSDK.templating.compile(value);\n        } catch (error: unknown) {\n          connectorSDK.logger.error(\n            `Error compiling template ${key} for action ${action.identifier}`,\n            error,\n          );\n        }\n      });\n\n      // eslint-disable-next-line no-param-reassign\n      action.config['parsedTemplates'] = containers;\n    });\n  }\n\n  public init: () => Promise<void> = () => Promise.resolve();\n\n  public start: () => Promise<void> = () => Promise.resolve();\n\n  public stop: () => Promise<void> = () => Promise.resolve();\n\n  set callbackFunction(\n    callback: (\n      message: XodJobType,\n      action: ActionInterface,\n    ) => Promise<KafkaCallbackResponse>,\n  ) {\n    this.connectorSDK.receiver.registerCallback(\n      this.#enrichWithActionConfig(callback),\n    );\n  }\n\n  protected get connectorSDK(): ConnectorSDKInterface<T> {\n    return this.#connectorSDK;\n  }\n\n  #enrichWithActionConfig(\n    callbackFunction: (\n      message: XodJobType,\n      action: ActionInterface,\n    ) => Promise<KafkaCallbackResponse>,\n  ): (message: XodJobType) => Promise<KafkaCallbackResponse> {\n    return async (message: XodJobType) => {\n      const action = this.#connectorSDK.receiver.getActionConfig(message);\n      if (!action) {\n        return this.#connectorSDK.receiver.responses.badRequest(\n          'Action not found',\n        )(message);\n      }\n      return callbackFunction(message, action);\n    };\n  }\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,cAAyB;AAkBlB,MAAe,oBAGtB;AAAA,EAKE,YACE,WACA,cACA;AAPF,SAAS,eAAe;AA2DxB,SAAO,OAA4B,MAAM,QAAQ,QAAQ;AAEzD,SAAO,QAA6B,MAAM,QAAQ,QAAQ;AAE1D,SAAO,OAA4B,MAAM,QAAQ,QAAQ;AAvDvD,SAAK,gBAAgB;AAErB,QAAI,QAAQ,IAAI;AACd,cAAQ,GAAG,WAAW,CAAC,YAAwB;AAC7C,YAAI,QAAQ,QAAQ,KAAK,cAAc;AACrC,uBAAa,OAAO;AAAA,YAClB,GAAG,QAAQ,GAAG;AAAA,YACd;AAAA,UACF;AAAA,QACF;AAAA,MACF,CAAC;AAAA,IACH,OAAO;AACL,mBAAa,OAAO;AAAA,QAClB;AAAA,MACF;AAAA,IACF;AAEA,QAAI,CAAC,QAAQ,MAAM;AAEjB,mBAAa,OAAO;AAAA,QAClB;AAAA,MACF;AAAA,IACF;AAGA,cAAU,SAAS,QAAQ,CAAC,WAA4B;AACtD,UAAI,OAAO,OAAO,WAAW,MAAM,QAAW;AAC5C;AAAA,MACF;AAEA,YAAM,aAEF,CAAC;AAEL,aAAO,QAAQ,OAAO,OAAO,WAAW,CAAC,EAAE,QAAQ,CAAC,CAAC,KAAK,KAAK,MAAM;AACnE,YAAI;AAEF,qBAAW,GAAG,IAAI,aAAa,WAAW,QAAQ,KAAK;AAAA,QACzD,SAAS,OAAgB;AACvB,uBAAa,OAAO;AAAA,YAClB,4BAA4B,GAAG,eAAe,OAAO,UAAU;AAAA,YAC/D;AAAA,UACF;AAAA,QACF;AAAA,MACF,CAAC;AAGD,aAAO,OAAO,iBAAiB,IAAI;AAAA,IACrC,CAAC;AAAA,EACH;AAAA,EAzDS;AAAA,EAEA;AAAA,EA+DT,IAAI,iBACF,UAIA;AACA,SAAK,aAAa,SAAS;AAAA,MACzB,KAAK,wBAAwB,QAAQ;AAAA,IACvC;AAAA,EACF;AAAA,EAEA,IAAc,eAAyC;AACrD,WAAO,KAAK;AAAA,EACd;AAAA,EAEA,wBACE,kBAIyD;AACzD,WAAO,OAAO,YAAwB;AACpC,YAAM,SAAS,KAAK,cAAc,SAAS,gBAAgB,OAAO;AAClE,UAAI,CAAC,QAAQ;AACX,eAAO,KAAK,cAAc,SAAS,UAAU;AAAA,UAC3C;AAAA,QACF,EAAE,OAAO;AAAA,MACX;AACA,aAAO,iBAAiB,SAAS,MAAM;AAAA,IACzC;AAAA,EACF;AACF;",
  "names": []
}
