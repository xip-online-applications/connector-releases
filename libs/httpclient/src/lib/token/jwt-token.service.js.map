{
  "version": 3,
  "sources": ["../../../../../../../../libs/httpclient/src/lib/token/jwt-token.service.ts"],
  "sourcesContent": ["import { Logger } from '@transai/logger';\nimport axios, { AxiosRequestConfig } from 'axios';\n\nimport { CacheServiceInterface } from '../cache';\n\nimport { JwtTokenOptionsInterface } from './jwt-token-options.interface';\nimport { TokenRequestOptions } from './request-options.interface';\nimport { CachedTokenInterface, TokenInterface } from './token.interface';\n\nexport class JwtTokenService {\n  #options: JwtTokenOptionsInterface;\n\n  #cacheService: CacheServiceInterface;\n\n  #cachedTokens?: { [key: string]: CachedTokenInterface } = undefined;\n\n  readonly #log: Logger;\n\n  constructor(\n    options: JwtTokenOptionsInterface,\n    cacheService: CacheServiceInterface,\n  ) {\n    this.#options = options;\n    this.#cacheService = cacheService;\n    this.#log = Logger.getInstance();\n  }\n\n  public async getToken(options: TokenRequestOptions): Promise<string> {\n    if (this.#cachedTokens === undefined) {\n      this.#cachedTokens = await this.#cacheService.get('cachedTokens');\n    }\n\n    if (\n      this.#cachedTokens === undefined ||\n      typeof this.#cachedTokens !== 'object'\n    ) {\n      this.#cachedTokens = {};\n    }\n\n    const cacheKey = this.getCacheArrayKey(options);\n    if (\n      this.#cachedTokens[cacheKey] &&\n      this.#cachedTokens[cacheKey].expires_at > Date.now()\n    ) {\n      this.#log.debug(\n        `Using cached token for audience ${options.audience} and tenantIdentifier ${options.tenantIdentifier}`,\n      );\n      return this.#cachedTokens[cacheKey].token.access_token;\n    }\n\n    this.#log.debug(\n      `Fetching new token for audience ${options.audience} and tenantIdentifier ${options.tenantIdentifier}`,\n    );\n\n    const audience = options.audience || this.#options.audience;\n    const tenantId = options.tenantIdentifier || this.#options.tenantIdentifier;\n\n    const requestConfig: AxiosRequestConfig = {\n      method: 'POST',\n      url: this.#options.tokenUrl,\n      headers: { 'content-type': 'application/json' },\n      data: JSON.stringify({\n        client_id: this.#options.clientId,\n        client_secret: this.#options.clientSecret,\n        audience: options.audience || this.#options.audience,\n        grant_type: 'client_credentials',\n        ...(tenantId ? { tenantId } : {}),\n      }),\n    };\n\n    const { data } = await axios\n      .request<TokenInterface>(requestConfig)\n      .catch((error) => {\n        throw new Error('Error fetching token');\n      });\n\n    this.#cachedTokens[cacheKey] = {\n      tenantId,\n      audience,\n      token: data,\n      expires_at: new Date(\n        new Date().getTime() + data.expires_in * 1000,\n      ).getTime(),\n    };\n\n    await this.#cacheService.set('cachedTokens', this.#cachedTokens);\n\n    return data.access_token;\n  }\n\n  private getCacheArrayKey(options: TokenRequestOptions): string {\n    const tenantId = options.tenantIdentifier || '__NONE__';\n    const audience = options.audience || this.#options.audience;\n\n    return `${tenantId}_${audience}`;\n  }\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,oBAAuB;AACvB,mBAA0C;AAQnC,MAAM,gBAAgB;AAAA,EAC3B;AAAA,EAEA;AAAA,EAEA,gBAA0D;AAAA,EAEjD;AAAA,EAET,YACE,SACA,cACA;AACA,SAAK,WAAW;AAChB,SAAK,gBAAgB;AACrB,SAAK,OAAO,qBAAO,YAAY;AAAA,EACjC;AAAA,EAEA,MAAa,SAAS,SAA+C;AACnE,QAAI,KAAK,kBAAkB,QAAW;AACpC,WAAK,gBAAgB,MAAM,KAAK,cAAc,IAAI,cAAc;AAAA,IAClE;AAEA,QACE,KAAK,kBAAkB,UACvB,OAAO,KAAK,kBAAkB,UAC9B;AACA,WAAK,gBAAgB,CAAC;AAAA,IACxB;AAEA,UAAM,WAAW,KAAK,iBAAiB,OAAO;AAC9C,QACE,KAAK,cAAc,QAAQ,KAC3B,KAAK,cAAc,QAAQ,EAAE,aAAa,KAAK,IAAI,GACnD;AACA,WAAK,KAAK;AAAA,QACR,mCAAmC,QAAQ,QAAQ,yBAAyB,QAAQ,gBAAgB;AAAA,MACtG;AACA,aAAO,KAAK,cAAc,QAAQ,EAAE,MAAM;AAAA,IAC5C;AAEA,SAAK,KAAK;AAAA,MACR,mCAAmC,QAAQ,QAAQ,yBAAyB,QAAQ,gBAAgB;AAAA,IACtG;AAEA,UAAM,WAAW,QAAQ,YAAY,KAAK,SAAS;AACnD,UAAM,WAAW,QAAQ,oBAAoB,KAAK,SAAS;AAE3D,UAAM,gBAAoC;AAAA,MACxC,QAAQ;AAAA,MACR,KAAK,KAAK,SAAS;AAAA,MACnB,SAAS,EAAE,gBAAgB,mBAAmB;AAAA,MAC9C,MAAM,KAAK,UAAU;AAAA,QACnB,WAAW,KAAK,SAAS;AAAA,QACzB,eAAe,KAAK,SAAS;AAAA,QAC7B,UAAU,QAAQ,YAAY,KAAK,SAAS;AAAA,QAC5C,YAAY;AAAA,QACZ,GAAI,WAAW,EAAE,SAAS,IAAI,CAAC;AAAA,MACjC,CAAC;AAAA,IACH;AAEA,UAAM,EAAE,KAAK,IAAI,MAAM,aAAAA,QACpB,QAAwB,aAAa,EACrC,MAAM,CAAC,UAAU;AAChB,YAAM,IAAI,MAAM,sBAAsB;AAAA,IACxC,CAAC;AAEH,SAAK,cAAc,QAAQ,IAAI;AAAA,MAC7B;AAAA,MACA;AAAA,MACA,OAAO;AAAA,MACP,YAAY,IAAI;AAAA,SACd,oBAAI,KAAK,GAAE,QAAQ,IAAI,KAAK,aAAa;AAAA,MAC3C,EAAE,QAAQ;AAAA,IACZ;AAEA,UAAM,KAAK,cAAc,IAAI,gBAAgB,KAAK,aAAa;AAE/D,WAAO,KAAK;AAAA,EACd;AAAA,EAEQ,iBAAiB,SAAsC;AAC7D,UAAM,WAAW,QAAQ,oBAAoB;AAC7C,UAAM,WAAW,QAAQ,YAAY,KAAK,SAAS;AAEnD,WAAO,GAAG,QAAQ,IAAI,QAAQ;AAAA,EAChC;AACF;",
  "names": ["axios"]
}
