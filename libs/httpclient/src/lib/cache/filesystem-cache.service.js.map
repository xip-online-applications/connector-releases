{
  "version": 3,
  "sources": ["../../../../../../../../libs/httpclient/src/lib/cache/filesystem-cache.service.ts"],
  "sourcesContent": ["import { promises as fs } from 'fs';\nimport { Logger } from '@transai/logger';\nimport { CacheServiceInterface } from './cache-service.interface';\n\nexport interface Options {\n  path: string;\n  keyPrefix?: string;\n}\n\nexport class FileSystemCacheService implements CacheServiceInterface {\n  #options: Options;\n\n  readonly #logger: Logger;\n\n  #initRun = false;\n\n  constructor(options: Options) {\n    this.#options = options;\n    this.#logger = Logger.getInstance();\n    this.#logger.info('Loaded filesystem-cache');\n  }\n\n  public async get<T>(key: string): Promise<T | undefined> {\n    await this.#init();\n    const value = await fs\n      .readFile(`${this.#options.path}/${this.#getKey(key)}`, 'utf8')\n      .catch((e) => {\n        this.#logger.error(e);\n        return undefined;\n      });\n\n    return value ? JSON.parse(value) : undefined;\n  }\n\n  public async set<T>(key: string, value: T): Promise<void> {\n    await this.#init();\n    await fs\n      .writeFile(\n        `${this.#options.path}/${this.#getKey(key)}`,\n        JSON.stringify(value),\n      )\n      .catch((e) => {\n        this.#logger.error(e);\n        return undefined;\n      });\n  }\n\n  public async clear(): Promise<void> {\n    // not implemented\n    return Promise.resolve();\n  }\n\n  async #init(): Promise<void> {\n    this.#logger.debug('try to init FileSystemCacheService');\n    if (this.#initRun) {\n      return;\n    }\n\n    let locExist = true;\n    await fs.stat(this.#options.path).catch((error) => {\n      if (error.code === 'ENOENT') {\n        locExist = false;\n        this.#logger.debug('Directory does not exist');\n      } else {\n        this.#logger.debug('Error occured');\n        throw error;\n      }\n    });\n\n    if (!locExist) {\n      Logger.getInstance().debug(`OffsetStore create ${this.#options.path}`);\n      await fs.mkdir(this.#options.path);\n    }\n\n    this.#logger.debug('Init run successfully. directory exists');\n\n    this.#initRun = true;\n  }\n\n  #getKey(key: string): string {\n    return `${this.#options.keyPrefix ? `${this.#options.keyPrefix}_` : ''}${key}.json`;\n  }\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,gBAA+B;AAC/B,oBAAuB;AAQhB,MAAM,uBAAwD;AAAA,EACnE;AAAA,EAES;AAAA,EAET,WAAW;AAAA,EAEX,YAAY,SAAkB;AAC5B,SAAK,WAAW;AAChB,SAAK,UAAU,qBAAO,YAAY;AAClC,SAAK,QAAQ,KAAK,yBAAyB;AAAA,EAC7C;AAAA,EAEA,MAAa,IAAO,KAAqC;AACvD,UAAM,KAAK,MAAM;AACjB,UAAM,QAAQ,MAAM,UAAAA,SACjB,SAAS,GAAG,KAAK,SAAS,IAAI,IAAI,KAAK,QAAQ,GAAG,CAAC,IAAI,MAAM,EAC7D,MAAM,CAAC,MAAM;AACZ,WAAK,QAAQ,MAAM,CAAC;AACpB,aAAO;AAAA,IACT,CAAC;AAEH,WAAO,QAAQ,KAAK,MAAM,KAAK,IAAI;AAAA,EACrC;AAAA,EAEA,MAAa,IAAO,KAAa,OAAyB;AACxD,UAAM,KAAK,MAAM;AACjB,UAAM,UAAAA,SACH;AAAA,MACC,GAAG,KAAK,SAAS,IAAI,IAAI,KAAK,QAAQ,GAAG,CAAC;AAAA,MAC1C,KAAK,UAAU,KAAK;AAAA,IACtB,EACC,MAAM,CAAC,MAAM;AACZ,WAAK,QAAQ,MAAM,CAAC;AACpB,aAAO;AAAA,IACT,CAAC;AAAA,EACL;AAAA,EAEA,MAAa,QAAuB;AAElC,WAAO,QAAQ,QAAQ;AAAA,EACzB;AAAA,EAEA,MAAM,QAAuB;AAC3B,SAAK,QAAQ,MAAM,oCAAoC;AACvD,QAAI,KAAK,UAAU;AACjB;AAAA,IACF;AAEA,QAAI,WAAW;AACf,UAAM,UAAAA,SAAG,KAAK,KAAK,SAAS,IAAI,EAAE,MAAM,CAAC,UAAU;AACjD,UAAI,MAAM,SAAS,UAAU;AAC3B,mBAAW;AACX,aAAK,QAAQ,MAAM,0BAA0B;AAAA,MAC/C,OAAO;AACL,aAAK,QAAQ,MAAM,eAAe;AAClC,cAAM;AAAA,MACR;AAAA,IACF,CAAC;AAED,QAAI,CAAC,UAAU;AACb,2BAAO,YAAY,EAAE,MAAM,sBAAsB,KAAK,SAAS,IAAI,EAAE;AACrE,YAAM,UAAAA,SAAG,MAAM,KAAK,SAAS,IAAI;AAAA,IACnC;AAEA,SAAK,QAAQ,MAAM,yCAAyC;AAE5D,SAAK,WAAW;AAAA,EAClB;AAAA,EAEA,QAAQ,KAAqB;AAC3B,WAAO,GAAG,KAAK,SAAS,YAAY,GAAG,KAAK,SAAS,SAAS,MAAM,EAAE,GAAG,GAAG;AAAA,EAC9E;AACF;",
  "names": ["fs"]
}
