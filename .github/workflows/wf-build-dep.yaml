name: Build installable deb package

on:
  workflow_call:
  workflow_dispatch:

jobs:
  build:
    name: Build installable deb
    strategy:
      matrix:
        architectures:
          - { name: amd64, runs-on: ubuntu-24.04 }
          - { name: arm64, runs-on: ubuntu-24.04-arm }
    runs-on: ${{ matrix.architectures.runs-on }}
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'npm'

      - name: Install Dependencies
        run: npm install --no-save --omit=dev

      - name: Compile deb package
        run: make build-dep

      - name: Upload connector orchestrator artifact
        uses: actions/upload-artifact@v5
        with:
          name: transai-connector-orchestrator-${{ matrix.architectures.name }}.deb
          path: dist/transai-connector-orchestrator-${{ matrix.architectures.name }}.deb
          retention-days: 1
          overwrite: true

  push:
    name: Push installable deb changes
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Cleanup dist dir
        run: rm dist/*

      - name: Download artifacts
        uses: actions/download-artifact@v6
        with:
          path: dist/
          pattern: transai-connector-orchestrator-*.deb
          merge-multiple: true

      - name: Generate a token
        id: generate-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.XOD_CORE_APP_ID }}
          private-key: ${{ secrets.XOD_CORE_APP_PRIVATE_KEY }}
          permission-contents: write

      - name: Commit updated package
        env:
          GITHUB_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"
          git add --all
          git status
          git commit -m "chore: compiled new installable deb [skip ci]" || echo "No changes to commit"
          git push
